<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Style Match - HAIRGATOR</title>

    <!-- ìºì‹œ ë°©ì§€ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">

    <!-- â­ ë¡œë”© ìŠ¤í”¼ë„ˆ ê°•ì œ ìˆ¨ê¹€ (bfcache ë¬¸ì œ í•´ê²°) -->
    <style id="emergency-hide-spinner">
        #loadingOverlay,
        .loading-overlay,
        .loading-spinner {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }
    </style>
    <script>
        (function() {
            var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                       (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            var hideIntervalId = null;

            function forceHideLoading() {
                var overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; z-index: -9999 !important;';
                    overlay.classList.add('force-hide');
                    overlay.setAttribute('data-force-hide', 'true');
                    overlay.setAttribute('hidden', '');
                }
            }

            function startIOSHideInterval() {
                if (hideIntervalId) clearInterval(hideIntervalId);
                var count = 0;
                hideIntervalId = setInterval(function() {
                    forceHideLoading();
                    if (++count >= 40) clearInterval(hideIntervalId);
                }, 50);
            }

            document.addEventListener('DOMContentLoaded', function() {
                forceHideLoading();
                if (isIOS) startIOSHideInterval();
            });
            window.addEventListener('pageshow', function(e) {
                // â­ bfcacheì—ì„œ ë³µì›ëœ ê²½ìš° â†’ ë©”ì¸ í˜ì´ì§€(ì„±ë³„ ì„ íƒ)ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                if (e.persisted) {
                    console.log('ğŸ”„ bfcache ë³µì› ê°ì§€ â†’ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™');
                    var mainUrl = window.location.origin + '/';
                    var params = new URLSearchParams(window.location.search);
                    var newParams = new URLSearchParams();
                    if (params.has('firebaseToken')) {
                        newParams.set('firebaseToken', params.get('firebaseToken'));
                    }
                    if (params.has('isFlutterApp')) {
                        newParams.set('isFlutterApp', 'true');
                    }
                    window.location.replace(mainUrl + (newParams.toString() ? '?' + newParams.toString() : ''));
                    return;
                }
                forceHideLoading();
                if (isIOS) startIOSHideInterval();
            });
            window.addEventListener('pagehide', function() {
                // ë©”ì¸ í˜ì´ì§€ê°€ ì´ í”Œë˜ê·¸ë¥¼ ë³´ê³  ë¡œë”© í‘œì‹œ ì°¨ë‹¨
                sessionStorage.setItem('hairgator_navigated', 'true');
                forceHideLoading();
            });
            window.addEventListener('popstate', function() {
                forceHideLoading();
                if (isIOS) startIOSHideInterval();
            });
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible') {
                    forceHideLoading();
                    if (isIOS) startIOSHideInterval();
                }
            });
            window.forceHideLoading = forceHideLoading;
        })();
    </script>

    <!-- Fonts - Clinical Beauty Style -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Playfair+Display:wght@400;500;600&family=Noto+Sans+KR:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- MediaPipe Face Mesh -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="styles.css?v=20251227-modal-fix">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <button class="back-btn" onclick="goBack()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>
            <div class="header-title">
                <span class="title-accent">AI</span> STYLE MATCH
            </div>
            <div class="header-badge">BETA</div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Step 1: Upload & Gender Selection -->
            <section class="upload-section" id="uploadSection">
                <div class="section-header">
                    <span class="step-indicator">01</span>
                    <h2 class="section-title" data-i18n="styleMatch.uploadTitle">ì–¼êµ´ ì‚¬ì§„ ë¶„ì„</h2>
                </div>

                <!-- Step 1-1: Gender Selection (ë¨¼ì €!) -->
                <div class="gender-selection-first">
                    <p class="step-label">STEP 1</p>
                    <p class="gender-label" data-i18n="styleMatch.selectGender">ì„±ë³„ ì„ íƒ</p>
                    <div class="gender-buttons">
                        <button class="gender-btn" data-gender="female" onclick="selectGender('female')">
                            <span class="gender-icon">â™€</span>
                            <span data-i18n="styleMatch.female">ì—¬ì„±</span>
                        </button>
                        <button class="gender-btn" data-gender="male" onclick="selectGender('male')">
                            <span class="gender-icon">â™‚</span>
                            <span data-i18n="styleMatch.male">ë‚¨ì„±</span>
                        </button>
                    </div>
                </div>

                <!-- Step 1-2: ì…ë ¥ ëª¨ë“œ ì„ íƒ íƒ­ -->
                <div class="photo-input-section" id="photoInputSection">
                    <p class="step-label">STEP 2</p>
                    <div class="input-mode-tabs">
                        <button class="mode-tab active" data-mode="camera" onclick="switchInputMode('camera')">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
                                <circle cx="12" cy="13" r="4"/>
                            </svg>
                            <span data-i18n="styleMatch.cameraMode">ì‹¤ì‹œê°„ ì¹´ë©”ë¼</span>
                        </button>
                        <button class="mode-tab" data-mode="upload" onclick="switchInputMode('upload')">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <span data-i18n="styleMatch.uploadMode">ì‚¬ì§„ ì—…ë¡œë“œ</span>
                        </button>
                    </div>

                    <!-- ì¹´ë©”ë¼ ëª¨ë“œ -->
                    <div class="camera-area" id="cameraArea">
                        <video id="cameraVideo" autoplay playsinline muted></video>
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                        <canvas id="landmarkCanvas" class="landmark-canvas"></canvas>
                        <div class="camera-overlay" id="cameraOverlay">
                            <p class="camera-hint" data-i18n="styleMatch.cameraHint">ì •ë©´ì„ ë°”ë¼ë´ ì£¼ì„¸ìš”</p>
                        </div>
                        <div class="face-detected-indicator" id="faceDetectedIndicator" style="display: none;">
                            <span class="indicator-dot"></span>
                            <span data-i18n="styleMatch.faceDetected">ì–¼êµ´ ê°ì§€ë¨</span>
                        </div>
                        <!-- ì„±ë³„ ë¯¸ì„ íƒ ì˜¤ë²„ë ˆì´ -->
                        <div class="gender-required-overlay" id="genderRequiredOverlay">
                            <p>ğŸ‘† ë¨¼ì € ì„±ë³„ì„ ì„ íƒí•˜ì„¸ìš”</p>
                        </div>
                    </div>

                    <!-- ì´¬ì˜ ë²„íŠ¼ (ì¹´ë©”ë¼ ë°–) -->
                    <div class="capture-btn-container" id="captureBtnContainer">
                        <button class="capture-btn-outside" id="captureBtn" onclick="captureFromCamera()" disabled>
                            <span class="capture-icon-large"></span>
                            <span>ì´¬ì˜í•˜ê¸°</span>
                        </button>
                    </div>

                    <!-- ì—…ë¡œë“œ ëª¨ë“œ -->
                    <div class="upload-area" id="uploadArea" style="display: none;">
                        <div class="upload-placeholder" id="uploadPlaceholder">
                            <div class="upload-icon">
                                <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                                    <circle cx="24" cy="18" r="8" stroke="currentColor" stroke-width="2"/>
                                    <path d="M8 42c0-8.837 7.163-16 16-16s16 7.163 16 16" stroke="currentColor" stroke-width="2"/>
                                </svg>
                            </div>
                            <p class="upload-text" data-i18n="styleMatch.uploadText">ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                            <p class="upload-hint" data-i18n="styleMatch.uploadHint">ì •ë©´ ì‚¬ì§„ì´ ê°€ì¥ ì •í™•í•©ë‹ˆë‹¤</p>
                        </div>
                        <img id="previewImage" class="preview-image" style="display: none;">
                        <canvas id="faceCanvas" class="face-canvas" style="display: none;"></canvas>
                        <input type="file" id="fileInput" accept="image/*" style="display: none;">
                        <!-- ì„±ë³„ ë¯¸ì„ íƒ ì˜¤ë²„ë ˆì´ -->
                        <div class="gender-required-overlay upload-overlay" id="genderRequiredOverlayUpload">
                            <p>ğŸ‘† ë¨¼ì € ì„±ë³„ì„ ì„ íƒí•˜ì„¸ìš”</p>
                        </div>
                    </div>
                </div>

                <button class="analyze-btn" id="analyzeBtn" onclick="startAnalysis()" disabled>
                    <span class="btn-text" data-i18n="styleMatch.startAnalysis">ë¶„ì„ ì‹œì‘</span>
                    <span class="btn-loader"></span>
                </button>
            </section>

            <!-- Step 2: Analysis Result -->
            <section class="analysis-section" id="analysisSection" style="display: none;">
                <div class="section-header">
                    <span class="step-indicator">02</span>
                    <h2 class="section-title" data-i18n="styleMatch.analysisTitle">ì–¼êµ´ ë¶„ì„ ê²°ê³¼</h2>
                </div>

                <!-- Face Metrics -->
                <div class="metrics-card">
                    <div class="metrics-header">
                        <h3 data-i18n="styleMatch.faceMetrics">ì–¼êµ´ ë¹„ìœ¨ ë¶„ì„</h3>
                        <span class="metrics-badge" id="faceTypeBadge">ê³„ë€í˜•</span>
                    </div>

                    <div class="metrics-grid">
                        <div class="metric-item">
                            <div class="metric-label" data-i18n="styleMatch.upperFace">ìƒì•ˆë¶€</div>
                            <div class="metric-value" id="upperRatio">--</div>
                            <div class="metric-bar">
                                <div class="metric-fill" id="upperBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label" data-i18n="styleMatch.middleFace">ì¤‘ì•ˆë¶€</div>
                            <div class="metric-value" id="middleRatio">--</div>
                            <div class="metric-bar">
                                <div class="metric-fill" id="middleBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label" data-i18n="styleMatch.lowerFace">í•˜ì•ˆë¶€</div>
                            <div class="metric-value" id="lowerRatio">--</div>
                            <div class="metric-bar">
                                <div class="metric-fill" id="lowerBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="metrics-detail">
                        <div class="detail-row">
                            <span class="detail-label" data-i18n="styleMatch.faceWidth">ì–¼êµ´ ë„ˆë¹„</span>
                            <span class="detail-value" id="faceWidthValue">--</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label" data-i18n="styleMatch.jawWidth">í„± ë„ˆë¹„</span>
                            <span class="detail-value" id="jawWidthValue">--</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label" data-i18n="styleMatch.cheekJawRatio">ê´‘ëŒ€/í„± ë¹„ìœ¨</span>
                            <span class="detail-value" id="cheekJawRatio">--</span>
                        </div>
                    </div>
                </div>

                <!-- Image Type (ì´ë¯¸ì§€ íƒ€ì…: ì›œê³„/ë‰´íŠ¸ëŸ´/ì¿¨ê³„) -->
                <div class="image-type-card">
                    <div class="image-type-header">
                        <h4 data-i18n="styleMatch.imageType">ì´ë¯¸ì§€ íƒ€ì…</h4>
                        <span class="image-type-badge neutral" id="imageTypeBadge">âš–ï¸ ë‰´íŠ¸ëŸ´ê³„ Â· ë°¸ëŸ°ìŠ¤</span>
                    </div>
                    <div class="image-type-detail">
                        <div class="detail-row">
                            <span class="detail-label" data-i18n="styleMatch.eyeDistance">ëˆˆ ì‚¬ì´ ê±°ë¦¬ ë¹„ìœ¨</span>
                            <span class="detail-value" id="eyeDistanceRatio">--</span>
                        </div>
                    </div>
                </div>

                <!-- Eyebrow Type (ëˆˆì¹ íƒ€ì…: ì•„ì¹˜í˜•/ë‚´ì¶”ëŸ´/ì§ì„ í˜•) -->
                <div class="eyebrow-type-card" id="eyebrowTypeCard" style="display: none;">
                    <div class="eyebrow-type-header">
                        <h4 data-i18n="styleMatch.eyebrowType">ëˆˆì¹ ë¶„ì„</h4>
                        <span class="eyebrow-type-badge neutral" id="eyebrowTypeBadge">â€• ë‰´íŠ¸ëŸ´</span>
                    </div>
                    <div class="eyebrow-type-detail">
                        <div class="detail-row">
                            <span class="detail-label" data-i18n="styleMatch.eyebrowArch">ì•„ì¹˜ ë¹„ìœ¨</span>
                            <span class="detail-value" id="eyebrowArchRatio">--</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label" data-i18n="styleMatch.eyebrowTail">í…Œì¼ ê°ë„</span>
                            <span class="detail-value" id="eyebrowTailAngle">--</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label" data-i18n="styleMatch.eyebrowDensity">ëˆˆì¹ ë°€ë„</span>
                            <span class="detail-value" id="eyebrowDensity">--</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label" data-i18n="styleMatch.eyebrowThickness">ë‘ê»˜ ë¹„ìœ¨</span>
                            <span class="detail-value" id="eyebrowThickness">--</span>
                        </div>
                    </div>
                </div>

                <!-- Analysis Summary -->
                <div class="summary-card">
                    <div class="summary-icon">ğŸ’¡</div>
                    <h4 data-i18n="styleMatch.analysisSummary">ë¶„ì„ ìš”ì•½</h4>
                    <p class="summary-text" id="summaryText">
                        ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </p>
                </div>
            </section>

            <!-- Step 3: Recommendations -->
            <section class="recommendations-section" id="recommendationsSection" style="display: none;">
                <div class="section-header">
                    <span class="step-indicator">03</span>
                    <h2 class="section-title" data-i18n="styleMatch.recommendations">ë§ì¶¤ ìŠ¤íƒ€ì¼ ì¶”ì²œ</h2>
                </div>

                <div class="recommendations-container" id="recommendationsContainer">
                    <!-- ëŒ€ë¶„ë¥˜ë³„ ì¶”ì²œ ì¹´ë“œê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                </div>
            </section>
        </main>

        <!-- Style Detail Modal -->
        <div class="style-detail-modal" id="styleDetailModal" style="display: none;">
            <div class="style-modal-backdrop" onclick="closeStyleModal()"></div>
            <div class="style-modal-content">
                <button class="style-modal-close" onclick="closeStyleModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
                <div class="style-modal-image-wrapper">
                    <img id="styleModalImage" src="" alt="Style">
                </div>
                <div class="style-modal-info">
                    <h3 id="styleModalTitle">ìŠ¤íƒ€ì¼ ì´ë¦„</h3>
                    <p id="styleModalCategory" class="style-modal-category">ì¹´í…Œê³ ë¦¬</p>
                    <p id="styleModalReason" class="style-modal-reason">ì¶”ì²œ ì´ìœ </p>
                </div>
                <div class="style-modal-actions">
                    <button class="style-action-btn lookbook" onclick="goToLookbook()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <path d="M21 15l-5-5L5 21"/>
                        </svg>
                        <span data-i18n="styleMatch.viewLookbook">ë£©ë¶ ë³´ê¸°</span>
                    </button>
                    <button class="style-action-btn hairtry" onclick="goToHairTry()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="8" r="5"/>
                            <path d="M20 21a8 8 0 10-16 0"/>
                        </svg>
                        <span data-i18n="styleMatch.tryOn">ì²´í—˜í•˜ê¸°</span>
                    </button>
                    <button class="style-action-btn recipe" onclick="goToRecipe()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                            <path d="M14 2v6h6"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        <span data-i18n="styleMatch.viewRecipe">ë ˆì‹œí”¼</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay" style="display: none;">
            <div class="loading-logo">HAIRGATOR</div>
            <div class="loading-spinner"></div>
            <p class="loading-text" data-i18n="styleMatch.analyzing">ì–¼êµ´ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        </div>
    </div>

    <!-- Firebase SDK (ì ‘ê·¼ ì œí•œ ì²´í¬ìš© + Storage) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script>
        // Firebase ì´ˆê¸°í™” (auth + firestore + storage)
        const firebaseConfig = {
            apiKey: "AIzaSyD5N_MBKpKj_K3-aYpOBG2H5RK71BbKUiQ",
            authDomain: "hairgatormenu-4a43e.firebaseapp.com",
            projectId: "hairgatormenu-4a43e",
            storageBucket: "hairgatormenu-4a43e.firebasestorage.app"
        };
        firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const db = firebase.firestore();
        window.db = db;
    </script>

    <!-- i18n -->
    <script src="../js/i18n.js"></script>
    <!-- Style Feedback Logger -->
    <script src="../js/style-feedback-logger.js"></script>
    <script src="app.js?v=20260126-feedback"></script>
</body>
</html>
