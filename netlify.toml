# netlify.toml - HAIRGATOR ìµœì¢… ì„¤ì • (í—¤ì–´ì²´í—˜ + ì±—ë´‡ + MediaPipe í†µí•©)
# ğŸ”¥ HOTFIX: Functions íƒ€ì„ì•„ì›ƒ 26ì´ˆë¡œ ì—°ì¥ (GPT ë ˆì‹œí”¼ ìƒì„± ì‹œê°„ ê³ ë ¤)

[build]
  publish = "."
  functions = "netlify/functions"

[build.environment]
  # ì‹œí¬ë¦¿ ìŠ¤ìº” ë¹„í™œì„±í™” (Firebase/API í‚¤ë“¤ì´ ì˜ë„ì ìœ¼ë¡œ í¬í•¨ë¨)
  SECRETS_SCAN_SMART_DETECTION_ENABLED = "false"

# ========== Functions ì„¤ì • ==========
[functions]
  node_bundler = "esbuild"

# â­ HOTFIX: íƒ€ì„ì•„ì›ƒ 26ì´ˆë¡œ ì—°ì¥ (ê¸°ë³¸ 10ì´ˆ â†’ 26ì´ˆ)
# - Gemini ì´ë¯¸ì§€ ë¶„ì„: ~2-3ì´ˆ
# - Supabase ë²¡í„° ê²€ìƒ‰: ~1-2ì´ˆ
# - GPT ë ˆì‹œí”¼ ìƒì„±: ~5-10ì´ˆ
# - ë³´ì•ˆ í•„í„°ë§: ~1ì´ˆ
# ì´ ì˜ˆìƒ ì‹œê°„: 10-16ì´ˆ â†’ 26ì´ˆë¡œ ì—¬ìœ  í™•ë³´
[functions."chatbot-api"]
  node_bundler = "esbuild"
  timeout = 26

# â­ Lookbook AI ë¶„ì„ + ì´ë¯¸ì§€ 3ì¥ ìƒì„±
# - Gemini ë¶„ì„: ~3-5ì´ˆ
# - Imagen 4 Fast ì´ë¯¸ì§€ ìƒì„±: ~5-8ì´ˆ x 3ì¥ = 15-24ì´ˆ
# ì´ ì˜ˆìƒ ì‹œê°„: 20-30ì´ˆ â†’ 26ì´ˆë¡œ ì„¤ì • (ë¬´ë£Œ í”Œëœ ìµœëŒ€)
[functions."lookbook-analyze"]
  node_bundler = "esbuild"
  timeout = 26

# â­ í—¤ì–´ì²´í—˜ AI (Vmodel API)
# - Task ìƒì„±: ~1-2ì´ˆ
# - AI ì²˜ë¦¬ ë° í´ë§: ~10-20ì´ˆ
# ì´ ì˜ˆìƒ ì‹œê°„: 15-25ì´ˆ â†’ 26ì´ˆë¡œ ì„¤ì • (ë¬´ë£Œ í”Œëœ ìµœëŒ€)
[functions."hair-change"]
  node_bundler = "esbuild"
  timeout = 26

# â­ 360Â° ë·° ì´ë¯¸ì§€ ìƒì„± (Gemini API)
# - Geminië¡œ 4ê°œ ë·° ì´ë¯¸ì§€ ìƒì„±: ~20-30ì´ˆ
# - Firebase Storage ì—…ë¡œë“œ: ~5ì´ˆ
# ì´ ì˜ˆìƒ ì‹œê°„: 25-35ì´ˆ â†’ 26ì´ˆë¡œ ì„¤ì • (ë¬´ë£Œ í”Œëœ ìµœëŒ€)
[functions."generate-360-views"]
  node_bundler = "esbuild"
  timeout = 26

# â­ ì´ë¯¸ì§€ ì •ë¦¬ ìŠ¤ì¼€ì¤„ í•¨ìˆ˜ (ë§¤ì¼ ì‹¤í–‰)
# - 7ì¼ ì§€ë‚œ temp_uploads/ ì´ë¯¸ì§€ ìë™ ì‚­ì œ
# - Firebase Storageì—ì„œ ë§Œë£Œëœ íŒŒì¼ ì •ë¦¬
[functions."cleanup-old-images"]
  node_bundler = "esbuild"
  schedule = "@daily"

# â­ í”Œëœ ë§Œë£Œ ì²´í¬ ìŠ¤ì¼€ì¤„ í•¨ìˆ˜ (ë§¤ì¼ KST 09:00 ì‹¤í–‰)
# - ë§Œë£Œëœ í”Œëœ ìë™ ë‹¤ìš´ê·¸ë ˆì´ë“œ (free ì „í™˜, í† í° ì´ˆê¸°í™”)
# - ë§Œë£Œ ì„ë°• ì•Œë¦¼ ìƒì„± (7ì¼, 3ì¼, 1ì¼ ì „)
# - ì¸ì•± ì•Œë¦¼ ì €ì¥ (notifications ì»¬ë ‰ì…˜)
[functions."check-plan-expiration"]
  node_bundler = "esbuild"
  schedule = "@daily"

# ========== ìºì‹œ ì„¤ì • (ê°œë°œ/ì—…ë°ì´íŠ¸ ë¹ˆë²ˆ) ==========
# HTML íŒŒì¼ - ìºì‹œ ë¹„í™œì„±í™”
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
    Pragma = "no-cache"
    Expires = "0"

# JavaScript íŒŒì¼ - ìºì‹œ ë¹„í™œì„±í™” (ê°œë°œ ì¤‘)
[[headers]]
  for = "/js/*"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

# CSS íŒŒì¼ - ìºì‹œ ë¹„í™œì„±í™” (ê°œë°œ ì¤‘)
[[headers]]
  for = "/css/*"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

# index.html - í•­ìƒ ìµœì‹ 
[[headers]]
  for = "/index.html"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
    Pragma = "no-cache"
    Expires = "0"

# ========== í—¤ì–´ì²´í—˜ AI ì„œë¹„ìŠ¤ ì„¤ì • ==========
# í—¤ì–´ì²´í—˜ ì„œë¹„ìŠ¤ íŒŒì¼ - ì§§ì€ ìºì‹œ
[[headers]]
  for = "/js/hair-experience-service.js"
  [headers.values]
    Cache-Control = "public, max-age=600, must-revalidate"
    X-Content-Type-Options = "nosniff"

# AI í†µí•© íŒŒì¼ - ì§§ì€ ìºì‹œ
[[headers]]
  for = "/js/ai-integration.js"
  [headers.values]
    Cache-Control = "public, max-age=600, must-revalidate"
    X-Content-Type-Options = "nosniff"

# ========== ì±—ë´‡ íŒŒì¼ ì„¤ì • ==========
[[headers]]
  for = "/js/chatbot.js"
  [headers.values]
    Cache-Control = "public, max-age=600, must-revalidate"
    X-Content-Type-Options = "nosniff"

[[headers]]
  for = "/css/chatbot.css"
  [headers.values]
    Cache-Control = "public, max-age=600, must-revalidate"
    X-Content-Type-Options = "nosniff"

# ========== Netlify Functions (ì±—ë´‡ API) - CORS ì„¤ì • ==========
[[headers]]
  for = "/.netlify/functions/*"
  [headers.values]
    Access-Control-Allow-Origin = "*"
    Access-Control-Allow-Headers = "Content-Type, Authorization, X-Requested-With"
    Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS"
    Cache-Control = "no-cache, no-store, must-revalidate"
    X-Content-Type-Options = "nosniff"

# ========== PWA ì„¤ì • ==========
# Service Worker - ìºì‹œ ë¹„í™œì„±í™”
[[headers]]
  for = "/service-worker.js"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"
    Service-Worker-Allowed = "/"

# Manifest.json - iOS PWA ì§€ì›
[[headers]]
  for = "/manifest.json"
  [headers.values]
    Content-Type = "application/manifest+json"
    Cache-Control = "no-cache, no-store, must-revalidate"
    Access-Control-Allow-Origin = "*"

# ========== ì •ì  ìì› (ì¥ê¸° ìºì‹œ ê°€ëŠ¥) ==========
# ì•„ì´ì½˜ íŒŒì¼ - 1ë‹¬ ìºì‹œ
[[headers]]
  for = "/icons/*"
  [headers.values]
    Cache-Control = "public, max-age=2592000, immutable"
    Access-Control-Allow-Origin = "*"

# Apple ì•„ì´ì½˜
[[headers]]
  for = "/apple-touch-icon.png"
  [headers.values]
    Content-Type = "image/png"
    Cache-Control = "public, max-age=2592000, immutable"

# ì´ë¯¸ì§€ íŒŒì¼ë“¤
[[headers]]
  for = "/images/*"
  [headers.values]
    Cache-Control = "public, max-age=2592000, immutable"

# ========== í¼ìŠ¤ë„ì»¬ëŸ¬ ê¸°ëŠ¥ ==========
[[headers]]
  for = "/personal-color/*"
  [headers.values]
    X-Frame-Options = "SAMEORIGIN"
    X-XSS-Protection = "1; mode=block"
    X-Content-Type-Options = "nosniff"
    Permissions-Policy = "camera=(self), microphone=(self), autoplay=(self)"

# ========== ë³´ì•ˆ í—¤ë” (ì „ì²´ ì ìš©) - MediaPipe + AI API í†µí•© ==========
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "SAMEORIGIN"
    X-XSS-Protection = "1; mode=block"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "no-referrer-when-downgrade"
    Permissions-Policy = "camera=(self), microphone=(self), geolocation=()"
    # í—¤ì–´ì²´í—˜ + ì±—ë´‡ + MediaPipe í†µì‹ ì„ ìœ„í•œ CSP ì„¤ì •
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://apis.google.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://cdn.portone.io https://*.portone.io https://*.iamport.co; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; img-src 'self' data: https: blob:; font-src 'self' data: https://fonts.gstatic.com https://cdn.jsdelivr.net; media-src 'self' https://generativelanguage.googleapis.com https://*.googleapis.com blob:; frame-src 'self' https://*.firebaseapp.com https://*.firebase.com https://*.portone.io https://*.nicepay.co.kr https://*.iamport.co; connect-src 'self' https://generativelanguage.googleapis.com https://api.openai.com https://*.googleapis.com https://apis.google.com https://www.gstatic.com https://*.supabase.co https://*.firebaseio.com https://*.firebaseapp.com https://lovely-lebkuchen-4017ca.netlify.app https://cdn.jsdelivr.net https://*.portone.io https://*.nicepay.co.kr https://*.iamport.co;"

# ========== ë£©ë¶ ì•± ì„¤ì • ==========
[[headers]]
  for = "/lookbook.html"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate"

[[headers]]
  for = "/src/*"
  [headers.values]
    Cache-Control = "public, max-age=600, must-revalidate"

# ========== SPA ë¼ìš°íŒ… ==========
# ë£©ë¶ í˜ì´ì§€
[[redirects]]
  from = "/lookbook"
  to = "/lookbook.html"
  status = 200

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
  force = false

# ========== í™˜ê²½ë³€ìˆ˜ ë³´ì•ˆ ==========
# Functionsì—ì„œ í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©ì„ ìœ„í•œ ì„¤ì •
[context.production.environment]
  GEMINI_API_KEY = ""           # ë„¤í‹€ë¦¬íŒŒì´ ëŒ€ì‹œë³´ë“œì—ì„œ ì„¤ì •
  OPENAI_API_KEY = ""
  SUPABASE_URL = ""
  SUPABASE_ANON_KEY = ""

[context.deploy-preview.environment]
  GEMINI_API_KEY = ""           # í”„ë¦¬ë·°ìš© ë³„ë„ í‚¤ (í•„ìš”ì‹œ)
  OPENAI_API_KEY = ""
  SUPABASE_URL = ""
  SUPABASE_ANON_KEY = ""

# ========== ë¹Œë“œ ìµœì í™” ==========
[build.processing]
  skip_processing = false
[build.processing.css]
  bundle = false
  minify = false
[build.processing.js]
  bundle = false
  minify = false
[build.processing.html]
  pretty_urls = true

# ========== Functions í™˜ê²½ë³€ìˆ˜ ì°¸ê³  ==========
# Netlify Dashboardì—ì„œ ì„¤ì •í•  í™˜ê²½ë³€ìˆ˜ ëª©ë¡:
# 
# 1. GEMINI_API_KEY
#    ê°’: gen-lang-client-0911375709
#    ìš©ë„: í—¤ì–´ì²´í—˜ AI + ì±—ë´‡ ì´ë¯¸ì§€ ë¶„ì„
#
# 2. OPENAI_API_KEY
#    ê°’: sk-proj-Wibr2er9B0Z5QqcqdJ_0_B1e9YXbacLzHFS2oVEJ...
#    ìš©ë„: ì±—ë´‡ ì„ë² ë”© ìƒì„± + GPT ë‹µë³€
#
# 3. SUPABASE_URL
#    ê°’: https://bhsbwbeisqzgipvzpvym.supabase.co
#    ìš©ë„: ì±—ë´‡ ë²¡í„° ê²€ìƒ‰
#
# 4. SUPABASE_ANON_KEY
#    ê°’: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3M...
#    ìš©ë„: Supabase ì¸ì¦
#
# 203: # ========== íƒ€ì„ì•„ì›ƒ ì„¤ì • íˆìŠ¤í† ë¦¬ ==========
# 204: # 2025-01-25: ê¸°ë³¸ 10ì´ˆ â†’ 26ì´ˆë¡œ ì—°ì¥
# 205: # - ì›ì¸: GPT ë ˆì‹œí”¼ ìƒì„± ì‹œ HTTP 504 íƒ€ì„ì•„ì›ƒ ë°œìƒ
# 206: # - í•´ê²°: ë¬´ë£Œ í”Œëœ ìµœëŒ€ê°’ 26ì´ˆë¡œ ì„¤ì •
# 207: # - íš¨ê³¼: ë³µì¡í•œ ë ˆì‹œí”¼ ìƒì„±ë„ ì•ˆì •ì ìœ¼ë¡œ ì²˜ë¦¬
