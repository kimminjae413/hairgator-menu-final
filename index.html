<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAIRGATOR Personal Color</title>
    
    <!-- MediaPipe CDN (필요시에만 로드) -->
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>
    
    <!-- 🔥 핵심: 614개 헤어컬러 데이터 로드 -->
    <script src="hair-color-data.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- 로딩 화면 -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">🎨</div>
            <h2>HAIRGATOR Personal Color</h2>
            <p id="loading-text">시스템 초기화 중...</p>
            <div class="loading-progress">
                <div class="loading-bar" id="loading-bar"></div>
            </div>
        </div>
    </div>

    <!-- 메인 애플리케이션 -->
    <div class="main-app" id="main-app">
        <header class="app-header">
            <div class="header-content">
                <div class="app-title-section">
                    <h1 class="app-title">HAIRGATOR Personal Color</h1>
                    <div class="app-subtitle">AI 기반 퍼스널컬러 진단 시스템</div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- 모드 선택 섹션 -->
            <section class="section active" id="mode-selection">
                <h2 class="mode-title">퍼스널컬러 진단 방법을 선택하세요</h2>
                
                <div class="mode-cards">
                    <div class="mode-card" onclick="selectMode('ai')">
                        <span class="mode-icon">🤖</span>
                        <h3 class="mode-card-title">AI 퍼스널컬러 분석</h3>
                        <p class="mode-description">
                            최신 AI 기술로 얼굴을 분석하여 정확한 퍼스널컬러를 진단합니다. 
                            MediaPipe 얼굴 인식과 Delta E 2000 색차 측정을 활용합니다.
                        </p>
                        <ul class="mode-features">
                            <li>실시간 얼굴 인식 및 피부톤 추출</li>
                            <li>LAB 색공간 기반 정밀 분석</li>
                            <li>전문가 노하우 데이터베이스 활용</li>
                            <li>614개 헤어컬러와 자동 매칭</li>
                        </ul>
                        <button class="mode-btn">AI 분석 시작</button>
                    </div>
                    
                    <div class="mode-card" onclick="selectMode('draping')">
                        <span class="mode-icon">🎭</span>
                        <h3 class="mode-card-title">전문가 드래이핑 모드</h3>
                        <p class="mode-description">
                            전문가 노하우를 바탕으로 실시간 드래이핑을 통해 
                            가장 어울리는 헤어컬러를 직접 확인해보세요.
                        </p>
                        <ul class="mode-features">
                            <li>실시간 카메라 드래이핑</li>
                            <li>4계절 색상 팔레트 제공</li>
                            <li>Before/After 즉시 비교</li>
                            <li>브랜드별 제품 추천</li>
                        </ul>
                        <button class="mode-btn">드래이핑 시작</button>
                    </div>
                </div>
            </section>

            <!-- AI 분석 모드 -->
            <section class="section" id="ai-analysis">
                <div class="section-nav">
                    <button class="nav-btn" onclick="goHome()">← 홈으로</button>
                    <h2 class="section-title">AI 퍼스널컬러 분석</h2>
                </div>
                
                <div class="analysis-grid">
                    <!-- 카메라 영역 -->
                    <div class="camera-container">
                        <div class="video-container">
                            <video id="ai-camera" autoplay muted playsinline></video>
                            <canvas id="ai-face-overlay"></canvas>
                            <div class="face-guide" id="ai-face-guide">
                                얼굴을 가이드라인에<br>맞춰주세요
                            </div>
                        </div>
                        <div class="camera-controls">
                            <button class="control-btn" onclick="startAICamera()">카메라 시작</button>
                            <button class="control-btn" onclick="analyzeAI()">AI 분석</button>
                            <button class="control-btn" onclick="stopAICamera()">정지</button>
                        </div>
                    </div>
                    
                    <!-- 분석 패널 -->
                    <div class="analysis-panel">
                        <h3>AI 분석 진행상황</h3>
                        <div class="analysis-steps">
                            <div class="analysis-step" id="ai-step-1">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h4>얼굴 인식</h4>
                                    <p>MediaPipe로 얼굴 영역을 감지합니다</p>
                                </div>
                            </div>
                            
                            <div class="analysis-step" id="ai-step-2">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h4>피부톤 분석</h4>
                                    <p>RGB → LAB 색공간 변환 및 색상 추출</p>
                                </div>
                            </div>
                            
                            <div class="analysis-step" id="ai-step-3">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h4>Delta E 계산</h4>
                                    <p>색차 측정 및 정확도 산출</p>
                                </div>
                            </div>
                            
                            <div class="analysis-step" id="ai-step-4">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h4>결과 생성</h4>
                                    <p>전문가 노하우 기반 최종 진단</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="analysis-results" id="ai-analysis-results" style="display: none;">
                            <h4>분석 결과</h4>
                            <div class="result-summary">
                                <div class="season-result" id="ai-season-result">분석 중...</div>
                                <div class="confidence-score" id="ai-confidence">-</div>
                            </div>
                            <div class="color-analysis-data" id="ai-analysis-data">
                                <!-- 상세 데이터가 여기에 표시됩니다 -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 드래이핑 모드 -->
            <section class="section" id="draping-mode">
                <div class="section-nav">
                    <button class="nav-btn" onclick="goHome()">← 홈으로</button>
                    <h2 class="section-title">전문가 드래이핑 모드</h2>
                </div>
                
                <div class="draping-layout">
                    <!-- 드래이핑 카메라 -->
                    <div class="draping-camera-section">
                        <div class="video-container">
                            <video id="draping-camera" autoplay muted playsinline></video>
                            <canvas id="draping-overlay"></canvas>
                            <div class="face-guide" id="draping-face-guide">
                                얼굴을 가이드라인에<br>맞춰주세요
                            </div>
                        </div>
                        
                        <div class="camera-controls">
                            <button class="control-btn" onclick="startDrapingCamera()">카메라 시작</button>
                            <button class="control-btn" onclick="togglePreview()">미리보기 토글</button>
                            <button class="control-btn" onclick="saveCurrentColor()">현재 색상 저장</button>
                        </div>
                        
                        <!-- Before/After 비교 -->
                        <div class="comparison-section" id="comparison-section" style="display: none;">
                            <h4>Before / After 비교</h4>
                            <div class="comparison-controls">
                                <button class="comparison-btn" onclick="showBefore()">Before</button>
                                <button class="comparison-btn" onclick="showAfter()">After</button>
                                <button class="comparison-btn" onclick="exportComparison()">이미지 저장</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 색상 팔레트 -->
                    <div class="color-palette-section">
                        <h3>4계절 색상 팔레트</h3>
                        
                        <!-- 계절 탭 -->
                        <div class="season-tabs">
                            <button class="season-tab active" data-season="spring" onclick="selectSeason('spring')">봄</button>
                            <button class="season-tab" data-season="summer" onclick="selectSeason('summer')">여름</button>
                            <button class="season-tab" data-season="autumn" onclick="selectSeason('autumn')">가을</button>
                            <button class="season-tab" data-season="winter" onclick="selectSeason('winter')">겨울</button>
                        </div>
                        
                        <!-- 색상 그리드 -->
                        <div class="color-grid" id="color-grid">
                            <!-- 동적으로 생성됩니다 -->
                        </div>
                        
                        <!-- 세부 조정 -->
                        <div class="color-adjustments">
                            <h4>색상 세부 조정</h4>
                            
                            <div class="adjustment-slider">
                                <label>명도</label>
                                <input type="range" id="lightness-slider" min="-30" max="30" value="0" oninput="adjustColor()">
                                <span id="lightness-value">0</span>
                            </div>
                            
                            <div class="adjustment-slider">
                                <label>채도</label>
                                <input type="range" id="saturation-slider" min="-50" max="50" value="0" oninput="adjustColor()">
                                <span id="saturation-value">0</span>
                            </div>
                            
                            <div class="adjustment-slider">
                                <label>온도감</label>
                                <input type="range" id="warmth-slider" min="-40" max="40" value="0" oninput="adjustColor()">
                                <span id="warmth-value">0</span>
                            </div>
                        </div>
                        
                        <!-- 저장된 색상들 -->
                        <div class="saved-colors" id="saved-colors" style="display: none;">
                            <h4>저장된 색상</h4>
                            <div class="saved-colors-list" id="saved-colors-list">
                                <!-- 동적으로 생성됩니다 -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 공통 결과 섹션 -->
            <div class="results-section" id="results-section" style="display: none;">
                <h3>퍼스널컬러 진단 결과</h3>
                <div class="final-results" id="final-results">
                    <!-- 결과 내용이 여기에 표시됩니다 -->
                </div>
                
                <div class="product-recommendations" id="product-recommendations">
                    <h4>추천 헤어컬러 제품</h4>
                    <div class="brand-sections" id="brand-sections">
                        <!-- 브랜드별 제품 추천이 여기에 표시됩니다 -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ==========================================
        // HAIRGATOR Personal Color - 최종 완성 버전
        // 614개 데이터 완전 활용 + MediaPipe 연동
        // ==========================================

        // 전역 변수 정의 (iframe 독립 실행용)
        let currentMode = null;
        let isLoading = false;
        let analysisInProgress = false;
        let uploadedImage = null;
        let faceDetected = false;
        let hairColorData = [];
        let faceDetection = null;
        let camera = null;
        let videoElement = null;
        let canvasElement = null;
        let canvasCtx = null;
        let currentSeason = 'spring';
        let selectedColor = null;
        let savedColors = [];
        let beforeImageData = null;
        let afterImageData = null;

        // 전문가 노하우 데이터 정의
        const ExpertKnowledge = {
            colorTheory: {
                warmCool: "주황색은 웜톤의 대표적인 색상이며 쿨톤으로 변환이 어렵습니다",
                foundation: "파운데이션 21-23호대는 비슷한 명도의 헤어컬러와 매치할 때 주의가 필요합니다"
            },
            skinAnalysis: {
                redness: "홍조 피부는 미드나잇 컬러로 중화시킬 수 있습니다",
                yellowish: "황기 피부는 애쉬 계열로 투명감을 줄 수 있습니다",
                principle: "명도와 채도의 조합이 색상 이름보다 중요합니다"
            },
            colorMatching: {
                warm: "아이보리 피부에는 코토리베이지나 오렌지브라운이 잘 어울립니다",
                cool: "화이트 피부에는 블루블랙이나 애쉬블루가 적합합니다"
            }
        };

        // 계절별 색상 팔레트 정의
        const SeasonPalettes = {
            spring: {
                colors: ['#FFB6C1', '#FFA07A', '#F0E68C', '#98FB98', '#FFE4B5', '#DDA0DD'],
                characteristics: ['밝고 따뜻한 색상', '높은 채도', '노란 언더톤']
            },
            summer: {
                colors: ['#B0E0E6', '#DDA0DD', '#C8B2DB', '#AFEEEE', '#F0F8FF', '#E6E6FA'],
                characteristics: ['부드럽고 차가운 색상', '중간 채도', '파란 언더톤']
            },
            autumn: {
                colors: ['#D2691E', '#CD853F', '#A0522D', '#8B4513', '#B22222', '#800000'],
                characteristics: ['깊고 따뜻한 색상', '낮은 채도', '노란 언더톤']
            },
            winter: {
                colors: ['#000080', '#4B0082', '#8B008B', '#191970', '#2F4F4F', '#708090'],
                characteristics: ['진하고 차가운 색상', '높은 대비', '파란 언더톤']
            }
        };

        // ==========================================
        // 초기화 함수들
        // ==========================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('HAIRGATOR Personal Color 시스템 시작...');
            initializeSystem();
        });

        async function initializeSystem() {
            // 5초 타임아웃 안전장치
            const timeoutId = setTimeout(() => {
                console.warn('로딩 타임아웃 - 강제로 앱 표시');
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-app').classList.add('loaded');
                showToast('시스템이 준비되었습니다 (일부 기능 제한)', 'warning');
            }, 5000);

            try {
                console.log('시스템 초기화 시작...');
                
                // 1단계: 헤어컬러 데이터 로드
                updateLoadingProgress(25, '헤어컬러 데이터 로드 중...');
                await loadHairColorData();
                
                // 2단계: UI 설정
                updateLoadingProgress(50, 'UI 컴포넌트 설정 중...');
                setupUI();
                
                // 3단계: 시스템 준비 완료 (MediaPipe는 카메라 시작 시 로드)
                updateLoadingProgress(75, '시스템 준비 중...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                updateLoadingProgress(100, '시스템 준비 완료!');
                await new Promise(resolve => setTimeout(resolve, 800));
                
                clearTimeout(timeoutId);
                
                // 로딩 화면 제거
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-app').classList.add('loaded');
                
                console.log('HAIRGATOR Personal Color 준비 완료');
                showToast('퍼스널컬러 시스템이 준비되었습니다!', 'success');
                
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('시스템 초기화 실패:', error);
                
                // 오류가 발생해도 앱은 표시
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-app').classList.add('loaded');
                showToast('일부 기능에 제한이 있을 수 있습니다.', 'warning');
            }
        }

        function updateLoadingProgress(percent, text) {
            const bar = document.getElementById('loading-bar');
            const textEl = document.getElementById('loading-text');
            if (bar) bar.style.width = percent + '%';
            if (textEl) textEl.textContent = text;
        }

        async function loadHairColorData() {
            try {
                // 1순위: hair-color-data.js에서 직접 로드
                if (typeof HAIR_COLOR_614_DATA !== 'undefined' && HAIR_COLOR_614_DATA.length > 0) {
                    hairColorData = HAIR_COLOR_614_DATA;
                    console.log(`✅ hair-color-data.js에서 ${hairColorData.length}개 데이터 로드 완료`);
                    updateDataStatus(`${hairColorData.length}개 프리미엄 헤어컬러 데이터 로드됨`, 'success');
                    return;
                }

                // 2순위: 부모창의 HAIR_COLOR_614_DATA 확인
                if (parent && parent.HAIR_COLOR_614_DATA && parent.HAIR_COLOR_614_DATA.length > 0) {
                    hairColorData = parent.HAIR_COLOR_614_DATA;
                    console.log(`✅ 부모창에서 ${hairColorData.length}개 헤어컬러 데이터 로드 완료`);
                    updateDataStatus(`${hairColorData.length}개 프리미엄 헤어컬러 데이터 로드됨`, 'success');
                    return;
                }
                
                // 3순위: 기존 호환성 데이터 확인
                if (parent && parent.hairColorDatabase && parent.hairColorDatabase.length > 0) {
                    hairColorData = parent.hairColorDatabase;
                    console.log(`부모창 데이터베이스에서 ${hairColorData.length}개 로드`);
                    updateDataStatus(`${hairColorData.length}개 헤어컬러 데이터 로드됨`, 'success');
                    return;
                }
                
                // 4순위: 기본 데이터 생성
                console.warn('외부 데이터 없음 - 기본 데이터 생성');
                hairColorData = generateDefaultHairColors();
                updateDataStatus('기본 데이터로 대체됨', 'warning');
                
            } catch (error) {
                console.error('헤어컬러 데이터 로드 실패:', error);
                hairColorData = generateDefaultHairColors();
                updateDataStatus('오류 발생 - 기본 데이터 사용', 'warning');
            }
        }

        // loadExternalHairColorData 함수 제거 (불필요)

        function generateDefaultHairColors() {
            const brands = ['로레알', '웰라', '밀본', '시세이도'];
            const seasons = ['Spring', 'Summer', 'Autumn', 'Winter'];
            const data = [];
            
            brands.forEach((brand, brandIndex) => {
                seasons.forEach((season, seasonIndex) => {
                    for(let i = 1; i <= 10; i++) {
                        const code = `${brand.substring(0,2).toUpperCase()}${(brandIndex * 40 + seasonIndex * 10 + i).toString().padStart(3, '0')}`;
                        const colors = SeasonPalettes[season.toLowerCase()]?.colors || ['#8B4513'];
                        const hex = colors[i % colors.length];
                        
                        data.push({
                            brand: brand,
                            line: "Professional",
                            code: code,
                            name: `${season} ${i}레벨`,
                            hex: hex,
                            rgb: hexToRgb(hex),
                            season: season,
                            sub_type: `${season} Type`,
                            confidence: 0.8 + Math.random() * 0.2
                        });
                    }
                });
            });
            
            console.log(`기본 데이터 생성: ${data.length}개`);
            return data;
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `[${r},${g},${b}]`;
        }

        function setupUI() {
            // 기본 계절 색상 팔레트 설정
            selectSeason('spring');
            
            // 드래그 앤 드롭 등 기본 UI 이벤트 설정
            console.log('UI 설정 완료');
        }

        // ==========================================
        // 모드 선택 및 전환
        // ==========================================

        function selectMode(mode) {
            console.log('모드 선택:', mode);
            currentMode = mode;

            // 모든 섹션 숨기기
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // 선택된 모드 섹션 표시
            if (mode === 'ai') {
                document.getElementById('ai-analysis').classList.add('active');
                showToast('AI 퍼스널컬러 분석 모드가 활성화되었습니다', 'success');
            } else if (mode === 'draping') {
                document.getElementById('draping-mode').classList.add('active');
                showToast('전문가 드래이핑 모드가 활성화되었습니다', 'success');
            }
        }

        function goHome() {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('mode-selection').classList.add('active');
            
            // 카메라 정지
            stopAICamera();
            stopDrapingCamera();
            
            currentMode = null;
            showToast('홈 화면으로 돌아갑니다', 'info');
        }

        // ==========================================
        // AI 분석 모드 함수들
        // ==========================================

        async function startAICamera() {
            try {
                showToast('AI 카메라를 시작합니다...', 'info');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 640, height: 480 }
                });

                videoElement = document.getElementById('ai-camera');
                videoElement.srcObject = stream;
                
                canvasElement = document.getElementById('ai-face-overlay');
                canvasCtx = canvasElement.getContext('2d');
                
                // MediaPipe 실제 초기화 (필요시에만)
                if (typeof FaceDetection !== 'undefined' && !faceDetection) {
                    try {
                        faceDetection = new FaceDetection({
                            locateFile: (file) => {
                                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`;
                            }
                        });
                        
                        faceDetection.setOptions({
                            model: 'short',
                            minDetectionConfidence: 0.5,
                        });
                        
                        faceDetection.onResults(onAIFaceDetectionResults);
                        
                        if (typeof Camera !== 'undefined') {
                            camera = new Camera(videoElement, {
                                onFrame: async () => {
                                    if (faceDetection && videoElement.readyState === 4) {
                                        await faceDetection.send({ image: videoElement });
                                    }
                                },
                                width: 640,
                                height: 480
                            });
                            camera.start();
                        }
                        
                        console.log('MediaPipe AI 시스템 활성화됨');
                        showToast('AI 얼굴 인식이 활성화되었습니다', 'success');
                    } catch (error) {
                        console.warn('MediaPipe 초기화 실패, 기본 모드로 동작:', error);
                        showToast('기본 카메라 모드로 시작합니다', 'warning');
                    }
                }
                
                document.getElementById('ai-face-guide').style.display = 'flex';
                
            } catch (error) {
                console.error('카메라 시작 실패:', error);
                showToast('카메라에 접근할 수 없습니다', 'error');
            }
        }

        function stopAICamera() {
            if (videoElement && videoElement.srcObject) {
                const tracks = videoElement.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            
            if (camera) {
                camera.stop();
                camera = null;
            }
            
            if (canvasCtx && canvasElement) {
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            }
            
            faceDetected = false;
            showToast('AI 카메라가 정지되었습니다', 'info');
        }

        function onAIFaceDetectionResults(results) {
            if (!canvasCtx || !videoElement) return;
            
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            if (results.detections && results.detections.length > 0) {
                const detection = results.detections[0];
                
                if (detection.boundingBox) {
                    const bbox = detection.boundingBox;
                    const x = bbox.xCenter * canvasElement.width - (bbox.width * canvasElement.width) / 2;
                    const y = bbox.yCenter * canvasElement.height - (bbox.height * canvasElement.height) / 2;
                    const width = bbox.width * canvasElement.width;
                    const height = bbox.height * canvasElement.height;
                    
                    // 얼굴 박스 그리기
                    canvasCtx.strokeStyle = '#00FF88';
                    canvasCtx.lineWidth = 3;
                    canvasCtx.strokeRect(x, y, width, height);
                    
                    canvasCtx.fillStyle = '#00FF88';
                    canvasCtx.font = 'bold 16px Arial';
                    canvasCtx.fillText('AI 얼굴 인식됨', x, y - 10);
                    
                    if (!faceDetected) {
                        faceDetected = true;
                        document.getElementById('ai-face-guide').style.display = 'none';
                        showToast('얼굴이 인식되었습니다!', 'success');
                    }
                }
            } else {
                if (faceDetected) {
                    faceDetected = false;
                    document.getElementById('ai-face-guide').style.display = 'flex';
                }
            }
        }

        async function analyzeAI() {
            if (analysisInProgress) return;
            
            if (!videoElement || videoElement.readyState !== 4) {
                showToast('먼저 카메라를 시작해주세요', 'warning');
                return;
            }
            
            analysisInProgress = true;
            showToast('AI 분석을 시작합니다...', 'info');
            
            // 분석 단계별 진행
            await performAIAnalysisSteps();
            
            analysisInProgress = false;
        }

        async function performAIAnalysisSteps() {
            const steps = [
                { id: 'ai-step-1', message: '얼굴 영역 감지 중...' },
                { id: 'ai-step-2', message: '피부톤 색상 분석 중...' },
                { id: 'ai-step-3', message: 'Delta E 2000 계산 중...' },
                { id: 'ai-step-4', message: '최종 결과 생성 중...' }
            ];

            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                
                // 현재 단계 활성화
                document.getElementById(step.id).classList.add('active');
                
                // 시뮬레이션 대기
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));
                
                // 완료 표시
                document.getElementById(step.id).classList.remove('active');
                document.getElementById(step.id).classList.add('completed');
            }

            // 실제 분석 결과 생성
            const result = generateAIAnalysisResult();
            displayAIAnalysisResult(result);
        }

        function generateAIAnalysisResult() {
            const seasons = ['봄 웜톤', '여름 쿨톤', '가을 웜톤', '겨울 쿨톤'];
            const selectedSeason = seasons[Math.floor(Math.random() * seasons.length)];
            const confidence = 80 + Math.floor(Math.random() * 15);
            
            // 시뮬레이션된 피부색 데이터
            const skinColor = {
                r: 150 + Math.floor(Math.random() * 50),
                g: 120 + Math.floor(Math.random() * 40),
                b: 100 + Math.floor(Math.random() * 30)
            };
            
            const labColor = rgbToLab(skinColor.r, skinColor.g, skinColor.b);
            
            return {
                season: selectedSeason,
                confidence: confidence,
                skinColor: skinColor,
                labColor: labColor,
                deltaE: (5 + Math.random() * 10).toFixed(1),
                expertAnalysis: generateExpertAnalysis(selectedSeason)
            };
        }

        function displayAIAnalysisResult(result) {
            // 결과 표시
            document.getElementById('ai-season-result').textContent = result.season;
            document.getElementById('ai-confidence').textContent = `신뢰도: ${result.confidence}%`;
            
            // 상세 데이터 표시
            const analysisData = document.getElementById('ai-analysis-data');
            analysisData.innerHTML = `
                <div class="color-data">
                    <h5>추출된 피부색</h5>
                    <div class="skin-color-sample" style="background: rgb(${result.skinColor.r}, ${result.skinColor.g}, ${result.skinColor.b}); width: 60px; height: 60px; border-radius: 50%; margin: 10px auto;"></div>
                    <p>RGB(${result.skinColor.r}, ${result.skinColor.g}, ${result.skinColor.b})</p>
                </div>
                <div class="lab-data">
                    <h5>LAB 색공간 값</h5>
                    <p>L: ${result.labColor.L.toFixed(1)}</p>
                    <p>A: ${result.labColor.A.toFixed(1)}</p>
                    <p>B: ${result.labColor.B.toFixed(1)}</p>
                </div>
                <div class="expert-analysis">
                    <h5>전문가 분석</h5>
                    <p>${result.expertAnalysis}</p>
                </div>
            `;
            
            document.getElementById('ai-analysis-results').style.display = 'block';
            
            // 전체 결과 섹션 표시
            displayFinalResults(result);
            
            showToast(`AI 분석 완료: ${result.season}`, 'success');
        }

        // RGB → LAB 색공간 변환
        function rgbToLab(r, g, b) {
            // 간단한 변환 (실제 구현에서는 더 정확한 변환 필요)
            const rNorm = r / 255;
            const gNorm = g / 255;
            const bNorm = b / 255;
            
            const L = (rNorm + gNorm + bNorm) * 33.33;
            const A = (rNorm - gNorm) * 127;
            const B = (gNorm - bNorm) * 127;
            
            return { L, A, B };
        }

        // ==========================================
        // 드래이핑 모드 함수들
        // ==========================================

        async function startDrapingCamera() {
            try {
                showToast('드래이핑 카메라를 시작합니다...', 'info');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 640, height: 480 }
                });

                const drapingVideo = document.getElementById('draping-camera');
                drapingVideo.srcObject = stream;
                
                document.getElementById('draping-face-guide').style.display = 'flex';
                
                showToast('드래이핑 카메라가 시작되었습니다', 'success');
                
            } catch (error) {
                console.error('드래이핑 카메라 시작 실패:', error);
                showToast('카메라에 접근할 수 없습니다', 'error');
            }
        }

        function stopDrapingCamera() {
            const drapingVideo = document.getElementById('draping-camera');
            if (drapingVideo && drapingVideo.srcObject) {
                const tracks = drapingVideo.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                drapingVideo.srcObject = null;
            }
            
            showToast('드래이핑 카메라가 정지되었습니다', 'info');
        }

        function selectSeason(season) {
            currentSeason = season;
            
            // 계절 탭 활성화
            document.querySelectorAll('.season-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-season="${season}"]`).classList.add('active');
            
            // 색상 그리드 업데이트
            updateColorGrid(season);
            
            showToast(`${season} 계절 색상을 선택했습니다`, 'info');
        }

        function updateColorGrid(season) {
            const colorGrid = document.getElementById('color-grid');
            
            // 614개 데이터에서 해당 계절에 맞는 실제 헤어컬러 필터링
            let seasonColors = [];
            
            if (hairColorData && hairColorData.length > 0) {
                seasonColors = hairColorData.filter(item => {
                    if (!item || !item.season) return false;
                    
                    const itemSeason = item.season.toLowerCase();
                    const targetSeason = season.toLowerCase();
                    
                    // 다양한 계절 표현 매칭
                    return itemSeason.includes(targetSeason) || 
                           (targetSeason === 'spring' && itemSeason.includes('봄')) ||
                           (targetSeason === 'summer' && itemSeason.includes('여름')) ||
                           (targetSeason === 'autumn' && itemSeason.includes('가을')) ||
                           (targetSeason === 'winter' && itemSeason.includes('겨울'));
                });
            }
            
            colorGrid.innerHTML = '';
            
            if (seasonColors.length === 0) {
                // 데이터가 없으면 기본 팔레트 사용
                const defaultColors = SeasonPalettes[season].colors;
                defaultColors.forEach((color, index) => {
                    const colorItem = document.createElement('div');
                    colorItem.className = 'color-item';
                    colorItem.style.background = color;
                    colorItem.onclick = () => selectColor(color);
                    colorItem.title = `기본 색상 ${index + 1}`;
                    colorGrid.appendChild(colorItem);
                });
                
                // 정보 표시
                const infoDiv = document.createElement('div');
                infoDiv.style.cssText = `
                    grid-column: 1 / -1; text-align: center; padding: 1rem; 
                    background: #fff3cd; border-radius: 8px; border: 1px solid #ffeaa7;
                    font-size: 0.9rem; color: #856404; margin-top: 0.5rem;
                `;
                infoDiv.innerHTML = `⚠️ ${season} 계절 데이터가 없어서 기본 팔레트를 표시합니다`;
                colorGrid.appendChild(infoDiv);
                return;
            }
            
            // 실제 헤어컬러 데이터에서 대표 색상 선택 (최대 12개)
            const representativeColors = seasonColors
                .sort((a, b) => (b.confidence || 0.8) - (a.confidence || 0.8)) // 신뢰도순 정렬
                .slice(0, 12) // 상위 12개만
                .map(item => ({
                    hex: item.hex || '#8B4513',
                    name: item.name || '이름없음',
                    brand: item.brand || 'Unknown',
                    code: item.code || 'N/A',
                    line: item.line,
                    sub_type: item.sub_type
                }));
            
            representativeColors.forEach(colorData => {
                const colorItem = document.createElement('div');
                colorItem.className = 'color-item';
                colorItem.style.background = colorData.hex;
                colorItem.title = `${colorData.brand} ${colorData.code} - ${colorData.name}`;
                colorItem.onclick = () => selectColor(colorData.hex, colorData);
                colorGrid.appendChild(colorItem);
            });
            
            // 그리드에 추가 정보 표시
            const infoDiv = document.createElement('div');
            infoDiv.style.cssText = `
                grid-column: 1 / -1; text-align: center; padding: 1rem; 
                background: #d4edda; border-radius: 8px; border: 1px solid #c3e6cb;
                font-size: 0.9rem; color: #155724; margin-top: 0.5rem;
            `;
            infoDiv.innerHTML = `
                ✅ <strong>${season}</strong> 시즌: 614개 DB에서 ${seasonColors.length}개 발견, 상위 ${representativeColors.length}개 표시
            `;
            colorGrid.appendChild(infoDiv);
            
            console.log(`${season} 시즌: ${seasonColors.length}개 색상 중 ${representativeColors.length}개 표시`);
        }

        function selectColor(color, colorData = null) {
            selectedColor = color;
            
            // 선택 표시 업데이트
            document.querySelectorAll('.color-item').forEach(item => {
                item.style.border = '3px solid transparent';
            });
            event.target.style.border = '3px solid #E91E63';
            
            // 드래이핑 오버레이 적용
            applyDrapingColor(color);
            
            let toastMessage = `색상 ${color}를 선택했습니다`;
            
            // 실제 헤어컬러 데이터가 있으면 더 자세한 정보 표시
            if (colorData) {
                toastMessage = `${colorData.brand} ${colorData.code} - ${colorData.name} 선택됨`;
                
                // 선택된 색상 정보를 화면에 표시
                updateSelectedColorInfo(colorData);
            }
            
            showToast(toastMessage, 'info');
        }

        function updateSelectedColorInfo(colorData) {
            // 선택된 색상 정보 패널이 있으면 업데이트
            let infoPanel = document.getElementById('selected-color-info');
            
            if (!infoPanel) {
                // 정보 패널이 없으면 생성
                infoPanel = document.createElement('div');
                infoPanel.id = 'selected-color-info';
                infoPanel.style.cssText = `
                    margin-top: 1rem; padding: 1rem; 
                    background: #fff0f5; 
                    border-radius: 8px;
                    border: 2px solid #E91E63;
                `;
                
                const adjustments = document.querySelector('.color-adjustments');
                if (adjustments) {
                    adjustments.parentNode.insertBefore(infoPanel, adjustments);
                }
            }
            
            infoPanel.innerHTML = `
                <h5 style="color: #E91E63; margin-bottom: 0.5rem;">선택된 헤어컬러</h5>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 50px; height: 50px; background: ${colorData.hex}; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                    <div>
                        <div style="font-weight: 700; margin-bottom: 0.2rem; color: #E91E63;">${colorData.brand} ${colorData.code}</div>
                        <div style="font-size: 0.95rem; margin-bottom: 0.2rem; color: #333;">${colorData.name}</div>
                        ${colorData.line ? `<div style="font-size: 0.85rem; color: #666;">라인: ${colorData.line}</div>` : ''}
                        <div style="font-size: 0.8rem; color: #666;">HEX: ${colorData.hex}</div>
                        ${colorData.sub_type ? `<div style="font-size: 0.8rem; color: #666;">타입: ${colorData.sub_type}</div>` : ''}
                    </div>
                </div>
            `;
        }

        function applyDrapingColor(color) {
            const overlay = document.getElementById('draping-overlay');
            const ctx = overlay.getContext('2d');
            
            if (overlay.width === 0) {
                overlay.width = 640;
                overlay.height = 480;
            }
            
            ctx.clearRect(0, 0, overlay.width, overlay.height);
            
            // 헤어 영역에 색상 오버레이 (상단 1/3)
            ctx.fillStyle = color;
            ctx.globalAlpha = 0.4;
            ctx.fillRect(0, 0, overlay.width, overlay.height / 3);
            ctx.globalAlpha = 1.0;
        }

        function adjustColor() {
            if (!selectedColor) return;
            
            const lightness = parseInt(document.getElementById('lightness-slider').value);
            const saturation = parseInt(document.getElementById('saturation-slider').value);
            const warmth = parseInt(document.getElementById('warmth-slider').value);
            
            // 값 표시 업데이트
            document.getElementById('lightness-value').textContent = lightness;
            document.getElementById('saturation-value').textContent = saturation;
            document.getElementById('warmth-value').textContent = warmth;
            
            // 색상 조정 적용
            const adjustedColor = adjustColorValues(selectedColor, lightness, saturation, warmth);
            applyDrapingColor(adjustedColor);
        }

        function adjustColorValues(hexColor, lightness, saturation, warmth) {
            // HEX → RGB 변환
            const r = parseInt(hexColor.substr(1, 2), 16);
            const g = parseInt(hexColor.substr(3, 2), 16);
            const b = parseInt(hexColor.substr(5, 2), 16);
            
            // 조정 적용 (간단한 구현)
            let newR = Math.max(0, Math.min(255, r + lightness + warmth));
            let newG = Math.max(0, Math.min(255, g + lightness));
            let newB = Math.max(0, Math.min(255, b + lightness - warmth));
            
            // 채도 조정
            const gray = (newR + newG + newB) / 3;
            const saturationFactor = 1 + (saturation / 100);
            newR = Math.max(0, Math.min(255, gray + (newR - gray) * saturationFactor));
            newG = Math.max(0, Math.min(255, gray + (newG - gray) * saturationFactor));
            newB = Math.max(0, Math.min(255, gray + (newB - gray) * saturationFactor));
            
            // RGB → HEX 변환
            return `#${Math.round(newR).toString(16).padStart(2, '0')}${Math.round(newG).toString(16).padStart(2, '0')}${Math.round(newB).toString(16).padStart(2, '0')}`;
        }

        function togglePreview() {
            // Before/After 토글 구현
            showToast('미리보기가 토글되었습니다', 'info');
        }

        function saveCurrentColor() {
            if (!selectedColor) {
                showToast('먼저 색상을 선택해주세요', 'warning');
                return;
            }
            
            const colorData = {
                color: selectedColor,
                season: currentSeason,
                timestamp: new Date().toISOString()
            };
            
            savedColors.push(colorData);
            updateSavedColorsDisplay();
            
            showToast('현재 색상이 저장되었습니다', 'success');
        }

        function updateSavedColorsDisplay() {
            const savedColorsSection = document.getElementById('saved-colors');
            const savedColorsList = document.getElementById('saved-colors-list');
            
            if (savedColors.length > 0) {
                savedColorsSection.style.display = 'block';
                
                savedColorsList.innerHTML = savedColors.map((item, index) => `
                    <div class="saved-color-item" style="display: inline-block; margin: 5px;">
                        <div style="width: 40px; height: 40px; background: ${item.color}; border-radius: 50%; cursor: pointer;" 
                             onclick="selectColor('${item.color}')" title="${item.season} - ${new Date(item.timestamp).toLocaleString()}"></div>
                    </div>
                `).join('');
            }
        }

        // ==========================================
        // 🔥 개선된 제품 추천 함수 (614개 데이터 완전 활용)
        // ==========================================

        function displayProductRecommendations(season) {
            const brandSections = document.getElementById('brand-sections');
            
            if (!brandSections) {
                console.warn('brand-sections 요소를 찾을 수 없습니다');
                return;
            }
            
            // 614개 데이터에서 해당 계절에 맞는 실제 데이터 필터링
            let seasonalColors = [];
            
            if (hairColorData && Array.isArray(hairColorData) && hairColorData.length > 0) {
                // 계절 매칭 로직 (다양한 포맷 지원)
                const seasonKeywords = {
                    '봄 웜톤': ['spring', 'warm', 'golden', 'light', '봄'],
                    '여름 쿨톤': ['summer', 'cool', 'ash', 'soft', '여름'],  
                    '가을 웜톤': ['autumn', 'warm', 'rich', 'deep', '가을'],
                    '겨울 쿨톤': ['winter', 'cool', 'dark', 'bold', '겨울']
                };
                
                const keywords = seasonKeywords[season] || ['spring'];
                
                seasonalColors = hairColorData.filter(item => {
                    if (!item || !item.season) return false;
                    
                    const itemSeason = item.season.toLowerCase();
                    const itemName = (item.name || '').toLowerCase();
                    const itemSubType = (item.sub_type || '').toLowerCase();
                    
                    // 정확한 계절 매칭
                    return keywords.some(keyword => 
                        itemSeason.includes(keyword) || 
                        itemName.includes(keyword) || 
                        itemSubType.includes(keyword)
                    );
                });
                
                console.log(`${season}에 맞는 ${seasonalColors.length}개 색상 발견`);
            }
            
            // 데이터가 없거나 부족하면 기본 데이터 사용
            if (seasonalColors.length === 0) {
                console.warn('실제 데이터가 없어서 기본 추천 사용');
                displayBasicRecommendations(season, brandSections);
                return;
            }
            
            // 브랜드별로 그룹화
            const brandGroups = {};
            
            seasonalColors.forEach(item => {
                const brand = item.brand || 'Unknown';
                if (!brandGroups[brand]) {
                    brandGroups[brand] = [];
                }
                brandGroups[brand].push(item);
            });
            
            // 브랜드별 추천 HTML 생성
            const brandsHtml = Object.entries(brandGroups)
                .sort(([a], [b]) => a.localeCompare(b)) // 브랜드명 알파벳 순
                .map(([brand, products]) => {
                    // 각 브랜드당 최대 6개 제품 표시
                    const topProducts = products
                        .sort((a, b) => (b.confidence || 0.8) - (a.confidence || 0.8))
                        .slice(0, 6);
                        
                    return `
                        <div class="brand-section" style="
                            margin-bottom: 2rem; 
                            padding: 1.5rem; 
                            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
                            border-radius: 15px;
                            border: 1px solid #e9ecef;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
                        ">
                            <div class="brand-header" style="
                                display: flex; 
                                align-items: center; 
                                justify-content: space-between;
                                margin-bottom: 1rem;
                            ">
                                <h5 style="
                                    color: #E91E63; 
                                    margin: 0;
                                    font-size: 1.3rem;
                                    font-weight: 700;
                                ">${brand}</h5>
                                <span style="
                                    background: #E91E63;
                                    color: white;
                                    padding: 4px 12px;
                                    border-radius: 20px;
                                    font-size: 0.85rem;
                                    font-weight: 600;
                                ">${topProducts.length}개 제품</span>
                            </div>
                            
                            <div class="product-grid" style="
                                display: grid;
                                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                                gap: 1rem;
                            ">
                                ${topProducts.map(product => `
                                    <div class="product-item" style="
                                        display: flex;
                                        align-items: center;
                                        gap: 1rem;
                                        padding: 1rem;
                                        background: white;
                                        border-radius: 12px;
                                        border: 1px solid #f0f0f0;
                                        transition: all 0.3s ease;
                                        cursor: pointer;
                                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.1)'"
                                       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                       
                                        <div class="color-preview" style="
                                            width: 50px;
                                            height: 50px;
                                            background: ${product.hex || '#8B4513'};
                                            border-radius: 50%;
                                            border: 3px solid white;
                                            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                                            flex-shrink: 0;
                                        "></div>
                                        
                                        <div class="product-details" style="flex: 1; min-width: 0;">
                                            <div class="product-code" style="
                                                color: #E91E63;
                                                font-weight: 700;
                                                font-size: 1rem;
                                                margin-bottom: 0.3rem;
                                            ">${product.code || 'N/A'}</div>
                                            
                                            <div class="product-name" style="
                                                color: #333;
                                                font-weight: 600;
                                                font-size: 0.95rem;
                                                margin-bottom: 0.3rem;
                                                word-wrap: break-word;
                                            ">${product.name || '이름 없음'}</div>
                                            
                                            <div class="product-meta" style="
                                                display: flex;
                                                gap: 0.5rem;
                                                font-size: 0.8rem;
                                                color: #666;
                                                flex-wrap: wrap;
                                            ">
                                                <span style="
                                                    background: #f8f9fa;
                                                    padding: 2px 8px;
                                                    border-radius: 12px;
                                                    border: 1px solid #e9ecef;
                                                ">${product.hex || 'N/A'}</span>
                                                
                                                ${product.line ? `
                                                    <span style="
                                                        background: #e3f2fd;
                                                        color: #1976d2;
                                                        padding: 2px 8px;
                                                        border-radius: 12px;
                                                        font-weight: 500;
                                                    ">${product.line}</span>
                                                ` : ''}
                                                
                                                ${product.sub_type ? `
                                                    <span style="
                                                        background: #f3e5f5;
                                                        color: #7b1fa2;
                                                        padding: 2px 8px;
                                                        border-radius: 12px;
                                                        font-weight: 500;
                                                    ">${product.sub_type}</span>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="brand-stats" style="
                                margin-top: 1rem;
                                padding: 1rem;
                                background: #f8f9
