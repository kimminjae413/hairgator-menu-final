<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0, viewport-fit=cover">
    <title>HAIRGATOR - 헤어스타일 메뉴판</title>
    
    <!-- PWA 메타 태그 -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    
    <!-- 파비콘 -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    
    <!-- CSS 파일들 -->
    <link rel="stylesheet" href="css/index-styles.css">
    <link rel="stylesheet" href="css/index-modal.css">
    <link rel="stylesheet" href="css/index-customer.css">
    <link rel="stylesheet" href="css/index-stats.css">
    <link rel="stylesheet" href="css/designer-profile.css">
    <link rel="stylesheet" href="css/promotion-manager.css">
    <link rel="stylesheet" href="css/kakao-notification.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body class="theme-dark">
    <!-- 동기화 상태 표시 -->
    <div id="syncStatus" class="sync-status">Firebase 연결 중...</div>
    
    <!-- 디바이스 최적화 안내 -->
    <div id="deviceNotice" class="device-notice"></div>
    
    <!-- 디자이너 로그인 화면 -->
    <div id="designerLogin" class="designer-login">
        <div class="login-card">
            <h2>💇 HAIRGATOR 로그인</h2>
            
            <form onsubmit="event.preventDefault(); handleDesignerLogin();">
                <div class="input-group">
                    <label>👤 디자이너 이름</label>
                    <input type="text" id="designerName" placeholder="이름을 입력하세요" required>
                </div>
                
                <div class="input-group">
                    <label>🔒 비밀번호</label>
                    <input type="password" id="designerPassword" placeholder="비밀번호" required>
                </div>
                
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="autoLoginEnabled">
                        <span>24시간 자동 로그인</span>
                    </label>
                </div>
                
                <button type="submit" class="login-btn">로그인</button>
            </form>
        </div>
    </div>
    
    <!-- 성별 선택 화면 -->
    <div id="genderSelection" class="gender-selection">
        <div class="gender-card male" onclick="selectGender('male')">
            <div class="gender-icon">♂</div>
            <div class="gender-title">남성</div>
            <div class="gender-subtitle">Men's Hairstyle</div>
        </div>
        
        <div class="gender-card female" onclick="selectGender('female')">
            <div class="gender-icon">♀</div>
            <div class="gender-title">여성</div>
            <div class="gender-subtitle">Women's Hairstyle</div>
        </div>
    </div>
    
    <!-- 메인 컨테이너 -->
    <div class="main-container">
        <!-- 헤더 -->
        <header class="header">
            <button class="back-btn" onclick="goBack()">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M12 16L6 10L12 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            
            <h1 class="logo-text">HAIRGATOR</h1>
            
            <button class="menu-btn" onclick="toggleHamburgerMenu()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </header>
        
        <!-- 네비게이션 탭 -->
        <nav id="navTabs" class="nav-tabs"></nav>
        
        <!-- 콘텐츠 영역 -->
        <div id="content" class="content"></div>
    </div>
    
    <!-- 햄버거 메뉴 오버레이 -->
    <div id="hamburgerOverlay" class="hamburger-overlay">
        <div id="hamburgerMenu" class="hamburger-menu">
            <div class="hamburger-header">
                <h3>메뉴</h3>
                <button class="close-btn" onclick="closeHamburgerMenu()">✕</button>
            </div>
            
            <div class="designer-info">
                <div class="designer-avatar">👤</div>
                <div class="designer-name">디자이너</div>
            </div>
            
            <div class="menu-items">
                <button class="menu-item" onclick="showCustomerList()">
                    <span class="menu-icon">👥</span>
                    <span>고객 조회</span>
                </button>
                <button class="menu-item" onclick="showStatistics()">
                    <span class="menu-icon">📊</span>
                    <span>인기 통계</span>
                </button>
                <button class="menu-item" onclick="showPromotionManagement()">
                    <span class="menu-icon">🎯</span>
                    <span>프로모션 관리</span>
                </button>
                <button class="menu-item" onclick="changeTheme()">
                    <span class="menu-icon">🎨</span>
                    <span>테마 변경</span>
                </button>
                <button class="menu-item logout" onclick="logout()">
                    <span class="menu-icon">🚪</span>
                    <span>로그아웃</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- 이미지 모달 -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <img class="modal-image" id="modalImage" src="" alt="">
            <div class="modal-info">
                <h3 id="modalCode"></h3>
                <p id="modalName"></p>
                <button class="like-btn" onclick="toggleLike()">❤️ 좋아요</button>
                <button class="customer-btn" onclick="registerCustomer()">👤 고객 등록</button>
            </div>
        </div>
    </div>
    
    <!-- JavaScript 파일들 -->
    <script src="js/firebase-config.js"></script>
    
    <!-- 메인 스크립트 (paste.txt의 완전한 코드) -->
    <script>
// ========== HAIRGATOR 메인 페이지 완전 수정 버전 ========== 
// 🚀 로그인, Firebase 연결, 데이터 로딩 모든 문제 해결
console.log('🚀 HAIRGATOR 메인 페이지 완전 수정 버전 시작');

// ========== 전역 변수 ==========
let db = null;
let storage = null;
let firebaseConnected = false;
let hierarchyStructure = {};

let currentDesigner = null;
let currentDesignerName = null;
let currentGender = null;
let currentCategory = null;
let currentCustomer = null;
let selectedStyleCode = null;
let selectedStyleName = null;
let autoLoginEnabled = false;
let currentTheme = 'dark';

// 네비게이션 데이터는 Firebase에서 동적으로 로드
let navigationData = {};

// ========== 누락된 함수들 정의 (오류 방지) ==========
window.loadNavigationOnDate = function() {
    console.log('📅 loadNavigationOnDate 호출됨 (비활성화됨)');
};

window.navigationOnData = null;

window.showPromotionManagement = function() {
    console.log('🎯 프로모션 관리 기능은 현재 비활성화되었습니다');
    alert('프로모션 관리 기능은 현재 준비 중입니다');
};

window.showCustomerList = function() {
    console.log('👥 고객 조회 기능');
    alert('고객 조회 기능은 현재 준비 중입니다');
};

window.showStatistics = function() {
    console.log('📊 통계 기능');
    alert('통계 기능은 현재 준비 중입니다');
};

window.toggleLike = function() {
    console.log('❤️ 좋아요 기능');
};

window.registerCustomer = function() {
    console.log('👤 고객 등록 기능');
    alert('고객 등록 기능은 현재 준비 중입니다');
};

window.logout = function() {
    if (confirm('정말 로그아웃하시겠습니까?')) {
        localStorage.removeItem('hairgator_auto_login');
        location.reload();
    }
};

// ========== Firebase 초기화 및 연결 강화 ==========
async function initializeFirebase() {
    try {
        console.log('🔥 Firebase 초기화 시작...');
        updateSyncStatus('connecting', '🔄 Firebase 연결 중...');
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
            console.log('✅ Firebase 앱 초기화 완료');
        } else {
            console.log('✅ Firebase 앱 이미 초기화됨');
        }

        db = firebase.firestore();
        storage = firebase.storage();

        // 오프라인 지원 활성화
        try {
            await db.enablePersistence({ synchronizeTabs: true });
            console.log('✅ Firebase 오프라인 지원 활성화');
        } catch (err) {
            if (err.code === 'failed-precondition') {
                console.log('⚠️ 다중 탭에서 실행 중');
            } else if (err.code === 'unimplemented') {
                console.log('⚠️ 브라우저가 오프라인 지원하지 않음');
            }
        }

        // 연결 테스트
        await testFirebaseConnection();
        
        firebaseConnected = true;
        window.firebaseConnected = true;
        updateSyncStatus('connected', '✅ Firebase 연결 완료');
        
        console.log('✅ Firebase 초기화 완료');
        
    } catch (error) {
        console.error('❌ Firebase 초기화 실패:', error);
        firebaseConnected = false;
        updateSyncStatus('disconnected', '❌ Firebase 연결 실패');
        throw error;
    }
}

async function testFirebaseConnection() {
    try {
        const testDoc = db.collection('test').doc('connection');
        await testDoc.set({
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            test: true
        });
        
        await testDoc.delete();
        console.log('✅ Firebase 연결 테스트 성공');
        
    } catch (error) {
        console.error('❌ Firebase 연결 테스트 실패:', error);
        
        if (error.code === 'permission-denied') {
            throw new Error('Firebase Security Rules에서 권한이 거부되었습니다');
        } else if (error.code === 'unavailable') {
            throw new Error('Firebase 서비스를 일시적으로 사용할 수 없습니다');
        }
        
        throw error;
    }
}

// ========== 계층구조 로드 (핵심 수정) ==========
async function loadHierarchyFromFirebase(gender) {
    console.log(`🔄 ${gender} 계층구조 로드 시작...`);
    
    if (!firebaseConnected) {
        console.log('❌ Firebase 연결 없음');
        showEmptyState('Firebase 연결이 필요합니다');
        return;
    }

    try {
        updateSyncStatus('loading', `🔄 ${gender} 데이터 로드 중...`);
        
        const query = db.collection('category_hierarchy')
                       .where('gender', '==', gender);
        
        const snapshot = await query.get();
        
        if (snapshot.empty) {
            console.log(`❌ ${gender} 데이터가 비어있습니다 - 어드민 초기화 필요`);
            showAdminRequiredMessage();
            return;
        }
        
        const hierarchyData = {};
        let docCount = 0;
        
        snapshot.forEach(doc => {
            const data = doc.data();
            console.log(`📄 문서 ${docCount + 1}:`, data);
            
            const mainCat = data.mainCategory;
            const subCat = data.subCategory;
            
            if (!hierarchyData[mainCat]) {
                hierarchyData[mainCat] = [];
            }
            
            if (!hierarchyData[mainCat].includes(subCat)) {
                hierarchyData[mainCat].push(subCat);
            }
            
            docCount++;
        });
        
        console.log(`✅ ${gender} 계층구조 로드 완료:`, hierarchyData);
        console.log(`📊 총 ${docCount}개 문서, ${Object.keys(hierarchyData).length}개 대분류`);
        
        // 전역 변수에 저장
        hierarchyStructure[gender] = hierarchyData;
        navigationData[gender] = Object.keys(hierarchyData);
        
        // UI 업데이트
        renderMainCategoryTabs(Object.keys(hierarchyData));
        
        if (Object.keys(hierarchyData).length > 0) {
            const firstCategory = Object.keys(hierarchyData)[0];
            currentCategory = firstCategory;
            await loadStylesFromHierarchy(firstCategory);
        }
        
        updateSyncStatus('connected', `✅ ${gender} 데이터 로드 완료 (${docCount}개)`);
        
    } catch (error) {
        console.error(`❌ ${gender} 계층구조 로드 실패:`, error);
        
        if (error.code === 'failed-precondition') {
            showAdminRequiredMessage();
            updateSyncStatus('updating', '🔄 Firebase 인덱스 생성 중...');
        } else if (error.code === 'permission-denied') {
            showAdminRequiredMessage();
            updateSyncStatus('disconnected', '❌ 권한 오류');
        } else {
            showAdminRequiredMessage();
            updateSyncStatus('disconnected', '❌ 데이터 로드 실패');
        }
    }
}

// ========== 스타일 로드 (핵심 수정) ==========
async function loadStylesFromHierarchy(mainCategory) {
    console.log(`=== 🎨 헤어스타일 로드: ${currentGender}, ${mainCategory} ===`);
    
    const content = document.getElementById('content');
    if (content) {
        content.innerHTML = '<div class="loading-spinner">🔄 로딩 중...</div>';
    }
    
    if (!firebaseConnected) {
        console.log('❌ Firebase 연결 없음');
        showEmptyState('Firebase 연결이 필요합니다');
        return;
    }

    try {
        const subCategories = hierarchyStructure[currentGender]?.[mainCategory] || [];
        console.log(`📂 중분류 목록: ${subCategories.join(', ')}`);
        
        if (subCategories.length === 0) {
            console.log('⚠️ 중분류가 없음');
            showEmptyState('중분류가 설정되지 않았습니다');
            return;
        }

        // 중분류별로 스타일 로드
        const allStyles = {};
        
        for (const subCategory of subCategories) {
            console.log(`🔍 ${subCategory} 스타일 조회 중...`);
            
            const stylesQuery = db.collection('hairstyles')
                .where('gender', '==', currentGender)
                .where('mainCategory', '==', mainCategory)
                .where('subCategory', '==', subCategory)
                .orderBy('createdAt', 'desc')
                .limit(50);

            try {
                const stylesSnapshot = await stylesQuery.get();
                
                if (!stylesSnapshot.empty) {
                    const styles = [];
                    stylesSnapshot.forEach(doc => {
                        styles.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    allStyles[subCategory] = styles;
                    console.log(`✅ ${subCategory}: ${styles.length}개 스타일 로드됨`);
                } else {
                    console.log(`⚠️ ${subCategory}: 스타일 없음`);
                    allStyles[subCategory] = [];
                }
            } catch (styleError) {
                console.log(`⚠️ ${subCategory} 스타일 조회 오류:`, styleError);
                allStyles[subCategory] = [];
            }
        }

        // UI 렌더링
        renderCategoryContent(mainCategory, subCategories, allStyles);
        
        const totalStyles = Object.values(allStyles).reduce((sum, styles) => sum + styles.length, 0);
        updateSyncStatus('connected', `✅ ${mainCategory} 로드 완료 (${totalStyles}개)`);
        
    } catch (error) {
        console.error('❌ 스타일 로드 실패:', error);
        showEmptyState(`스타일 로드 실패: ${error.message}`);
        updateSyncStatus('disconnected', '❌ 스타일 로드 실패');
    }
}

// ========== UI 렌더링 ==========
function renderMainCategoryTabs(mainCategories) {
    const navTabs = document.getElementById('navTabs');
    if (!navTabs) return;
    
    navTabs.innerHTML = '';
    
    if (!mainCategories || mainCategories.length === 0) {
        navTabs.innerHTML = '<div style="color: #666; padding: 20px;">카테고리를 불러올 수 없습니다.</div>';
        return;
    }
    
    // 성별별 카테고리 순서
    const categoryOrder = {
        male: ['SIDE FRINGE', 'SIDE PART', 'FRINGE UP', 'PUSHED BACK', 'BUZZ', 'CROP', 'MOHICAN'],
        female: ['A Length', 'B Length', 'C Length', 'D Length', 'E Length', 'F Length', 'G Length', 'H Length']
    };
    
    const orderedCategories = categoryOrder[currentGender] || mainCategories;
    
    orderedCategories.forEach((mainCategory, index) => {
        if (mainCategories.includes(mainCategory)) {
            const tab = document.createElement('div');
            tab.className = index === 0 ? 'nav-tab active' : 'nav-tab';
            tab.dataset.category = mainCategory;
            tab.textContent = mainCategory;
            tab.onclick = () => switchCategory(mainCategory);
            navTabs.appendChild(tab);
        }
    });
}

function renderCategoryContent(mainCategory, subCategories, allStyles) {
    const content = document.getElementById('content');
    if (!content) return;
    
    let html = `
        <div class="category-description">
            ${getCategoryDescription(mainCategory)}
        </div>
        <div class="length-tabs">
    `;
    
    // 길이 탭 생성
    subCategories.forEach((subCategory, index) => {
        const styleCount = allStyles[subCategory]?.length || 0;
        html += `
            <div class="length-tab ${index === 0 ? 'active' : ''}" 
                 data-length="${subCategory}"
                 onclick="switchLengthTab('${subCategory}', '${mainCategory}')">
                ${subCategory} (${styleCount})
            </div>
        `;
    });
    
    html += `
        </div>
        <div class="hairstyles-container" id="stylesContainer">
    `;
    
    // 첫 번째 서브카테고리의 스타일 표시
    const firstSubCategory = subCategories[0];
    const firstStyles = allStyles[firstSubCategory] || [];
    
    html += renderStyleGrid(firstStyles);
    html += '</div>';
    
    content.innerHTML = html;
    
    // 전역 변수에 저장 (탭 전환 시 사용)
    window.currentAllStyles = allStyles;
}

function renderStyleGrid(styles) {
    if (!styles || styles.length === 0) {
        return `
            <div class="empty-state">
                <div class="empty-state-icon">✂️</div>
                <div class="empty-state-title">등록된 스타일이 없습니다</div>
                <div class="empty-state-message">새로운 헤어스타일이 곧 추가될 예정입니다</div>
            </div>
        `;
    }
    
    return `
        <div class="hairstyle-grid">
            ${styles.map(style => `
                <div class="hairstyle-card" onclick="openStyleModal('${style.code}', '${style.name}', '${style.imageUrl}')">
                    <img src="${style.imageUrl}" 
                         alt="${style.name}" 
                         class="hairstyle-image"
                         onerror="this.src='images/no-image.png'">
                    <div class="hairstyle-info">
                        <div class="hairstyle-code">${style.code}</div>
                        <div class="hairstyle-name">${style.name}</div>
                        <div class="hairstyle-views">👀 ${style.views || 0}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// ========== 탭 전환 ==========
function switchCategory(categoryId) {
    if (categoryId === currentCategory) return;
    
    console.log(`🔄 카테고리 전환: ${categoryId}`);
    
    // 탭 활성화
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.category === categoryId) {
            tab.classList.add('active');
        }
    });
    
    currentCategory = categoryId;
    loadStylesFromHierarchy(categoryId);
}

function switchLengthTab(subCategory, mainCategory) {
    console.log(`🔄 길이 탭 전환: ${subCategory}`);
    
    // 탭 활성화
    document.querySelectorAll('.length-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.length === subCategory) {
            tab.classList.add('active');
        }
    });
    
    // 해당 길이의 스타일 표시
    const container = document.getElementById('stylesContainer');
    if (container) {
        const styles = window.currentAllStyles?.[subCategory] || [];
        container.innerHTML = renderStyleGrid(styles);
    }
}

// ========== 24시간 자동 로그인 시스템 ========== 
function checkAutoLogin() {
    console.log('🔍 자동 로그인 확인 중...');
    
    const autoLoginData = localStorage.getItem('hairgator_auto_login');
    
    if (autoLoginData) {
        try {
            const loginData = JSON.parse(autoLoginData);
            const currentTime = new Date().getTime();
            
            // 24시간 체크 (86400000ms = 24시간)
            if (currentTime - loginData.timestamp < 86400000) {
                console.log('✅ 자동 로그인 유효:', loginData.designer);
                
                currentDesigner = loginData.designer;
                currentDesignerName = loginData.name;
                autoLoginEnabled = true;
                
                updateDesignerDisplay();
                hideDesignerLogin();
                showGenderSelection();
                
                return true;
            } else {
                console.log('⏰ 자동 로그인 만료됨');
                localStorage.removeItem('hairgator_auto_login');
            }
        } catch (error) {
            console.error('자동 로그인 데이터 파싱 오류:', error);
            localStorage.removeItem('hairgator_auto_login');
        }
    }
    
    return false;
}

function saveAutoLogin(designer, name) {
    const loginData = {
        designer: designer,
        name: name,
        timestamp: new Date().getTime()
    };
    
    localStorage.setItem('hairgator_auto_login', JSON.stringify(loginData));
    console.log('💾 자동 로그인 설정 저장됨');
}

// ========== 디자이너 로그인 ==========
async function handleDesignerLogin() {
    const designerInput = document.getElementById('designerName');
    const passwordInput = document.getElementById('designerPassword');
    const autoLoginCheckbox = document.getElementById('autoLoginEnabled');
    
    if (!designerInput || !passwordInput) {
        alert('입력 필드를 찾을 수 없습니다');
        return;
    }
    
    const designer = designerInput.value.trim();
    const password = passwordInput.value.trim();
    
    if (!designer || !password) {
        alert('디자이너 이름과 비밀번호를 모두 입력해주세요');
        return;
    }
    
    try {
        console.log('🔐 디자이너 로그인 시도:', designer);
        
        // 로그인 버튼 비활성화
        const loginBtn = document.querySelector('button[type="submit"]');
        if (loginBtn) {
            loginBtn.disabled = true;
            loginBtn.textContent = '로그인 중...';
        }
        
        currentDesigner = designer.toLowerCase().replace(/\s+/g, '');
        currentDesignerName = designer;
        
        // 24시간 자동 로그인 설정
        if (autoLoginCheckbox && autoLoginCheckbox.checked) {
            autoLoginEnabled = true;
            saveAutoLogin(currentDesigner, currentDesignerName);
        }
        
        console.log('✅ 로그인 성공:', currentDesignerName);
        
        updateDesignerDisplay();
        hideDesignerLogin();
        showGenderSelection();
        
        // 폼 초기화
        designerInput.value = '';
        passwordInput.value = '';
        if (autoLoginCheckbox) autoLoginCheckbox.checked = false;
        
    } catch (error) {
        console.error('로그인 오류:', error);
        alert('로그인 처리 중 오류가 발생했습니다');
    } finally {
        // 로그인 버튼 복원
        const loginBtn = document.querySelector('button[type="submit"]');
        if (loginBtn) {
            loginBtn.disabled = false;
            loginBtn.textContent = '로그인';
        }
    }
}

// ========== 성별 선택 ========== 
function selectGender(gender) {
    currentGender = gender;
    console.log('👤 성별 선택됨:', gender);
    
    // 선택된 성별 저장
    localStorage.setItem('selectedGender', gender);
    
    // UI 업데이트
    document.getElementById('genderSelection').style.display = 'none';
    
    const mainContainer = document.querySelector('.main-container');
    if (mainContainer) {
        mainContainer.classList.add('active');
        mainContainer.classList.remove('male', 'female');
        mainContainer.classList.add(gender);
    }
    
    // 성별별 색상 테마 적용
    applyGenderTheme(gender);
    
    // 해당 성별의 계층구조 로드
    loadHierarchyFromFirebase(gender);
}

// ========== 테마 시스템 ==========
function initializeThemeSystem() {
    const savedTheme = localStorage.getItem('hairgator_theme') || 'dark';
    applyTheme(savedTheme);
}

function applyTheme(theme) {
    console.log('🎨 테마 적용:', theme);
    currentTheme = theme;
    
    document.body.className = `theme-${theme}`;
    
    const themeColors = {
        'dark': '#000000',
        'gray': '#939597', 
        'light': '#E6DCD3'
    };
    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    if (metaTheme) {
        metaTheme.content = themeColors[theme];
    }
    
    localStorage.setItem('hairgator_theme', theme);
}

function changeTheme() {
    const themes = ['dark', 'gray', 'light'];
    const currentIndex = themes.indexOf(currentTheme);
    const nextIndex = (currentIndex + 1) % themes.length;
    const nextTheme = themes[nextIndex];
    
    applyTheme(nextTheme);
    
    document.body.style.transition = 'all 0.3s ease';
    
    console.log(`🎨 테마 변경: ${currentTheme} → ${nextTheme}`);
}

// ========== 성별별 색상 테마 ==========
function applyGenderTheme(gender) {
    const root = document.documentElement;
    
    if (gender === 'male') {
        root.style.setProperty('--active-color', 'var(--male-primary)');
        root.style.setProperty('--active-gradient', 'var(--male-gradient)');
    } else {
        root.style.setProperty('--active-color', 'var(--female-primary)');
        root.style.setProperty('--active-gradient', 'var(--female-gradient)');
    }
    
    console.log('🎨 성별 테마 적용됨:', gender);
}

// ========== 스타일 모달 ==========
function openStyleModal(code, name, imageUrl) {
    selectedStyleCode = code;
    selectedStyleName = name;
    
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalCode = document.getElementById('modalCode');
    const modalName = document.getElementById('modalName');
    
    if (modal && modalImage && modalCode && modalName) {
        modalImage.src = imageUrl;
        modalCode.textContent = code;
        modalName.textContent = name;
        modal.style.display = 'block';
        
        console.log('📸 스타일 모달 열림:', code, name);
        
        // 조회수 증가
        if (firebaseConnected) {
            incrementStyleViews(code);
        }
    }
}

function closeStyleModal() {
    const modal = document.getElementById('imageModal');
    if (modal) {
        modal.style.display = 'none';
    }
    selectedStyleCode = null;
    selectedStyleName = null;
}

async function incrementStyleViews(styleCode) {
    try {
        const styleSnapshot = await db.collection('hairstyles')
            .where('code', '==', styleCode)
            .limit(1)
            .get();
            
        if (!styleSnapshot.empty) {
            const styleDoc = styleSnapshot.docs[0];
            const currentViews = styleDoc.data().views || 0;
            
            await styleDoc.ref.update({
                views: currentViews + 1,
                lastViewedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            console.log(`📈 조회수 증가: ${styleCode} (${currentViews + 1})`);
        }
    } catch (error) {
        console.error('조회수 업데이트 오류:', error);
    }
}

// ========== 햄버거 메뉴 ==========
function toggleHamburgerMenu() {
    const overlay = document.getElementById('hamburgerOverlay');
    const menu = document.getElementById('hamburgerMenu');
    
    if (!overlay || !menu) {
        console.error('햄버거 메뉴 요소를 찾을 수 없음');
        return;
    }
    
    if (overlay.style.display === 'block') {
        closeHamburgerMenu();
    } else {
        overlay.style.display = 'block';
        requestAnimationFrame(() => {
            menu.style.transform = 'translateX(0)';
        });
    }
}

function closeHamburgerMenu() {
    const overlay = document.getElementById('hamburgerOverlay');
    const menu = document.getElementById('hamburgerMenu');
    
    if (menu) {
        menu.style.transform = 'translateX(100%)';
    }
    
    setTimeout(() => {
        if (overlay) {
            overlay.style.display = 'none';
        }
    }, 300);
}

// ========== 뒤로가기 ==========
function goBack() {
    const mainContainer = document.querySelector('.main-container');
    
    if (mainContainer && mainContainer.classList.contains('active')) {
        mainContainer.classList.remove('active');
        showGenderSelection();
    } else if (document.getElementById('genderSelection').style.display === 'flex') {
        showDesignerLogin();
        currentDesigner = null;
        currentDesignerName = null;
        
        if (autoLoginEnabled) {
            localStorage.removeItem('hairgator_auto_login');
            autoLoginEnabled = false;
        }
    }
}

// ========== 유틸리티 함수 ==========
function showDesignerLogin() {
    const loginElement = document.getElementById('designerLogin');
    const genderElement = document.getElementById('genderSelection');
    const mainContainer = document.querySelector('.main-container');
    
    if (loginElement) loginElement.style.display = 'flex';
    if (genderElement) genderElement.style.display = 'none';
    if (mainContainer) mainContainer.classList.remove('active');
}

function hideDesignerLogin() {
    const loginElement = document.getElementById('designerLogin');
    if (loginElement) loginElement.style.display = 'none';
}

function showGenderSelection() {
    const genderElement = document.getElementById('genderSelection');
    const mainContainer = document.querySelector('.main-container');
    
    if (genderElement) genderElement.style.display = 'flex';
    if (mainContainer) mainContainer.classList.remove('active');
    
    showDeviceOptimizationNotice('👥 고객의 성별을 선택해주세요');
}

function updateDesignerDisplay() {
    const designerNameElements = document.querySelectorAll('.designer-name');
    designerNameElements.forEach(element => {
        if (element) {
            element.textContent = currentDesignerName || '디자이너';
        }
    });
}

function showEmptyState(message) {
    const content = document.getElementById('content');
    if (content) {
        content.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">⚠️</div>
                <div class="empty-state-title">데이터를 불러올 수 없습니다</div>
                <div class="empty-state-message">${message}</div>
            </div>
        `;
    }
}

function showAdminRequiredMessage() {
    const content = document.getElementById('content');
    const navTabs = document.getElementById('navTabs');
    
    if (navTabs) {
        navTabs.innerHTML = `
            <div style="color: #FF69B4; padding: 15px; text-align: center; width: 100%;">
                🔧 어드민 초기화 필요
            </div>
        `;
    }
    
    if (content) {
        content.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">🔧</div>
                <div class="empty-state-title">어드민에서 데이터를 초기화해주세요</div>
                <div class="empty-state-message">
                    <strong>해결 방법:</strong><br><br>
                    1. <a href="/admin.html" target="_blank" style="color: #FF1493;">어드민 페이지</a>로 이동<br>
                    2. "🚀 초기화 실행" 버튼 클릭<br>
                    3. 이 페이지 새로고침<br><br>
                </div>
            </div>
        `;
    }
}

function updateSyncStatus(status, message) {
    const syncStatus = document.getElementById('syncStatus');
    if (syncStatus) {
        syncStatus.textContent = message;
        syncStatus.className = 'sync-status ' + status;

        if (status === 'connected') {
            setTimeout(() => {
                syncStatus.style.opacity = '0';
            }, 3000);
        } else {
            syncStatus.style.opacity = '1';
        }
    }
    
    console.log(`🔄 동기화 상태: ${status} - ${message}`);
}

function getCategoryDescription(category) {
    const descriptions = {
        // 남성 카테고리
        'MOHICAN': '모히칸은 옆머리를 짧게 하고 윗머리를 높이 세운, 개성 있는 스타일입니다.',
        'BUZZ': '버즈컷은 전체적으로 짧고 깔끔한 스타일이며, 간편하게 관리할 수 있습니다.',
        'SIDE PART': '사이드 파트는 클래식한 느낌으로 다양한 이미지를 연출할 수 있습니다.',
        'SIDE FRINGE': '사이드 프린지는 한쪽으로 넘긴 앞머리가 특징인 스타일입니다.',
        'FRINGE UP': '프린지 업은 앞머리를 위로 올린 깔끔한 스타일입니다.',
        'PUSHED BACK': '푸시드 백은 머리 전체를 뒤로 넘긴 세련된 스타일입니다.',
        'CROP': '크롭은 짧고 텍스처가 있는 모던한 스타일입니다.',
        
        // 여성 카테고리 (A~H Length)
        'A Length': '가슴 아래까지 내려오는 매우 긴 길이입니다. 여성스럽고 우아한 느낌을 연출합니다.',
        'B Length': '가슴선 정도의 긴 길이입니다. 다양한 스타일링이 가능합니다.',
        'C Length': '어깨 아래 10cm 정도의 세미롱 길이입니다. 관리가 편하면서도 여성스럽습니다.',
        'D Length': '어깨선 정도의 미디엄 길이입니다. 실용적이면서 스타일리시합니다.',
        'E Length': '어깨 위 5cm 정도의 짧은 미디엄 길이입니다. 활동적이고 경쾌한 느낌을 줍니다.',
        'F Length': '턱선 정도의 보브 길이입니다. 모던하고 세련된 이미지를 연출합니다.',
        'G Length': '턱 위 5cm 정도의 짧은 보브 길이입니다. 시크하고 도시적인 느낌을 줍니다.',
        'H Length': '귀 정도의 매우 짧은 길이입니다. 개성 있고 보이시한 스타일입니다.'
    };
    
    return descriptions[category] || '다양한 헤어스타일을 확인해보세요.';
}

// ========== 기기 최적화 ==========
function detectDeviceAndShowNotice() {
    const userAgent = navigator.userAgent.toLowerCase();
    
    if (/iphone|ipad|ipod/.test(userAgent)) {
        console.log('📱 iOS 기기 감지됨');
        document.body.classList.add('ios-device');
        hideAddressBar();
    }
    
    if (/android/.test(userAgent)) {
        console.log('🤖 Android 기기 감지됨');
        document.body.classList.add('android-device');
    }
    
    preventPullToRefresh();
    
    if (window.matchMedia('(display-mode: standalone)').matches || 
        window.navigator.standalone === true) {
        console.log('📱 PWA 모드로 실행 중');
        showDeviceOptimizationNotice('📱 PWA 모드로 실행 중입니다');
    }
}

function showDeviceOptimizationNotice(customMessage = null) {
    const notice = document.getElementById('deviceNotice');
    if (!notice) return;
    
    if (customMessage) {
        notice.innerHTML = customMessage;
        notice.className = 'device-notice show';
        setTimeout(() => {
            notice.classList.remove('show');
        }, 5000);
        return;
    }
    
    notice.innerHTML = '📱 모든 기기에서 가로 스와이프로 스타일을 확인하세요';
    notice.className = 'device-notice show';
    
    setTimeout(() => {
        notice.classList.remove('show');
    }, 5000);
}

function hideAddressBar() {
    setTimeout(function() {
        window.scrollTo(0, 1);
    }, 0);
}

function preventPullToRefresh() {
    document.addEventListener('gesturestart', function(e) {
        e.preventDefault();
    });
    
    document.addEventListener('gesturechange', function(e) {
        e.preventDefault();
    });
    
    document.addEventListener('gestureend', function(e) {
        e.preventDefault();
    });
    
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
    
    let startY = 0;
    let startX = 0;
    
    document.addEventListener('touchstart', function(e) {
        startY = e.touches[0].pageY;
        startX = e.touches[0].pageX;
    }, { passive: true });
    
    document.addEventListener('touchmove', function(e) {
        const y = e.touches[0].pageY;
        const x = e.touches[0].pageX;
        const deltaY = y - startY;
        const deltaX = x - startX;
        
        if (window.scrollY === 0 && deltaY > 0 && Math.abs(deltaY) > Math.abs(deltaX)) {
            e.preventDefault();
        }
    }, { passive: false });
    
    document.body.addEventListener('touchmove', function(e) {
        if (window.scrollY === 0 && e.touches[0].pageY > startY) {
            e.preventDefault();
        }
    }, { passive: false });
}

// ========== 이벤트 리스너 설정 ==========
function setupEventListeners() {
    // 모달 이벤트
    const modal = document.getElementById('imageModal');
    if (modal) {
        const closeBtn = modal.querySelector('.close');
        if (closeBtn) {
            closeBtn.onclick = closeStyleModal;
        }
        
        modal.onclick = function(e) {
            if (e.target === modal) {
                closeStyleModal();
            }
        };
    }
    
    // 햄버거 메뉴 이벤트
    const overlay = document.getElementById('hamburgerOverlay');
    if (overlay) {
        overlay.onclick = closeHamburgerMenu;
    }
    
    // ESC 키 이벤트
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (modal && modal.style.display === 'block') {
                closeStyleModal();
            }
            if (overlay && overlay.style.display === 'block') {
                closeHamburgerMenu();
            }
        }
    });
}

// ========== 페이지 초기화 ========== 
document.addEventListener('DOMContentLoaded', async function() {
    console.log('📱 DOM 로드 완료, HAIRGATOR 메인 페이지 초기화 시작');
    
    try {
        // Firebase 초기화 먼저
        await initializeFirebase();
        
        // 자동 로그인 확인
        if (checkAutoLogin()) {
            return; // 자동 로그인 성공 시 더 이상 진행하지 않음
        }
        
        // 일반 로그인 화면 표시
        showDesignerLogin();
        
        // 테마 시스템 초기화
        initializeThemeSystem();
        
        // 디바이스 감지 및 안내
        detectDeviceAndShowNotice();
        
        // 이벤트 리스너 등록
        setupEventListeners();
        
        console.log('✅ HAIRGATOR 메인 페이지 초기화 완료');
        
    } catch (error) {
        console.error('❌ 메인 페이지 초기화 실패:', error);
        updateSyncStatus('disconnected', '❌ 초기화 실패');
        showEmptyState('시스템 초기화에 실패했습니다. 페이지를 새로고침해주세요.');
    }
});

// ========== 전역 함수 등록 ==========
window.handleDesignerLogin = handleDesignerLogin;
window.selectGender = selectGender;
window.switchCategory = switchCategory;
window.switchLengthTab = switchLengthTab;
window.openStyleModal = openStyleModal;
window.closeStyleModal = closeStyleModal;
window.toggleHamburgerMenu = toggleHamburgerMenu;
window.closeHamburgerMenu = closeHamburgerMenu;
window.changeTheme = changeTheme;
window.goBack = goBack;

// 디버그 함수들
window.forceInitializeDataStructure = () => {
    if (currentGender) {
        loadHierarchyFromFirebase(currentGender);
    } else {
        console.log('성별을 먼저 선택해주세요');
    }
};

window.debugMainPage = {
    checkFirebase: () => {
        console.log('Firebase 연결 상태:', firebaseConnected);
        console.log('DB 인스턴스:', db);
        console.log('Storage 인스턴스:', storage);
    },
    
    showData: () => {
        console.log('현재 계층구조:', hierarchyStructure);
        console.log('네비게이션 데이터:', navigationData);
    },
    
    getCurrentState: () => {
        console.log('현재 상태:', {
            designer: currentDesigner,
            gender: currentGender,
            category: currentCategory,
            firebaseConnected: firebaseConnected
        });
    }
};

console.log('🎯 HAIRGATOR 메인 페이지 완전 수정 버전 로드 완료!');
    </script>
</body>
</html>
