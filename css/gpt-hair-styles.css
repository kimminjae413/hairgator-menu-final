// ==========================================
// HAIRGATOR GPT - 브라우저 호환 파일 선택 최종 해결
// js/gpt-hair-experience.js
// ==========================================

console.log('GPT 브라우저 호환 버전 로드');

window.HAIRGATOR_GPT = {
    isProcessing: false,
    currentStyle: null,
    userPhoto: null,
    currentMethod: 'upload',
    apiEndpoint: '/.netlify/functions/openai-proxy'
};

// 브라우저 호환 모달 HTML - 파일 입력을 직접 클릭 가능하게 변경
function createWorkingGPTModalHTML(style) {
    return `
    <div class="gpt-hair-style-modal" id="gptHairStyleModal">
        <div class="gpt-modal-container tablet-optimized">
            <div class="gpt-modal-header">
                <h2>
                    <span class="header-icon">🎨</span>
                    GPT Image 1 헤어체험
                    <span class="gpt-badge">NEW</span>
                </h2>
                <button class="close-btn" onclick="closeGPTHairStyleModal()">×</button>
            </div>
            
            <div class="gpt-modal-content tablet-layout">
                <div class="left-column">
                    <div class="selected-style-info compact">
                        <h4>🎯 선택된 헤어스타일</h4>
                        <div class="style-preview horizontal">
                            <img src="${style.imageUrl}" alt="${style.name}" class="style-reference-image small">
                            <div class="style-details">
                                <h3>${style.name}</h3>
                                <p class="style-code">${style.code}</p>
                                <p class="style-category">${style.mainCategory} > ${style.subCategory}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="experience-method-selection">
                        <h4>📸 체험 방법 선택</h4>
                        <div class="method-options">
                            <label class="method-option active" id="uploadMethodLabel">
                                <input type="radio" name="method" value="upload" checked style="display: none;">
                                <div class="method-icon">📁</div>
                                <div class="method-title">사진 업로드</div>
                                <div class="method-description">갤러리에서 사진 선택</div>
                            </label>
                            <label class="method-option" id="cameraMethodLabel">
                                <input type="radio" name="method" value="camera" style="display: none;">
                                <div class="method-icon">📷</div>
                                <div class="method-title">카메라 촬영</div>
                                <div class="method-description">새로 사진 촬영</div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 핵심 수정: 파일 입력을 라벨로 감싸서 직접 클릭 가능하게 -->
                    <div class="photo-upload-section compact" id="photoUploadSection">
                        <h4 id="uploadSectionTitle">📷 사진 선택</h4>
                        
                        <div class="upload-area tablet-size" id="uploadArea">
                            <div class="upload-placeholder" id="uploadPlaceholder">
                                <div class="upload-icon" id="uploadIcon">📁</div>
                                <p id="uploadText">사진을 선택하거나 아래 버튼을 클릭하세요</p>
                                
                                <!-- 직접 클릭 가능한 파일 입력들 -->
                                <label class="upload-btn tablet-btn" id="galleryLabel" style="display: inline-block;">
                                    <input type="file" id="galleryInput" accept="image/*" style="display: none;">
                                    사진 선택하기
                                </label>
                                
                                <label class="upload-btn tablet-btn" id="cameraLabel" style="display: none;">
                                    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                                    사진 촬영하기
                                </label>
                            </div>
                            
                            <div class="photo-preview" id="photoPreview" style="display: none;">
                                <img id="previewImage" alt="미리보기">
                                <label class="change-photo-btn" id="changeLabel">
                                    <input type="file" id="changeInput" accept="image/*" style="display: none;">
                                    다른 사진 선택
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="gpt-options-section compact">
                        <h4>⚙️ 옵션</h4>
                        <div class="option-toggles tablet-toggles">
                            <label class="option-toggle">
                                <input type="checkbox" id="colorMatchOption" checked>
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">피부톤 맞춤</span>
                            </label>
                            <label class="option-toggle">
                                <input type="checkbox" id="enhanceQualityOption">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">고품질</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="right-column">
                    <div class="processing-status tablet-processing" id="processingStatus" style="display: none;">
                        <div class="processing-animation">
                            <div class="processing-spinner"></div>
                            <p id="processingText">AI가 헤어스타일을 적용하고 있습니다...</p>
                        </div>
                    </div>
                    
                    <div class="result-section tablet-result" id="resultSection" style="display: none;">
                        <h4>✨ 변환 결과</h4>
                        <div class="result-comparison tablet-comparison">
                            <div class="result-item">
                                <p>원본</p>
                                <img id="originalResult" alt="원본 사진">
                            </div>
                            <div class="result-arrow">→</div>
                            <div class="result-item">
                                <p>변환 후</p>
                                <img id="styledResult" alt="스타일 적용 후">
                            </div>
                        </div>
                        <div class="result-actions tablet-actions">
                            <button type="button" class="result-btn secondary" onclick="downloadResult()">
                                💾 다운로드
                            </button>
                            <button type="button" class="result-btn primary" onclick="shareResult()">
                                📤 공유하기
                            </button>
                        </div>
                    </div>
                    
                    <div class="start-guide" id="startGuide">
                        <div class="guide-content">
                            <div class="guide-icon">🎨</div>
                            <h3>AI 헤어스타일 체험</h3>
                            <p>왼쪽에서 사진을 업로드하고<br>AI 체험 시작 버튼을 눌러주세요</p>
                            <div class="guide-steps">
                                <div class="step">1️⃣ 체험 방법 선택</div>
                                <div class="step">2️⃣ 사진 업로드</div>
                                <div class="step">3️⃣ AI 체험 시작</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="gpt-modal-actions tablet-actions">
                <button type="button" class="gpt-action-btn secondary tablet-btn" onclick="closeGPTHairStyleModal()">
                    취소
                </button>
                <button type="button" class="gpt-action-btn primary tablet-btn" id="startProcessBtn" onclick="startGPTProcessing()" disabled>
                    🎨 AI 체험 시작
                </button>
            </div>
        </div>
    </div>`;
}

function openGPTHairStyleModal(style) {
    console.log('GPT 헤어스타일 모달 열기:', style);
    
    removeGPTModal();
    window.HAIRGATOR_GPT.currentStyle = style;
    window.HAIRGATOR_GPT.currentMethod = 'upload';
    
    const modalHTML = createWorkingGPTModalHTML(style);
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => {
        const modal = document.getElementById('gptHairStyleModal');
        if (modal) {
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
    }, 100);
    
    setTimeout(() => {
        setupWorkingEvents();
    }, 150);
}

function setupWorkingEvents() {
    console.log('브라우저 호환 이벤트 설정...');
    
    // 방법 선택 라디오 버튼
    const uploadMethod = document.querySelector('input[name="method"][value="upload"]');
    const cameraMethod = document.querySelector('input[name="method"][value="camera"]');
    const uploadMethodLabel = document.getElementById('uploadMethodLabel');
    const cameraMethodLabel = document.getElementById('cameraMethodLabel');
    
    const galleryLabel = document.getElementById('galleryLabel');
    const cameraLabel = document.getElementById('cameraLabel');
    
    // 방법 선택 이벤트
    if (uploadMethod && cameraMethod) {
        uploadMethod.addEventListener('change', function() {
            if (this.checked) {
                selectWorkingMethod('upload');
            }
        });
        
        cameraMethod.addEventListener('change', function() {
            if (this.checked) {
                selectWorkingMethod('camera');
            }
        });
    }
    
    // 라벨 클릭으로 방법 변경
    if (uploadMethodLabel) {
        uploadMethodLabel.addEventListener('click', function() {
            selectWorkingMethod('upload');
        });
    }
    
    if (cameraMethodLabel) {
        cameraMethodLabel.addEventListener('click', function() {
            selectWorkingMethod('camera');
        });
    }
    
    // 파일 선택 이벤트 (라벨 내부의 input)
    const galleryInput = document.getElementById('galleryInput');
    const cameraInput = document.getElementById('cameraInput');
    const changeInput = document.getElementById('changeInput');
    
    if (galleryInput) {
        galleryInput.addEventListener('change', function(e) {
            console.log('갤러리에서 파일 선택됨:', e.target.files[0]?.name);
            if (e.target.files[0]) {
                handleFileSelection(e.target.files[0]);
            }
        });
    }
    
    if (cameraInput) {
        cameraInput.addEventListener('change', function(e) {
            console.log('카메라로 사진 촬영됨:', e.target.files[0]?.name);
            if (e.target.files[0]) {
                handleFileSelection(e.target.files[0]);
            }
        });
    }
    
    if (changeInput) {
        changeInput.addEventListener('change', function(e) {
            console.log('사진 변경됨:', e.target.files[0]?.name);
            if (e.target.files[0]) {
                handleFileSelection(e.target.files[0]);
            }
        });
    }
    
    // 드래그 앤 드롭
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) {
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                console.log('드래그 앤 드롭으로 파일 선택됨:', files[0].name);
                handleFileSelection(files[0]);
            }
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.currentTarget.classList.remove('drag-over');
        });
    }
    
    console.log('브라우저 호환 이벤트 설정 완료');
}

function selectWorkingMethod(method) {
    console.log('체험 방법 변경:', method);
    
    window.HAIRGATOR_GPT.currentMethod = method;
    
    const uploadMethodLabel = document.getElementById('uploadMethodLabel');
    const cameraMethodLabel = document.getElementById('cameraMethodLabel');
    const galleryLabel = document.getElementById('galleryLabel');
    const cameraLabel = document.getElementById('cameraLabel');
    const uploadIcon = document.getElementById('uploadIcon');
    const uploadText = document.getElementById('uploadText');
    const uploadSectionTitle = document.getElementById('uploadSectionTitle');
    
    // UI 업데이트
    if (uploadMethodLabel && cameraMethodLabel) {
        uploadMethodLabel.classList.remove('active');
        cameraMethodLabel.classList.remove('active');
        
        if (method === 'upload') {
            uploadMethodLabel.classList.add('active');
        } else {
            cameraMethodLabel.classList.add('active');
        }
    }
    
    // 버튼 표시/숨김
    if (galleryLabel && cameraLabel) {
        if (method === 'camera') {
            galleryLabel.style.display = 'none';
            cameraLabel.style.display = 'inline-block';
        } else {
            galleryLabel.style.display = 'inline-block';
            cameraLabel.style.display = 'none';
        }
    }
    
    // 텍스트 변경
    if (method === 'camera') {
        if (uploadIcon) uploadIcon.textContent = '📷';
        if (uploadText) uploadText.textContent = '카메라로 새 사진을 촬영하세요';
        if (uploadSectionTitle) uploadSectionTitle.textContent = '📷 사진 촬영';
    } else {
        if (uploadIcon) uploadIcon.textContent = '📁';
        if (uploadText) uploadText.textContent = '사진을 선택하거나 아래 버튼을 클릭하세요';
        if (uploadSectionTitle) uploadSectionTitle.textContent = '📷 사진 선택';
    }
}

function handleFileSelection(file) {
    if (!file) {
        console.error('파일이 선택되지 않음');
        return;
    }
    
    console.log('파일 처리 시작:', {
        name: file.name,
        size: file.size + ' bytes',
        type: file.type
    });
    
    if (file.size > 10 * 1024 * 1024) {
        alert('파일 크기가 너무 큽니다. 10MB 이하의 이미지를 선택해주세요.');
        return;
    }
    
    if (!file.type.startsWith('image/')) {
        alert('이미지 파일만 선택할 수 있습니다.');
        return;
    }
    
    window.HAIRGATOR_GPT.userPhoto = file;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const previewImage = document.getElementById('previewImage');
        const photoPreview = document.getElementById('photoPreview');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const startBtn = document.getElementById('startProcessBtn');
        const startGuide = document.getElementById('startGuide');
        
        if (previewImage) {
            previewImage.src = e.target.result;
        }
        
        if (photoPreview) photoPreview.style.display = 'block';
        if (uploadPlaceholder) uploadPlaceholder.style.display = 'none';
        if (startGuide) startGuide.style.display = 'none';
        
        if (startBtn) {
            startBtn.disabled = false;
            startBtn.textContent = '🎨 AI 체험 시작';
            startBtn.classList.add('ready');
        }
        
        console.log('파일 처리 완료 - 미리보기 표시됨');
    };
    
    reader.onerror = function() {
        console.error('파일 읽기 오류');
        alert('파일을 읽을 수 없습니다. 다른 파일을 선택해주세요.');
    };
    
    reader.readAsDataURL(file);
}

function startGPTProcessing() {
    if (!window.HAIRGATOR_GPT.userPhoto || !window.HAIRGATOR_GPT.currentStyle) {
        alert('사진을 먼저 업로드해주세요');
        return;
    }
    
    console.log('GPT 처리 시작');
    
    const startBtn = document.getElementById('startProcessBtn');
    const processingStatus = document.getElementById('processingStatus');
    const startGuide = document.getElementById('startGuide');
    
    if (startBtn) {
        startBtn.disabled = true;
        startBtn.textContent = '처리 중...';
        startBtn.classList.remove('ready');
    }
    
    if (processingStatus) {
        processingStatus.style.display = 'block';
    }
    
    if (startGuide) {
        startGuide.style.display = 'none';
    }
    
    window.HAIRGATOR_GPT.isProcessing = true;
    
    setTimeout(() => {
        displayGPTResult();
        
        window.HAIRGATOR_GPT.isProcessing = false;
        if (startBtn) {
            startBtn.disabled = false;
            startBtn.textContent = '🎨 AI 체험 시작';
            startBtn.classList.add('ready');
        }
    }, 3000);
}

function displayGPTResult() {
    const processingStatus = document.getElementById('processingStatus');
    const resultSection = document.getElementById('resultSection');
    const originalResult = document.getElementById('originalResult');
    const styledResult = document.getElementById('styledResult');
    
    if (processingStatus) {
        processingStatus.style.display = 'none';
    }
    
    if (resultSection) {
        resultSection.style.display = 'block';
    }
    
    if (originalResult && window.HAIRGATOR_GPT.userPhoto) {
        const reader = new FileReader();
        reader.onload = function(e) {
            originalResult.src = e.target.result;
        };
        reader.readAsDataURL(window.HAIRGATOR_GPT.userPhoto);
    }
    
    if (styledResult && window.HAIRGATOR_GPT.currentStyle) {
        styledResult.src = window.HAIRGATOR_GPT.currentStyle.imageUrl;
    }
    
    console.log('GPT 결과 표시 완료');
}

function downloadResult() {
    if (!window.HAIRGATOR_GPT.currentStyle) {
        alert('다운로드할 결과가 없습니다');
        return;
    }
    
    const link = document.createElement('a');
    link.href = window.HAIRGATOR_GPT.currentStyle.imageUrl;
    link.download = `hairgator_gpt_${Date.now()}.png`;
    link.click();
}

function shareResult() {
    if (!window.HAIRGATOR_GPT.currentStyle) {
        alert('공유할 결과가 없습니다');
        return;
    }
    
    if (navigator.share) {
        navigator.share({
            title: 'HAIRGATOR GPT 헤어스타일 체험',
            text: '새로운 헤어스타일을 확인해보세요!',
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(window.HAIRGATOR_GPT.currentStyle.imageUrl)
            .then(() => alert('이미지 URL이 클립보드에 복사되었습니다'))
            .catch(() => alert('공유 기능을 사용할 수 없습니다'));
    }
}

function closeGPTHairStyleModal() {
    const modal = document.getElementById('gptHairStyleModal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
        
        setTimeout(() => {
            removeGPTModal();
        }, 300);
    }
    
    window.HAIRGATOR_GPT.isProcessing = false;
    window.HAIRGATOR_GPT.userPhoto = null;
    window.HAIRGATOR_GPT.currentStyle = null;
    window.HAIRGATOR_GPT.currentMethod = 'upload';
}

function removeGPTModal() {
    const existingModal = document.getElementById('gptHairStyleModal');
    if (existingModal) {
        existingModal.remove();
    }
}

// 전역 함수 등록
window.openGPTHairStyleModal = openGPTHairStyleModal;
window.closeGPTHairStyleModal = closeGPTHairStyleModal;
window.startGPTProcessing = startGPTProcessing;
window.downloadResult = downloadResult;
window.shareResult = shareResult;

document.addEventListener('DOMContentLoaded', function() {
    console.log('GPT 브라우저 호환 시스템 로드 완료');
    
    if (typeof window.openGPTHairStyleModal === 'function') {
        console.log('window.openGPTHairStyleModal 함수 등록 완료');
    } else {
        console.error('window.openGPTHairStyleModal 함수 등록 실패');
    }
});

console.log('GPT 브라우저 호환 스크립트 로드 완료');
