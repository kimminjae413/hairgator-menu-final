// ==========================================
// HAIRGATOR GPT - ë¸Œë¼ìš°ì € í˜¸í™˜ íŒŒì¼ ì„ íƒ ìµœì¢… í•´ê²°
// js/gpt-hair-experience.js
// ==========================================

console.log('GPT ë¸Œë¼ìš°ì € í˜¸í™˜ ë²„ì „ ë¡œë“œ');

window.HAIRGATOR_GPT = {
    isProcessing: false,
    currentStyle: null,
    userPhoto: null,
    currentMethod: 'upload',
    apiEndpoint: '/.netlify/functions/openai-proxy'
};

// ë¸Œë¼ìš°ì € í˜¸í™˜ ëª¨ë‹¬ HTML - íŒŒì¼ ì…ë ¥ì„ ì§ì ‘ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ë³€ê²½
function createWorkingGPTModalHTML(style) {
    return `
    <div class="gpt-hair-style-modal" id="gptHairStyleModal">
        <div class="gpt-modal-container tablet-optimized">
            <div class="gpt-modal-header">
                <h2>
                    <span class="header-icon">ğŸ¨</span>
                    GPT Image 1 í—¤ì–´ì²´í—˜
                    <span class="gpt-badge">NEW</span>
                </h2>
                <button class="close-btn" onclick="closeGPTHairStyleModal()">Ã—</button>
            </div>
            
            <div class="gpt-modal-content tablet-layout">
                <div class="left-column">
                    <div class="selected-style-info compact">
                        <h4>ğŸ¯ ì„ íƒëœ í—¤ì–´ìŠ¤íƒ€ì¼</h4>
                        <div class="style-preview horizontal">
                            <img src="${style.imageUrl}" alt="${style.name}" class="style-reference-image small">
                            <div class="style-details">
                                <h3>${style.name}</h3>
                                <p class="style-code">${style.code}</p>
                                <p class="style-category">${style.mainCategory} > ${style.subCategory}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="experience-method-selection">
                        <h4>ğŸ“¸ ì²´í—˜ ë°©ë²• ì„ íƒ</h4>
                        <div class="method-options">
                            <label class="method-option active" id="uploadMethodLabel">
                                <input type="radio" name="method" value="upload" checked style="display: none;">
                                <div class="method-icon">ğŸ“</div>
                                <div class="method-title">ì‚¬ì§„ ì—…ë¡œë“œ</div>
                                <div class="method-description">ê°¤ëŸ¬ë¦¬ì—ì„œ ì‚¬ì§„ ì„ íƒ</div>
                            </label>
                            <label class="method-option" id="cameraMethodLabel">
                                <input type="radio" name="method" value="camera" style="display: none;">
                                <div class="method-icon">ğŸ“·</div>
                                <div class="method-title">ì¹´ë©”ë¼ ì´¬ì˜</div>
                                <div class="method-description">ìƒˆë¡œ ì‚¬ì§„ ì´¬ì˜</div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- í•µì‹¬ ìˆ˜ì •: íŒŒì¼ ì…ë ¥ì„ ë¼ë²¨ë¡œ ê°ì‹¸ì„œ ì§ì ‘ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ -->
                    <div class="photo-upload-section compact" id="photoUploadSection">
                        <h4 id="uploadSectionTitle">ğŸ“· ì‚¬ì§„ ì„ íƒ</h4>
                        
                        <div class="upload-area tablet-size" id="uploadArea">
                            <div class="upload-placeholder" id="uploadPlaceholder">
                                <div class="upload-icon" id="uploadIcon">ğŸ“</div>
                                <p id="uploadText">ì‚¬ì§„ì„ ì„ íƒí•˜ê±°ë‚˜ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                                
                                <!-- ì§ì ‘ í´ë¦­ ê°€ëŠ¥í•œ íŒŒì¼ ì…ë ¥ë“¤ -->
                                <label class="upload-btn tablet-btn" id="galleryLabel" style="display: inline-block;">
                                    <input type="file" id="galleryInput" accept="image/*" style="display: none;">
                                    ì‚¬ì§„ ì„ íƒí•˜ê¸°
                                </label>
                                
                                <label class="upload-btn tablet-btn" id="cameraLabel" style="display: none;">
                                    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                                    ì‚¬ì§„ ì´¬ì˜í•˜ê¸°
                                </label>
                            </div>
                            
                            <div class="photo-preview" id="photoPreview" style="display: none;">
                                <img id="previewImage" alt="ë¯¸ë¦¬ë³´ê¸°">
                                <label class="change-photo-btn" id="changeLabel">
                                    <input type="file" id="changeInput" accept="image/*" style="display: none;">
                                    ë‹¤ë¥¸ ì‚¬ì§„ ì„ íƒ
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="gpt-options-section compact">
                        <h4>âš™ï¸ ì˜µì…˜</h4>
                        <div class="option-toggles tablet-toggles">
                            <label class="option-toggle">
                                <input type="checkbox" id="colorMatchOption" checked>
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">í”¼ë¶€í†¤ ë§ì¶¤</span>
                            </label>
                            <label class="option-toggle">
                                <input type="checkbox" id="enhanceQualityOption">
                                <span class="toggle-slider"></span>
                                <span class="toggle-label">ê³ í’ˆì§ˆ</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="right-column">
                    <div class="processing-status tablet-processing" id="processingStatus" style="display: none;">
                        <div class="processing-animation">
                            <div class="processing-spinner"></div>
                            <p id="processingText">AIê°€ í—¤ì–´ìŠ¤íƒ€ì¼ì„ ì ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
                        </div>
                    </div>
                    
                    <div class="result-section tablet-result" id="resultSection" style="display: none;">
                        <h4>âœ¨ ë³€í™˜ ê²°ê³¼</h4>
                        <div class="result-comparison tablet-comparison">
                            <div class="result-item">
                                <p>ì›ë³¸</p>
                                <img id="originalResult" alt="ì›ë³¸ ì‚¬ì§„">
                            </div>
                            <div class="result-arrow">â†’</div>
                            <div class="result-item">
                                <p>ë³€í™˜ í›„</p>
                                <img id="styledResult" alt="ìŠ¤íƒ€ì¼ ì ìš© í›„">
                            </div>
                        </div>
                        <div class="result-actions tablet-actions">
                            <button type="button" class="result-btn secondary" onclick="downloadResult()">
                                ğŸ’¾ ë‹¤ìš´ë¡œë“œ
                            </button>
                            <button type="button" class="result-btn primary" onclick="shareResult()">
                                ğŸ“¤ ê³µìœ í•˜ê¸°
                            </button>
                        </div>
                    </div>
                    
                    <div class="start-guide" id="startGuide">
                        <div class="guide-content">
                            <div class="guide-icon">ğŸ¨</div>
                            <h3>AI í—¤ì–´ìŠ¤íƒ€ì¼ ì²´í—˜</h3>
                            <p>ì™¼ìª½ì—ì„œ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ê³ <br>AI ì²´í—˜ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
                            <div class="guide-steps">
                                <div class="step">1ï¸âƒ£ ì²´í—˜ ë°©ë²• ì„ íƒ</div>
                                <div class="step">2ï¸âƒ£ ì‚¬ì§„ ì—…ë¡œë“œ</div>
                                <div class="step">3ï¸âƒ£ AI ì²´í—˜ ì‹œì‘</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="gpt-modal-actions tablet-actions">
                <button type="button" class="gpt-action-btn secondary tablet-btn" onclick="closeGPTHairStyleModal()">
                    ì·¨ì†Œ
                </button>
                <button type="button" class="gpt-action-btn primary tablet-btn" id="startProcessBtn" onclick="startGPTProcessing()" disabled>
                    ğŸ¨ AI ì²´í—˜ ì‹œì‘
                </button>
            </div>
        </div>
    </div>`;
}

function openGPTHairStyleModal(style) {
    console.log('GPT í—¤ì–´ìŠ¤íƒ€ì¼ ëª¨ë‹¬ ì—´ê¸°:', style);
    
    removeGPTModal();
    window.HAIRGATOR_GPT.currentStyle = style;
    window.HAIRGATOR_GPT.currentMethod = 'upload';
    
    const modalHTML = createWorkingGPTModalHTML(style);
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => {
        const modal = document.getElementById('gptHairStyleModal');
        if (modal) {
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
    }, 100);
    
    setTimeout(() => {
        setupWorkingEvents();
    }, 150);
}

function setupWorkingEvents() {
    console.log('ë¸Œë¼ìš°ì € í˜¸í™˜ ì´ë²¤íŠ¸ ì„¤ì •...');
    
    // ë°©ë²• ì„ íƒ ë¼ë””ì˜¤ ë²„íŠ¼
    const uploadMethod = document.querySelector('input[name="method"][value="upload"]');
    const cameraMethod = document.querySelector('input[name="method"][value="camera"]');
    const uploadMethodLabel = document.getElementById('uploadMethodLabel');
    const cameraMethodLabel = document.getElementById('cameraMethodLabel');
    
    const galleryLabel = document.getElementById('galleryLabel');
    const cameraLabel = document.getElementById('cameraLabel');
    
    // ë°©ë²• ì„ íƒ ì´ë²¤íŠ¸
    if (uploadMethod && cameraMethod) {
        uploadMethod.addEventListener('change', function() {
            if (this.checked) {
                selectWorkingMethod('upload');
            }
        });
        
        cameraMethod.addEventListener('change', function() {
            if (this.checked) {
                selectWorkingMethod('camera');
            }
        });
    }
    
    // ë¼ë²¨ í´ë¦­ìœ¼ë¡œ ë°©ë²• ë³€ê²½
    if (uploadMethodLabel) {
        uploadMethodLabel.addEventListener('click', function() {
            selectWorkingMethod('upload');
        });
    }
    
    if (cameraMethodLabel) {
        cameraMethodLabel.addEventListener('click', function() {
            selectWorkingMethod('camera');
        });
    }
    
    // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ (ë¼ë²¨ ë‚´ë¶€ì˜ input)
    const galleryInput = document.getElementById('galleryInput');
    const cameraInput = document.getElementById('cameraInput');
    const changeInput = document.getElementById('changeInput');
    
    if (galleryInput) {
        galleryInput.addEventListener('change', function(e) {
            console.log('ê°¤ëŸ¬ë¦¬ì—ì„œ íŒŒì¼ ì„ íƒë¨:', e.target.files[0]?.name);
            if (e.target.files[0]) {
                handleFileSelection(e.target.files[0]);
            }
        });
    }
    
    if (cameraInput) {
        cameraInput.addEventListener('change', function(e) {
            console.log('ì¹´ë©”ë¼ë¡œ ì‚¬ì§„ ì´¬ì˜ë¨:', e.target.files[0]?.name);
            if (e.target.files[0]) {
                handleFileSelection(e.target.files[0]);
            }
        });
    }
    
    if (changeInput) {
        changeInput.addEventListener('change', function(e) {
            console.log('ì‚¬ì§„ ë³€ê²½ë¨:', e.target.files[0]?.name);
            if (e.target.files[0]) {
                handleFileSelection(e.target.files[0]);
            }
        });
    }
    
    // ë“œë˜ê·¸ ì•¤ ë“œë¡­
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) {
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                console.log('ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ íŒŒì¼ ì„ íƒë¨:', files[0].name);
                handleFileSelection(files[0]);
            }
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.currentTarget.classList.remove('drag-over');
        });
    }
    
    console.log('ë¸Œë¼ìš°ì € í˜¸í™˜ ì´ë²¤íŠ¸ ì„¤ì • ì™„ë£Œ');
}

function selectWorkingMethod(method) {
    console.log('ì²´í—˜ ë°©ë²• ë³€ê²½:', method);
    
    window.HAIRGATOR_GPT.currentMethod = method;
    
    const uploadMethodLabel = document.getElementById('uploadMethodLabel');
    const cameraMethodLabel = document.getElementById('cameraMethodLabel');
    const galleryLabel = document.getElementById('galleryLabel');
    const cameraLabel = document.getElementById('cameraLabel');
    const uploadIcon = document.getElementById('uploadIcon');
    const uploadText = document.getElementById('uploadText');
    const uploadSectionTitle = document.getElementById('uploadSectionTitle');
    
    // UI ì—…ë°ì´íŠ¸
    if (uploadMethodLabel && cameraMethodLabel) {
        uploadMethodLabel.classList.remove('active');
        cameraMethodLabel.classList.remove('active');
        
        if (method === 'upload') {
            uploadMethodLabel.classList.add('active');
        } else {
            cameraMethodLabel.classList.add('active');
        }
    }
    
    // ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
    if (galleryLabel && cameraLabel) {
        if (method === 'camera') {
            galleryLabel.style.display = 'none';
            cameraLabel.style.display = 'inline-block';
        } else {
            galleryLabel.style.display = 'inline-block';
            cameraLabel.style.display = 'none';
        }
    }
    
    // í…ìŠ¤íŠ¸ ë³€ê²½
    if (method === 'camera') {
        if (uploadIcon) uploadIcon.textContent = 'ğŸ“·';
        if (uploadText) uploadText.textContent = 'ì¹´ë©”ë¼ë¡œ ìƒˆ ì‚¬ì§„ì„ ì´¬ì˜í•˜ì„¸ìš”';
        if (uploadSectionTitle) uploadSectionTitle.textContent = 'ğŸ“· ì‚¬ì§„ ì´¬ì˜';
    } else {
        if (uploadIcon) uploadIcon.textContent = 'ğŸ“';
        if (uploadText) uploadText.textContent = 'ì‚¬ì§„ì„ ì„ íƒí•˜ê±°ë‚˜ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”';
        if (uploadSectionTitle) uploadSectionTitle.textContent = 'ğŸ“· ì‚¬ì§„ ì„ íƒ';
    }
}

function handleFileSelection(file) {
    if (!file) {
        console.error('íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•ŠìŒ');
        return;
    }
    
    console.log('íŒŒì¼ ì²˜ë¦¬ ì‹œì‘:', {
        name: file.name,
        size: file.size + ' bytes',
        type: file.type
    });
    
    if (file.size > 10 * 1024 * 1024) {
        alert('íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. 10MB ì´í•˜ì˜ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!file.type.startsWith('image/')) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }
    
    window.HAIRGATOR_GPT.userPhoto = file;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const previewImage = document.getElementById('previewImage');
        const photoPreview = document.getElementById('photoPreview');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const startBtn = document.getElementById('startProcessBtn');
        const startGuide = document.getElementById('startGuide');
        
        if (previewImage) {
            previewImage.src = e.target.result;
        }
        
        if (photoPreview) photoPreview.style.display = 'block';
        if (uploadPlaceholder) uploadPlaceholder.style.display = 'none';
        if (startGuide) startGuide.style.display = 'none';
        
        if (startBtn) {
            startBtn.disabled = false;
            startBtn.textContent = 'ğŸ¨ AI ì²´í—˜ ì‹œì‘';
            startBtn.classList.add('ready');
        }
        
        console.log('íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ - ë¯¸ë¦¬ë³´ê¸° í‘œì‹œë¨');
    };
    
    reader.onerror = function() {
        console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜');
        alert('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    };
    
    reader.readAsDataURL(file);
}

function startGPTProcessing() {
    if (!window.HAIRGATOR_GPT.userPhoto || !window.HAIRGATOR_GPT.currentStyle) {
        alert('ì‚¬ì§„ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”');
        return;
    }
    
    console.log('GPT ì²˜ë¦¬ ì‹œì‘');
    
    const startBtn = document.getElementById('startProcessBtn');
    const processingStatus = document.getElementById('processingStatus');
    const startGuide = document.getElementById('startGuide');
    
    if (startBtn) {
        startBtn.disabled = true;
        startBtn.textContent = 'ì²˜ë¦¬ ì¤‘...';
        startBtn.classList.remove('ready');
    }
    
    if (processingStatus) {
        processingStatus.style.display = 'block';
    }
    
    if (startGuide) {
        startGuide.style.display = 'none';
    }
    
    window.HAIRGATOR_GPT.isProcessing = true;
    
    setTimeout(() => {
        displayGPTResult();
        
        window.HAIRGATOR_GPT.isProcessing = false;
        if (startBtn) {
            startBtn.disabled = false;
            startBtn.textContent = 'ğŸ¨ AI ì²´í—˜ ì‹œì‘';
            startBtn.classList.add('ready');
        }
    }, 3000);
}

function displayGPTResult() {
    const processingStatus = document.getElementById('processingStatus');
    const resultSection = document.getElementById('resultSection');
    const originalResult = document.getElementById('originalResult');
    const styledResult = document.getElementById('styledResult');
    
    if (processingStatus) {
        processingStatus.style.display = 'none';
    }
    
    if (resultSection) {
        resultSection.style.display = 'block';
    }
    
    if (originalResult && window.HAIRGATOR_GPT.userPhoto) {
        const reader = new FileReader();
        reader.onload = function(e) {
            originalResult.src = e.target.result;
        };
        reader.readAsDataURL(window.HAIRGATOR_GPT.userPhoto);
    }
    
    if (styledResult && window.HAIRGATOR_GPT.currentStyle) {
        styledResult.src = window.HAIRGATOR_GPT.currentStyle.imageUrl;
    }
    
    console.log('GPT ê²°ê³¼ í‘œì‹œ ì™„ë£Œ');
}

function downloadResult() {
    if (!window.HAIRGATOR_GPT.currentStyle) {
        alert('ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
    }
    
    const link = document.createElement('a');
    link.href = window.HAIRGATOR_GPT.currentStyle.imageUrl;
    link.download = `hairgator_gpt_${Date.now()}.png`;
    link.click();
}

function shareResult() {
    if (!window.HAIRGATOR_GPT.currentStyle) {
        alert('ê³µìœ í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
    }
    
    if (navigator.share) {
        navigator.share({
            title: 'HAIRGATOR GPT í—¤ì–´ìŠ¤íƒ€ì¼ ì²´í—˜',
            text: 'ìƒˆë¡œìš´ í—¤ì–´ìŠ¤íƒ€ì¼ì„ í™•ì¸í•´ë³´ì„¸ìš”!',
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(window.HAIRGATOR_GPT.currentStyle.imageUrl)
            .then(() => alert('ì´ë¯¸ì§€ URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤'))
            .catch(() => alert('ê³µìœ  ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤'));
    }
}

function closeGPTHairStyleModal() {
    const modal = document.getElementById('gptHairStyleModal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
        
        setTimeout(() => {
            removeGPTModal();
        }, 300);
    }
    
    window.HAIRGATOR_GPT.isProcessing = false;
    window.HAIRGATOR_GPT.userPhoto = null;
    window.HAIRGATOR_GPT.currentStyle = null;
    window.HAIRGATOR_GPT.currentMethod = 'upload';
}

function removeGPTModal() {
    const existingModal = document.getElementById('gptHairStyleModal');
    if (existingModal) {
        existingModal.remove();
    }
}

// ì „ì—­ í•¨ìˆ˜ ë“±ë¡
window.openGPTHairStyleModal = openGPTHairStyleModal;
window.closeGPTHairStyleModal = closeGPTHairStyleModal;
window.startGPTProcessing = startGPTProcessing;
window.downloadResult = downloadResult;
window.shareResult = shareResult;

document.addEventListener('DOMContentLoaded', function() {
    console.log('GPT ë¸Œë¼ìš°ì € í˜¸í™˜ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ');
    
    if (typeof window.openGPTHairStyleModal === 'function') {
        console.log('window.openGPTHairStyleModal í•¨ìˆ˜ ë“±ë¡ ì™„ë£Œ');
    } else {
        console.error('window.openGPTHairStyleModal í•¨ìˆ˜ ë“±ë¡ ì‹¤íŒ¨');
    }
});

console.log('GPT ë¸Œë¼ìš°ì € í˜¸í™˜ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
