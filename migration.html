<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAIRGATOR - ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #FF1493;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: #FF1493;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        
        .btn:hover {
            background: #FF69B4;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #000;
        }
        
        .log {
            background: #000;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-item {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #333;
            padding-left: 10px;
        }
        
        .log-success {
            border-left-color: #28a745;
            color: #28a745;
        }
        
        .log-error {
            border-left-color: #dc3545;
            color: #dc3545;
        }
        
        .log-warning {
            border-left-color: #ffc107;
            color: #ffc107;
        }
        
        .log-info {
            border-left-color: #17a2b8;
            color: #17a2b8;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            border: 1px solid #333;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background: #000;
            color: #FF1493;
        }
        
        .old-data {
            background: rgba(255, 0, 0, 0.1);
        }
        
        .new-data {
            background: rgba(0, 255, 0, 0.1);
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ HAIRGATOR ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</h1>
    
    <!-- 1ë‹¨ê³„: ê¸°ì¡´ ë°ì´í„° í™•ì¸ -->
    <div class="section">
        <h2>1ï¸âƒ£ ê¸°ì¡´ ë°ì´í„° í™•ì¸</h2>
        <p>Firebaseì— ì €ì¥ëœ ê¸°ì¡´ ë°ì´í„°ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
        <button class="btn btn-warning" onclick="checkOldData()">ğŸ” ê¸°ì¡´ ë°ì´í„° í™•ì¸</button>
        <div id="oldDataResult" class="log"></div>
    </div>
    
    <!-- 2ë‹¨ê³„: ë°ì´í„° ë°±ì—… -->
    <div class="section">
        <h2>2ï¸âƒ£ ë°ì´í„° ë°±ì—…</h2>
        <p>ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ ëª¨ë“  ë°ì´í„°ë¥¼ ë°±ì—…í•©ë‹ˆë‹¤.</p>
        <button class="btn" onclick="backupData()">ğŸ’¾ ë°ì´í„° ë°±ì—…</button>
        <div id="backupResult" class="log"></div>
    </div>
    
    <!-- 3ë‹¨ê³„: ë§ˆì´ê·¸ë ˆì´ì…˜ -->
    <div class="section">
        <h2>3ï¸âƒ£ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</h2>
        <p>âš ï¸ ì£¼ì˜: ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°˜ë“œì‹œ ë°±ì—… í›„ ì§„í–‰í•˜ì„¸ìš”.</p>
        
        <h3>ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜µì…˜:</h3>
        <button class="btn btn-success" onclick="migrateData(false)">âœ… ì•ˆì „ ëª¨ë“œ (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)</button>
        <button class="btn btn-danger" onclick="migrateData(true)">âš ï¸ ì™„ì „ êµì²´ (ê¸°ì¡´ ë°ì´í„° ì‚­ì œ)</button>
        
        <div id="migrationResult" class="log"></div>
    </div>
    
    <!-- 4ë‹¨ê³„: ê²€ì¦ -->
    <div class="section">
        <h2>4ï¸âƒ£ ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦</h2>
        <p>ìƒˆë¡œìš´ êµ¬ì¡°ë¡œ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ê²Œ ë³€í™˜ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</p>
        <button class="btn btn-success" onclick="verifyMigration()">âœ”ï¸ ê²€ì¦í•˜ê¸°</button>
        <div id="verifyResult" class="log"></div>
    </div>
    
    <script src="js/firebase-config.js"></script>
    <script>
        let backupData = null;
        let oldDataList = [];
        
        // ê¸°ì¡´ êµ¬ì¡°ì™€ ìƒˆ êµ¬ì¡° ë§¤í•‘
        const CATEGORY_MAPPING = {
            'LONG': 'A Length',
            'SEMI LONG': 'C Length',
            'MEDIUM': 'E Length',
            'BOB': 'F Length',
            'SHORT': 'H Length'
        };
        
        const SUBCATEGORY_MAPPING = {
            'A Length': 'None',
            'B Length': 'None',
            'C Length': 'Fore Head',
            'D Length': 'Fore Head',
            'E Length': 'Eye Brow',
            'F Length': 'Eye',
            'G Length': 'Eye',
            'H Length': 'Cheekbone'
        };
        
        // ë¡œê·¸ ì¶”ê°€ í•¨ìˆ˜
        function addLog(elementId, message, type = 'info') {
            const logDiv = document.getElementById(elementId);
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${type}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(logItem);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // 1. ê¸°ì¡´ ë°ì´í„° í™•ì¸
        async function checkOldData() {
            const logId = 'oldDataResult';
            document.getElementById(logId).innerHTML = '';
            
            addLog(logId, 'ê¸°ì¡´ ë°ì´í„° í™•ì¸ ì‹œì‘...', 'info');
            
            try {
                const snapshot = await db.collection('hairstyles').get();
                
                if (snapshot.empty) {
                    addLog(logId, 'ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }
                
                oldDataList = [];
                let oldStructureCount = 0;
                let newStructureCount = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    oldDataList.push({ id: doc.id, ...data });
                    
                    // ì—¬ì„± ë°ì´í„°ë§Œ ì²´í¬
                    if (data.gender === 'female') {
                        // ê¸°ì¡´ êµ¬ì¡° ì²´í¬ (ëŒ€ë¶„ë¥˜ê°€ LONG, MEDIUM ë“±)
                        if (['LONG', 'SEMI LONG', 'MEDIUM', 'BOB', 'SHORT'].includes(data.mainCategory)) {
                            oldStructureCount++;
                            addLog(logId, `[êµ¬ êµ¬ì¡°] ${data.code}: ${data.mainCategory} / ${data.subCategory}`, 'warning');
                        }
                        // ìƒˆ êµ¬ì¡° ì²´í¬ (ëŒ€ë¶„ë¥˜ê°€ A Length ë“±)
                        else if (data.mainCategory && data.mainCategory.includes('Length')) {
                            newStructureCount++;
                            addLog(logId, `[ì‹  êµ¬ì¡°] ${data.code}: ${data.mainCategory} / ${data.subCategory}`, 'success');
                        }
                    }
                });
                
                addLog(logId, `ì´ ${snapshot.size}ê°œ ë°ì´í„° ë°œê²¬`, 'info');
                addLog(logId, `êµ¬ êµ¬ì¡° ì—¬ì„± ë°ì´í„°: ${oldStructureCount}ê°œ`, 'warning');
                addLog(logId, `ì‹  êµ¬ì¡° ì—¬ì„± ë°ì´í„°: ${newStructureCount}ê°œ`, 'success');
                
                if (oldStructureCount > 0) {
                    addLog(logId, 'âš ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ í•„ìš”í•œ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤!', 'error');
                } else {
                    addLog(logId, 'âœ… ëª¨ë“  ë°ì´í„°ê°€ ìƒˆ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.', 'success');
                }
                
            } catch (error) {
                addLog(logId, `ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // 2. ë°ì´í„° ë°±ì—…
        async function backupData() {
            const logId = 'backupResult';
            document.getElementById(logId).innerHTML = '';
            
            addLog(logId, 'ë°±ì—… ì‹œì‘...', 'info');
            
            try {
                const snapshot = await db.collection('hairstyles').get();
                backupData = [];
                
                snapshot.forEach(doc => {
                    backupData.push({
                        id: doc.id,
                        data: doc.data()
                    });
                });
                
                // JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `hairgator_backup_${new Date().getTime()}.json`;
                link.click();
                
                addLog(logId, `âœ… ${backupData.length}ê°œ ë°ì´í„° ë°±ì—… ì™„ë£Œ`, 'success');
                addLog(logId, 'ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
            } catch (error) {
                addLog(logId, `ë°±ì—… ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        // 3. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜
        async function migrateData(deleteOld = false) {
            const logId = 'migrationResult';
            document.getElementById(logId).innerHTML = '';
            
            if (!confirm(`ì •ë§ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“œ: ${deleteOld ? 'ì™„ì „ êµì²´' : 'ì•ˆì „ ëª¨ë“œ'}`)) {
                return;
            }
            
            addLog(logId, 'ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...', 'info');
            
            try {
                const snapshot = await db.collection('hairstyles').get();
                let migratedCount = 0;
                let errorCount = 0;
                
                for (const doc of snapshot.docs) {
                    const data = doc.data();
                    
                    // ì—¬ì„± ë°ì´í„°ì´ê³  êµ¬ êµ¬ì¡°ì¸ ê²½ìš°ë§Œ ì²˜ë¦¬
                    if (data.gender === 'female' && ['LONG', 'SEMI LONG', 'MEDIUM', 'BOB', 'SHORT'].includes(data.mainCategory)) {
                        try {
                            // ìƒˆ êµ¬ì¡°ë¡œ ë³€í™˜
                            const newMainCategory = CATEGORY_MAPPING[data.mainCategory] || 'C Length';
                            const newSubCategory = SUBCATEGORY_MAPPING[data.subCategory] || 'None';
                            
                            // ìƒˆ ì½”ë“œ ìƒì„±
                            const lengthCode = newMainCategory.split(' ')[0];
                            const subInitial = newSubCategory.substring(0, 1);
                            const timestamp = Date.now().toString().slice(-3);
                            const newCode = `F${lengthCode}${subInitial}${timestamp}`;
                            
                            if (deleteOld) {
                                // ê¸°ì¡´ ë¬¸ì„œ ì‚­ì œ í›„ ìƒˆë¡œ ìƒì„±
                                await db.collection('hairstyles').doc(doc.id).delete();
                                await db.collection('hairstyles').add({
                                    ...data,
                                    mainCategory: newMainCategory,
                                    subCategory: newSubCategory,
                                    code: newCode,
                                    migratedAt: new Date(),
                                    originalCategory: data.mainCategory,
                                    originalSubcategory: data.subCategory
                                });
                                addLog(logId, `[ì‚­ì œ í›„ ìƒì„±] ${data.code} â†’ ${newCode}`, 'success');
                            } else {
                                // ê¸°ì¡´ ë¬¸ì„œ ì—…ë°ì´íŠ¸
                                await db.collection('hairstyles').doc(doc.id).update({
                                    mainCategory: newMainCategory,
                                    subCategory: newSubCategory,
                                    code: newCode,
                                    migratedAt: new Date(),
                                    originalCategory: data.mainCategory,
                                    originalSubcategory: data.subCategory
                                });
                                addLog(logId, `[ì—…ë°ì´íŠ¸] ${data.code} â†’ ${newCode}`, 'success');
                            }
                            
                            migratedCount++;
                        } catch (error) {
                            errorCount++;
                            addLog(logId, `ì˜¤ë¥˜: ${data.code} - ${error.message}`, 'error');
                        }
                    }
                }
                
                addLog(logId, `âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!`, 'success');
                addLog(logId, `ì„±ê³µ: ${migratedCount}ê°œ / ì‹¤íŒ¨: ${errorCount}ê°œ`, 'info');
                
            } catch (error) {
                addLog(logId, `ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        // 4. ê²€ì¦
        async function verifyMigration() {
            const logId = 'verifyResult';
            document.getElementById(logId).innerHTML = '';
            
            addLog(logId, 'ê²€ì¦ ì‹œì‘...', 'info');
            
            try {
                const snapshot = await db.collection('hairstyles').get();
                
                let maleCount = 0;
                let femaleCount = 0;
                let validCount = 0;
                let invalidCount = 0;
                
                const validFemaleCategories = ['A Length', 'B Length', 'C Length', 'D Length', 'E Length', 'F Length', 'G Length', 'H Length'];
                const validSubcategories = ['None', 'Fore Head', 'Eye Brow', 'Eye', 'Cheekbone'];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    if (data.gender === 'male') {
                        maleCount++;
                    } else if (data.gender === 'female') {
                        femaleCount++;
                        
                        // ìƒˆ êµ¬ì¡° ê²€ì¦
                        if (validFemaleCategories.includes(data.mainCategory) && 
                            validSubcategories.includes(data.subCategory)) {
                            validCount++;
                            addLog(logId, `âœ… [ìœ íš¨] ${data.code}: ${data.mainCategory} / ${data.subCategory}`, 'success');
                        } else {
                            invalidCount++;
                            addLog(logId, `âŒ [ë¬´íš¨] ${data.code}: ${data.mainCategory} / ${data.subCategory}`, 'error');
                        }
                    }
                });
                
                addLog(logId, '========== ê²€ì¦ ê²°ê³¼ ==========', 'info');
                addLog(logId, `ë‚¨ì„± ë°ì´í„°: ${maleCount}ê°œ`, 'info');
                addLog(logId, `ì—¬ì„± ë°ì´í„°: ${femaleCount}ê°œ`, 'info');
                addLog(logId, `ìœ íš¨í•œ ì—¬ì„± ë°ì´í„°: ${validCount}ê°œ`, 'success');
                addLog(logId, `ë¬´íš¨í•œ ì—¬ì„± ë°ì´í„°: ${invalidCount}ê°œ`, invalidCount > 0 ? 'error' : 'success');
                
                if (invalidCount === 0) {
                    addLog(logId, 'ğŸ‰ ëª¨ë“  ë°ì´í„°ê°€ ìƒˆ êµ¬ì¡°ë¡œ ì •ìƒ ë§ˆì´ê·¸ë ˆì´ì…˜ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } else {
                    addLog(logId, 'âš ï¸ ì¼ë¶€ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                }
                
            } catch (error) {
                addLog(logId, `ê²€ì¦ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ Migration Tool Ready');
            console.log('ğŸ“± Firebase connected:', typeof db !== 'undefined');
        });
    </script>
</body>
</html>