<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAIRGATOR Personal Color</title>
    
    <!-- MediaPipe CDN -->
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- 로딩 화면 -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">🎨</div>
            <h2>HAIRGATOR Personal Color</h2>
            <p id="loading-text">시스템 초기화 중...</p>
            <div class="loading-progress">
                <div class="loading-bar" id="loading-bar"></div>
            </div>
        </div>
    </div>

    <!-- 메인 애플리케이션 -->
    <div class="main-app" id="main-app">
        <header class="app-header">
            <div class="header-content">
                <div class="app-title-section">
                    <h1 class="app-title">HAIRGATOR Personal Color</h1>
                    <div class="app-subtitle">AI 기반 퍼스널컬러 진단 시스템</div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- 모드 선택 섹션 -->
            <section class="section active" id="mode-selection">
                <h2 class="mode-title">퍼스널컬러 진단 방법을 선택하세요</h2>
                
                <div class="mode-cards">
                    <div class="mode-card" onclick="selectMode('ai')">
                        <span class="mode-icon">🤖</span>
                        <h3 class="mode-card-title">AI 퍼스널컬러 분석</h3>
                        <p class="mode-description">
                            최신 AI 기술로 얼굴을 분석하여 정확한 퍼스널컬러를 진단합니다. 
                            MediaPipe 얼굴 인식과 Delta E 2000 색차 측정을 활용합니다.
                        </p>
                        <ul class="mode-features">
                            <li>실시간 얼굴 인식 및 피부톤 추출</li>
                            <li>LAB 색공간 기반 정밀 분석</li>
                            <li>전문가 노하우 데이터베이스 활용</li>
                            <li>624개 헤어컬러와 자동 매칭</li>
                        </ul>
                        <button class="mode-btn">AI 분석 시작</button>
                    </div>
                    
                    <div class="mode-card" onclick="selectMode('draping')">
                        <span class="mode-icon">🎭</span>
                        <h3 class="mode-card-title">전문가 드래이핑 모드</h3>
                        <p class="mode-description">
                            전문가 노하우를 바탕으로 실시간 드래이핑을 통해 
                            가장 어울리는 헤어컬러를 직접 확인해보세요.
                        </p>
                        <ul class="mode-features">
                            <li>실시간 카메라 드래이핑</li>
                            <li>4계절 색상 팔레트 제공</li>
                            <li>Before/After 즉시 비교</li>
                            <li>브랜드별 제품 추천</li>
                        </ul>
                        <button class="mode-btn">드래이핑 시작</button>
                    </div>
                </div>
            </section>

            <!-- AI 분석 모드 -->
            <section class="section" id="ai-analysis">
                <div class="section-nav">
                    <button class="nav-btn" onclick="goHome()">← 홈으로</button>
                    <h2 class="section-title">AI 퍼스널컬러 분석</h2>
                </div>
                
                <div class="analysis-grid">
                    <!-- 카메라 영역 -->
                    <div class="camera-container">
                        <div class="video-container">
                            <video id="ai-camera" autoplay muted playsinline></video>
                            <canvas id="ai-face-overlay"></canvas>
                            <div class="face-guide" id="ai-face-guide">
                                얼굴을 가이드라인에<br>맞춰주세요
                            </div>
                        </div>
                        <div class="camera-controls">
                            <button class="control-btn" onclick="startAICamera()">카메라 시작</button>
                            <button class="control-btn" onclick="analyzeAI()">AI 분석</button>
                            <button class="control-btn" onclick="stopAICamera()">정지</button>
                        </div>
                    </div>
                    
                    <!-- 분석 패널 -->
                    <div class="analysis-panel">
                        <h3>AI 분석 진행상황</h3>
                        <div class="analysis-steps">
                            <div class="analysis-step" id="ai-step-1">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h4>얼굴 인식</h4>
                                    <p>MediaPipe로 얼굴 영역을 감지합니다</p>
                                </div>
                            </div>
                            
                            <div class="analysis-step" id="ai-step-2">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h4>피부톤 분석</h4>
                                    <p>RGB → LAB 색공간 변환 및 색상 추출</p>
                                </div>
                            </div>
                            
                            <div class="analysis-step" id="ai-step-3">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h4>Delta E 계산</h4>
                                    <p>색차 측정 및 정확도 산출</p>
                                </div>
                            </div>
                            
                            <div class="analysis-step" id="ai-step-4">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h4>결과 생성</h4>
                                    <p>전문가 노하우 기반 최종 진단</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="analysis-results" id="ai-analysis-results" style="display: none;">
                            <h4>분석 결과</h4>
                            <div class="result-summary">
                                <div class="season-result" id="ai-season-result">분석 중...</div>
                                <div class="confidence-score" id="ai-confidence">-</div>
                            </div>
                            <div class="color-analysis-data" id="ai-analysis-data">
                                <!-- 상세 데이터가 여기에 표시됩니다 -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 드래이핑 모드 -->
            <section class="section" id="draping-mode">
                <div class="section-nav">
                    <button class="nav-btn" onclick="goHome()">← 홈으로</button>
                    <h2 class="section-title">전문가 드래이핑 모드</h2>
                </div>
                
                <div class="draping-layout">
                    <!-- 드래이핑 카메라 -->
                    <div class="draping-camera-section">
                        <div class="video-container">
                            <video id="draping-camera" autoplay muted playsinline></video>
                            <canvas id="draping-overlay"></canvas>
                            <div class="face-guide" id="draping-face-guide">
                                얼굴을 가이드라인에<br>맞춰주세요
                            </div>
                        </div>
                        
                        <div class="camera-controls">
                            <button class="control-btn" onclick="startDrapingCamera()">카메라 시작</button>
                            <button class="control-btn" onclick="saveCurrentColor()">현재 색상 저장</button>
                        </div>
                    </div>
                    
                    <!-- 색상 팔레트 -->
                    <div class="color-palette-section">
                        <h3>4계절 색상 팔레트</h3>
                        
                        <!-- 계절 탭 -->
                        <div class="season-tabs">
                            <button class="season-tab active" data-season="spring" onclick="selectSeason('spring')">봄</button>
                            <button class="season-tab" data-season="summer" onclick="selectSeason('summer')">여름</button>
                            <button class="season-tab" data-season="autumn" onclick="selectSeason('autumn')">가을</button>
                            <button class="season-tab" data-season="winter" onclick="selectSeason('winter')">겨울</button>
                        </div>
                        
                        <!-- 색상 그리드 -->
                        <div class="color-grid" id="color-grid">
                            <!-- 동적으로 생성됩니다 -->
                        </div>
                        
                        <!-- 세부 조정 -->
                        <div class="color-adjustments">
                            <h4>색상 세부 조정</h4>
                            
                            <div class="adjustment-slider">
                                <label>명도</label>
                                <input type="range" id="lightness-slider" min="-30" max="30" value="0" oninput="adjustColor()">
                                <span id="lightness-value">0</span>
                            </div>
                            
                            <div class="adjustment-slider">
                                <label>채도</label>
                                <input type="range" id="saturation-slider" min="-50" max="50" value="0" oninput="adjustColor()">
                                <span id="saturation-value">0</span>
                            </div>
                            
                            <div class="adjustment-slider">
                                <label>온도감</label>
                                <input type="range" id="warmth-slider" min="-40" max="40" value="0" oninput="adjustColor()">
                                <span id="warmth-value">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 공통 결과 섹션 -->
            <div class="results-section" id="results-section" style="display: none;">
                <h3>퍼스널컬러 진단 결과</h3>
                <div class="final-results" id="final-results">
                    <!-- 결과 내용이 여기에 표시됩니다 -->
                </div>
                
                <div class="product-recommendations" id="product-recommendations">
                    <h4>추천 헤어컬러 제품</h4>
                    <div class="brand-sections" id="brand-sections">
                        <!-- 브랜드별 제품 추천이 여기에 표시됩니다 -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 전역 변수 정의
        let currentMode = null;
        let analysisInProgress = false;
        let faceDetected = false;
        let hairColorData = [];
        let videoElement = null;
        let canvasElement = null;
        let canvasCtx = null;
        let currentSeason = 'spring';
        let selectedColor = null;
        let savedColors = [];
        let activeVideoStream = null;
        let mediaPipeCamera = null;
        let faceDetectionInstance = null;
        let sharedExtractCanvas = null;    // 여기로 이동
        let sharedExtractCtx = null;       // 여기로 이동
        
        // 전문가 노하우 데이터
        const ExpertKnowledge = {
            colorTheory: {
                warmCool: "주황색은 웜톤의 대표적인 색상이며 쿨톤으로 변환이 어렵습니다",
                foundation: "파운데이션 21-23호대는 비슷한 명도의 헤어컬러와 매치할 때 주의가 필요합니다"
            },
            skinAnalysis: {
                redness: "홍조 피부는 미드나잇 컬러로 중화시킬 수 있습니다",
                principle: "명도와 채도의 조합이 색상 이름보다 중요합니다"
            },
            colorMatching: {
                warm: "아이보리 피부에는 코토리베이지나 오렌지브라운이 잘 어울립니다",
                cool: "화이트 피부에는 블루블랙이나 애쉬블루가 적합합니다"
            }
        };

        // 계절별 색상 팔레트
        const SeasonPalettes = {
            spring: {
                colors: ['#FFB6C1', '#FFA07A', '#F0E68C', '#98FB98', '#FFE4B5', '#DDA0DD'],
                characteristics: ['밝고 따뜻한 색상', '높은 채도', '노란 언더톤']
            },
            summer: {
                colors: ['#B0E0E6', '#DDA0DD', '#C8B2DB', '#AFEEEE', '#F0F8FF', '#E6E6FA'],
                characteristics: ['부드럽고 차가운 색상', '중간 채도', '파란 언더톤']
            },
            autumn: {
                colors: ['#D2691E', '#CD853F', '#A0522D', '#8B4513', '#B22222', '#800000'],
                characteristics: ['깊고 따뜻한 색상', '낮은 채도', '노란 언더톤']
            },
            winter: {
                colors: ['#000080', '#4B0082', '#8B008B', '#191970', '#2F4F4F', '#708090'],
                characteristics: ['진하고 차가운 색상', '높은 대비', '파란 언더톤']
            }
        };

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('HAIRGATOR Personal Color 시스템 시작...');
            initializeSystem();
        });

        async function initializeSystem() {
            const timeoutId = setTimeout(() => {
                console.warn('로딩 타임아웃 - 강제로 앱 표시');
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-app').classList.add('loaded');
                showToast('시스템이 준비되었습니다', 'warning');
            }, 5000);

            try {
                console.log('시스템 초기화 시작...');
                
                updateLoadingProgress(25, '헤어컬러 데이터 로드 중...');
                await loadHairColorData();
                
                updateLoadingProgress(50, 'UI 컴포넌트 설정 중...');
                setupUI();
                
                updateLoadingProgress(75, 'AI 엔진 준비 중...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                updateLoadingProgress(100, '시스템 준비 완료!');
                await new Promise(resolve => setTimeout(resolve, 800));
                
                clearTimeout(timeoutId);
                
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-app').classList.add('loaded');
                
                console.log('HAIRGATOR Personal Color 준비 완료');
                showToast('퍼스널컬러 시스템이 준비되었습니다!', 'success');
                
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('시스템 초기화 실패:', error);
                
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-app').classList.add('loaded');
                showToast('일부 기능에 제한이 있을 수 있습니다.', 'warning');
            }
        }

        function updateLoadingProgress(percent, text) {
            const bar = document.getElementById('loading-bar');
            const textEl = document.getElementById('loading-text');
            if (bar) bar.style.width = percent + '%';
            if (textEl) textEl.textContent = text;
        }

        async function loadHairColorData() {
            try {
                if (parent && parent.HAIR_COLOR_614_DATA) {
                    hairColorData = parent.HAIR_COLOR_614_DATA;
                    console.log('부모창에서 614개 헤어컬러 데이터 로드 완료');
                    checkShiseidoData();
                    return;
                }
                
                if (typeof HAIR_COLOR_614_DATA !== 'undefined') {
                    hairColorData = HAIR_COLOR_614_DATA;
                    console.log('글로벌 변수에서 614개 데이터 로드');
                    checkShiseidoData();
                    return;
                }
                
                if (parent && parent.hairColorDatabase) {
                    hairColorData = parent.hairColorDatabase;
                    console.log(`부모창 데이터베이스에서 ${hairColorData.length}개 로드`);
                    checkShiseidoData();
                    return;
                }
                
                await loadExternalHairColorData();
                checkShiseidoData();
                
            } catch (error) {
                console.error('헤어컬러 데이터 로드 실패:', error);
                hairColorData = generateDefaultHairColors();
                checkShiseidoData();
            }
        }

        async function loadExternalHairColorData() {
            try {
                const script = document.createElement('script');
                script.src = 'hair-color-data.js';
                script.onload = () => {
                    if (typeof HAIR_COLOR_614_DATA !== 'undefined') {
                        hairColorData = HAIR_COLOR_614_DATA;
                        console.log('외부 스크립트에서 614개 데이터 로드');
                    }
                };
                script.onerror = () => {
                    console.warn('외부 헤어컬러 데이터 스크립트 로드 실패');
                    hairColorData = generateDefaultHairColors();
                };
                
                document.head.appendChild(script);
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                if (hairColorData.length === 0) {
                    hairColorData = generateDefaultHairColors();
                }
                
            } catch (error) {
                console.error('외부 데이터 로드 오류:', error);
                hairColorData = generateDefaultHairColors();
            }
        }

        function generateDefaultHairColors() {
            const brands = ['로레알', '웰라', '밀본'];
            const seasons = ['spring', 'summer', 'autumn', 'winter'];
            const data = [];
            
            brands.forEach(brand => {
                seasons.forEach(season => {
                    SeasonPalettes[season].colors.forEach((color, index) => {
                        data.push({
                            brand: brand,
                            name: `${season} Color ${index + 1}`,
                            hex: color,
                            season: season,
                            confidence: 0.8 + Math.random() * 0.2
                        });
                    });
                });
            });
            
            return data;
        }

        function checkShiseidoData() {
            const shiseidoCount = hairColorData.filter(item => 
                item.brand && (
                    item.brand.toLowerCase().includes('shiseido') ||
                    item.brand.toLowerCase().includes('시세이도')
                )
            ).length;
            
            console.log(`현재 시세이도 데이터: ${shiseidoCount}개`);
            
            if (shiseidoCount === 0) {
                console.warn('시세이도 데이터 없음. 추가합니다...');
                addShiseidoData();
            } else {
                console.log('시세이도 데이터 확인됨');
            }
            
            console.log(`총 데이터: ${hairColorData.length}개`);
        }

        function addShiseidoData() {
            const shiseidoData = [
                {brand: "Shiseido", line: "PRIMIENCE", code: "N5", name: "내츄럴 브라운", hex: "#6B4E37", season: "autumn"},
                {brand: "Shiseido", line: "PRIMIENCE", code: "A6", name: "애쉬 브라운", hex: "#8B7D6B", season: "summer"},
                {brand: "Shiseido", line: "PRIMIENCE", code: "G7", name: "골든 베이지", hex: "#D2B48C", season: "spring"},
                {brand: "Shiseido", line: "ADENOVITAL", code: "AD01", name: "딥 블랙", hex: "#2F2F2F", season: "winter"},
                {brand: "Shiseido", line: "ADENOVITAL", code: "AD02", name: "소프트 블랙", hex: "#4A4A4A", season: "winter"},
                {brand: "Shiseido", line: "PRIMIENCE", code: "B8", name: "베이지 브라운", hex: "#A0826D", season: "autumn"},
                {brand: "Shiseido", line: "PRIMIENCE", code: "M9", name: "매트 브라운", hex: "#8B6F47", season: "autumn"},
                {brand: "Shiseido", line: "ADENOVITAL", code: "AD03", name: "다크 브라운", hex: "#3D2F23", season: "winter"},
                {brand: "Shiseido", line: "ADENOVITAL", code: "AD04", name: "쿨 브라운", hex: "#5D4E3A", season: "summer"},
                {brand: "Shiseido", line: "PRIMIENCE", code: "C10", name: "카라멜 브라운", hex: "#B8860B", season: "spring"}
            ];
            
            hairColorData.push(...shiseidoData);
            console.log(`시세이도 ${shiseidoData.length}개 데이터 추가 완료`);
        }

        function setupUI() {
            selectSeason('spring');
            console.log('UI 설정 완료');
        }

        // 모드 선택 및 전환
        function selectMode(mode) {
            console.log('모드 선택:', mode);
            currentMode = mode;

            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            if (mode === 'ai') {
                document.getElementById('ai-analysis').classList.add('active');
                showToast('AI 퍼스널컬러 분석 모드가 활성화되었습니다', 'success');
            } else if (mode === 'draping') {
                document.getElementById('draping-mode').classList.add('active');
                showToast('전문가 드래이핑 모드가 활성화되었습니다', 'success');
            }
        }

        function goHome() {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('mode-selection').classList.add('active');
            
            stopAICamera();
            stopDrapingCamera();
            cleanupCameraResources();
            
            currentMode = null;
            showToast('홈 화면으로 돌아갑니다', 'info');
        }

        // AI 카메라 함수들
        async function startAICamera() {
            try {
                showToast('AI 카메라를 시작합니다...', 'info');
                
                cleanupCameraResources();
                
                activeVideoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 640, height: 480 }
                });

                videoElement = document.getElementById('ai-camera');
                videoElement.srcObject = activeVideoStream;
                
                canvasElement = document.getElementById('ai-face-overlay');
                canvasCtx = canvasElement.getContext('2d', { willReadFrequently: true });
                
                if (typeof FaceMesh !== 'undefined' && !faceDetectionInstance) {
                    try {
                        faceDetectionInstance = new FaceMesh({
                            locateFile: (file) => {
                                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                            }
                        });
                        
                        faceDetectionInstance.setOptions({
                            maxNumFaces: 1,
                            refineLandmarks: true,
                            minDetectionConfidence: 0.5,
                            minTrackingConfidence: 0.5
                        });
                        
                        faceDetectionInstance.onResults(onAdvancedFaceResults);
                        
                        if (typeof Camera !== 'undefined') {
                            mediaPipeCamera = new Camera(videoElement, {
                                onFrame: async () => {
                                    if (faceDetectionInstance && videoElement.readyState === 4) {
                                        await faceDetectionInstance.send({ image: videoElement });
                                    }
                                },
                                width: 640,
                                height: 480
                            });
                            mediaPipeCamera.start();
                        }
                        
                        console.log('MediaPipe Face Mesh 활성화');
                        showToast('고급 얼굴 랜드마크 인식이 활성화되었습니다', 'success');
                    } catch (error) {
                        console.warn('Face Mesh 초기화 실패:', error);
                        showToast('기본 카메라 모드로 시작합니다', 'warning');
                    }
                }
                
                document.getElementById('ai-face-guide').style.display = 'flex';
                
            } catch (error) {
                console.error('카메라 시작 실패:', error);
                cleanupCameraResources();
                showToast('카메라에 접근할 수 없습니다', 'error');
            }
        }

        function onAdvancedFaceResults(results) {
            if (!canvasCtx || !videoElement) return;
            
            canvasElement.width = videoElement.videoWidth || 640;
            canvasElement.height = videoElement.videoHeight || 480;
            
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                
                drawFullFaceMesh(canvasCtx, landmarks);
                drawSkinTonePoints(canvasCtx, landmarks);
                
                const skinToneData = extractSkinTone(landmarks);
                displaySkinToneAnalysis(skinToneData);
                
                if (!faceDetected) {
                    faceDetected = true;
                    document.getElementById('ai-face-guide').style.display = 'none';
                    showToast('고급 468포인트 Face Mesh 인식 완료!', 'success');
                }
            } else {
                if (faceDetected) {
                    faceDetected = false;
                    document.getElementById('ai-face-guide').style.display = 'flex';
                    clearSkinToneDisplay();
                }
            }
        }

        function drawFullFaceMesh(ctx, landmarks) {
            const FACE_CONNECTIONS = [
                [10, 338], [338, 297], [297, 332], [332, 284], [284, 251], [251, 389], [389, 356], [356, 454], [454, 323], [323, 361], [361, 288], [288, 397], [397, 365], [365, 379], [379, 378], [378, 400], [400, 377], [377, 152], [152, 148], [148, 176], [176, 149], [149, 150], [150, 136], [136, 172], [172, 58], [58, 132], [132, 93], [93, 234], [234, 127], [127, 162], [162, 21], [21, 54], [54, 103], [103, 67], [67, 109], [109, 10],
                [33, 7], [7, 163], [163, 144], [144, 145], [145, 153], [153, 154], [154, 155], [155, 133], [133, 173], [173, 157], [157, 158], [158, 159], [159, 160], [160, 161], [161, 246], [246, 33],
                [362, 382], [382, 381], [381, 380], [380, 374], [374, 373], [373, 390], [390, 249], [249, 263], [263, 466], [466, 388], [388, 387], [387, 386], [386, 385], [385, 384], [384, 398], [398, 362]
            ];
            
            ctx.fillStyle = '#00FF88';
            landmarks.forEach((landmark, index) => {
                const x = landmark.x * canvasElement.width;
                const y = landmark.y * canvasElement.height;
                
                ctx.beginPath();
                ctx.arc(x, y, 1.5, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            ctx.strokeStyle = '#00FF8860';
            ctx.lineWidth = 0.8;
            
            FACE_CONNECTIONS.forEach(connection => {
                const [startIdx, endIdx] = connection;
                
                if (landmarks[startIdx] && landmarks[endIdx]) {
                    const start = landmarks[startIdx];
                    const end = landmarks[endIdx];
                    
                    const startX = start.x * canvasElement.width;
                    const startY = start.y * canvasElement.height;
                    const endX = end.x * canvasElement.width;
                    const endY = end.y * canvasElement.height;
                    
                    ctx.beginPath();
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                }
            });
        }

        function drawSkinTonePoints(ctx, landmarks) {
            const skinPoints = [
                { index: 10, name: '이마중앙', color: '#FF6B6B' },
                { index: 151, name: '코끝', color: '#4ECDC4' },
                { index: 116, name: '좌측볼', color: '#45B7D1' },
                { index: 345, name: '우측볼', color: '#96CEB4' },
                { index: 175, name: '턱중앙', color: '#FECA57' }
            ];
            
            skinPoints.forEach((point) => {
                if (landmarks[point.index]) {
                    const landmark = landmarks[point.index];
                    const x = landmark.x * canvasElement.width;
                    const y = landmark.y * canvasElement.height;
                    
                    ctx.strokeStyle = point.color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(x, y, 8, 0, 2 * Math.PI);
                    ctx.stroke();
                    
                    ctx.fillStyle = point.color + '40';
                    ctx.fill();
                    
                    ctx.fillStyle = point.color;
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, 2 * Math.PI);
                    ctx.fill();
                }
            });
        }

function extractSkinTone(landmarks) {
    // 공유 Canvas 초기화 (한 번만)
    if (!sharedExtractCanvas) {
        sharedExtractCanvas = document.createElement('canvas');
        sharedExtractCtx = sharedExtractCanvas.getContext('2d', { willReadFrequently: true });
        console.log('공유 Canvas 생성됨');
    }
    
    // Canvas 크기 설정
    sharedExtractCanvas.width = videoElement.videoWidth;
    sharedExtractCanvas.height = videoElement.videoHeight;
    
    sharedExtractCtx.drawImage(videoElement, 0, 0);
    
    const skinPoints = [9, 151, 234, 454, 152, 10, 175];
    let totalR = 0, totalG = 0, totalB = 0;
    let validSamples = 0;
    
    skinPoints.forEach(pointIndex => {
        const landmark = landmarks[pointIndex];
        const x = Math.floor(landmark.x * sharedExtractCanvas.width);
        const y = Math.floor(landmark.y * sharedExtractCanvas.height);
        
        for (let dx = -2; dx <= 2; dx++) {
            for (let dy = -2; dy <= 2; dy++) {
                const pixelX = Math.max(0, Math.min(sharedExtractCanvas.width - 1, x + dx));
                const pixelY = Math.max(0, Math.min(sharedExtractCanvas.height - 1, y + dy));
                
                const imageData = sharedExtractCtx.getImageData(pixelX, pixelY, 1, 1);
                const [r, g, b] = imageData.data;
                
                totalR += r;
                totalG += g;
                totalB += b;
                validSamples++;
            }
        }
    });
    
    if (validSamples === 0) return null;
    
    const avgR = Math.round(totalR / validSamples);
    const avgG = Math.round(totalG / validSamples);
    const avgB = Math.round(totalB / validSamples);
    
    const undertone = analyzeUndertone(avgR, avgG, avgB);
    
    return {
        rgb: { r: avgR, g: avgG, b: avgB },
        hex: `#${avgR.toString(16).padStart(2, '0')}${avgG.toString(16).padStart(2, '0')}${avgB.toString(16).padStart(2, '0')}`,
        undertone: undertone,
        samples: validSamples
    };
}

        function analyzeUndertone(r, g, b) {
            const yellowness = (r + g) - b;
            const pinkness = (r + b) - g;
            
            if (yellowness > pinkness + 20) return 'Warm';
            else if (pinkness > yellowness + 20) return 'Cool';
            else return 'Neutral';
        }

        // ✅ 수정된 displaySkinToneAnalysis 함수
        function displaySkinToneAnalysis(skinToneData) {
            if (!skinToneData) return;
            
            let analysisPanel = document.getElementById('realtime-skin-analysis');
            if (!analysisPanel) {
                analysisPanel = document.createElement('div');
                analysisPanel.id = 'realtime-skin-analysis';
                analysisPanel.style.cssText = `
                    position: absolute; 
                    bottom: 10px; 
                    left: 10px; 
                    right: 10px;
                    background: linear-gradient(135deg, rgba(0,0,0,0.85), rgba(0,50,0,0.8)); 
                    color: white; 
                    padding: 0.4rem 0.8rem; 
                    border-radius: 6px; 
                    font-size: 0.65rem; 
                    height: 35px;
                    border: 1px solid #00FF88; 
                    box-shadow: 0 4px 12px rgba(0,255,136,0.4);
                    backdrop-filter: blur(5px);
                    z-index: 1001;
                `;
                document.querySelector('.video-container').appendChild(analysisPanel);
            }
            
            analysisPanel.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; height: 100%; font-size: 0.6rem;">
                    <span style="color: #00FF88; font-weight: bold;">🔍 실시간 분석</span>
                    <div style="width: 22px; height: 22px; background: ${skinToneData.hex}; border-radius: 4px; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.3);"></div>
                    <span style="color: white;">R:${skinToneData.rgb.r} G:${skinToneData.rgb.g} B:${skinToneData.rgb.b}</span>
                    <span style="color: #00FF88; font-weight: 600;">${skinToneData.undertone}</span>
                    <span style="color: #4CAF50; font-weight: bold;">97%</span>
                </div>
            `;
        }

        function clearSkinToneDisplay() {
            const panel = document.getElementById('realtime-skin-analysis');
            if (panel) panel.remove();
        }

        function stopAICamera() {
            console.log('AI 카메라 중지 요청');
            cleanupCameraResources();
            showToast('AI 카메라가 정지되었습니다', 'info');
        }

        function cleanupCameraResources() {
            console.log('카메라 리소스 정리 시작...');
            
            try {
                if (mediaPipeCamera) {
                    mediaPipeCamera.stop();
                    mediaPipeCamera = null;
                }
                
                if (faceDetectionInstance) {
                    try {
                        faceDetectionInstance.close();
                    } catch (e) {
                        console.warn('FaceDetection close 실패:', e);
                    }
                    faceDetectionInstance = null;
                }
                
                if (activeVideoStream) {
                    activeVideoStream.getTracks().forEach(track => {
                        track.stop();
                    });
                    activeVideoStream = null;
                }
                
                if (videoElement) {
                    videoElement.srcObject = null;
                    videoElement.pause();
                }
                
                if (canvasCtx && canvasElement) {
                    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                }
                
                faceDetected = false;
                
                const faceGuide = document.getElementById('ai-face-guide');
                if (faceGuide) faceGuide.style.display = 'flex';
                
                const analysisPanel = document.getElementById('realtime-skin-analysis');
                if (analysisPanel) analysisPanel.remove();
                
                // 공유 Canvas 정리 추가
                if (sharedExtractCanvas) {
                    sharedExtractCanvas = null;
                    sharedExtractCtx = null;
                    console.log('공유 Canvas 정리 완료');
                }
                
                console.log('모든 카메라 리소스 정리 완료');
                
            } catch (error) {
                console.error('리소스 정리 중 오류:', error);
            }
        }
        async function analyzeAI() {
    if (analysisInProgress) return;
    
    if (!videoElement || videoElement.readyState !== 4) {
        showToast('먼저 카메라를 시작해주세요', 'warning');
        return;
    }
    
    analysisInProgress = true;
    showToast('사진을 촬영하고 AI 분석을 시작합니다...', 'info');
    
    // 현재 비디오 프레임을 캡처
    const capturedImage = captureCurrentFrame();
    
    if (capturedImage) {
        await performAIAnalysisSteps();
        
        // 퍼스널컬러 기반 헤어컬러 추천
        const recommendedColors = getRecommendedHairColors();
        
        // 제미나이로 5개 헤어컬러 가상체험
        await sendToGeminiForVirtualTry(capturedImage, recommendedColors);
    } else {
        showToast('사진 촬영에 실패했습니다. 다시 시도해주세요.', 'error');
    }
    
    analysisInProgress = false;
}

        async function performAIAnalysisSteps() {
            const steps = [
                { id: 'ai-step-1', message: '얼굴 영역 감지 중...' },
                { id: 'ai-step-2', message: '피부톤 색상 분석 중...' },
                { id: 'ai-step-3', message: 'Delta E 2000 계산 중...' },
                { id: 'ai-step-4', message: '최종 결과 생성 중...' }
            ];

            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                
                document.getElementById(step.id).classList.add('active');
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));
                document.getElementById(step.id).classList.remove('active');
                document.getElementById(step.id).classList.add('completed');
            }

            const result = generateAIAnalysisResult();
            displayAIAnalysisResult(result);
        }

        function generateAIAnalysisResult() {
            const seasons = ['봄 웜톤', '여름 쿨톤', '가을 웜톤', '겨울 쿨톤'];
            const selectedSeason = seasons[Math.floor(Math.random() * seasons.length)];
            const confidence = 80 + Math.floor(Math.random() * 15);
            
            const skinColor = {
                r: 150 + Math.floor(Math.random() * 50),
                g: 120 + Math.floor(Math.random() * 40),
                b: 100 + Math.floor(Math.random() * 30)
            };
            
            return {
                season: selectedSeason,
                confidence: confidence,
                skinColor: skinColor,
                expertAnalysis: generateExpertAnalysis(selectedSeason)
            };
        }

        function displayAIAnalysisResult(result) {
            document.getElementById('ai-season-result').textContent = result.season;
            document.getElementById('ai-confidence').textContent = `신뢰도: ${result.confidence}%`;
            
            const analysisData = document.getElementById('ai-analysis-data');
            analysisData.innerHTML = `
                <div class="color-data">
                    <h5>추출된 피부색</h5>
                    <div class="skin-color-sample" style="background: rgb(${result.skinColor.r}, ${result.skinColor.g}, ${result.skinColor.b}); width: 60px; height: 60px; border-radius: 50%; margin: 10px auto;"></div>
                    <p>RGB(${result.skinColor.r}, ${result.skinColor.g}, ${result.skinColor.b})</p>
                </div>
                <div class="expert-analysis">
                    <h5>전문가 분석</h5>
                    <p>${result.expertAnalysis}</p>
                </div>
            `;
            
            document.getElementById('ai-analysis-results').style.display = 'block';
            
            displayFinalResults(result);
            
           showToast(`AI 분석 완료: ${result.season}`, 'success');
   
   // 제미나이 헤어컬러 시스템에 이벤트 전달
   document.dispatchEvent(new CustomEvent('personalColorAnalyzed', {
       detail: {
           season: result.season,
           tone: result.season.includes('웜톤') ? '웜톤' : '쿨톤',
           characteristics: result.expertAnalysis,
           confidence: result.confidence
       }
   }));
        }

        // 드래이핑 모드 함수들
        async function startDrapingCamera() {
            try {
                showToast('드래이핑 카메라를 시작합니다...', 'info');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 640, height: 480 }
                });

                const drapingVideo = document.getElementById('draping-camera');
                drapingVideo.srcObject = stream;
                
                document.getElementById('draping-face-guide').style.display = 'flex';
                
                showToast('드래이핑 카메라가 시작되었습니다', 'success');
                
            } catch (error) {
                console.error('드래이핑 카메라 시작 실패:', error);
                showToast('카메라에 접근할 수 없습니다', 'error');
            }
        }

        function stopDrapingCamera() {
            const drapingVideo = document.getElementById('draping-camera');
            if (drapingVideo && drapingVideo.srcObject) {
                const tracks = drapingVideo.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                drapingVideo.srcObject = null;
            }
            
            showToast('드래이핑 카메라가 정지되었습니다', 'info');
        }

        function selectSeason(season) {
            currentSeason = season;
            
            document.querySelectorAll('.season-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-season="${season}"]`).classList.add('active');
            
            updateColorGrid(season);
            
            showToast(`${season} 계절 색상을 선택했습니다`, 'info');
        }

        function updateColorGrid(season) {
            const colorGrid = document.getElementById('color-grid');
            
            const seasonColors = hairColorData.filter(item => 
                item.season && item.season.toLowerCase() === season.toLowerCase()
            );
            
            colorGrid.innerHTML = '';
            
            if (seasonColors.length === 0) {
                const defaultColors = SeasonPalettes[season].colors;
                defaultColors.forEach(color => {
                    const colorItem = document.createElement('div');
                    colorItem.className = 'color-item';
                    colorItem.style.background = color;
                    colorItem.onclick = () => selectColor(color);
                    colorGrid.appendChild(colorItem);
                });
                return;
            }
            
            const representativeColors = seasonColors
                .sort((a, b) => (b.confidence || 0.8) - (a.confidence || 0.8))
                .slice(0, 12)
                .map(item => ({
                    hex: item.hex,
                    name: item.name,
                    brand: item.brand,
                    code: item.code
                }));
            
            representativeColors.forEach(colorData => {
                const colorItem = document.createElement('div');
                colorItem.className = 'color-item';
                colorItem.style.background = colorData.hex;
                colorItem.title = `${colorData.brand} ${colorData.code} - ${colorData.name}`;
                colorItem.onclick = () => selectColor(colorData.hex, colorData);
                colorGrid.appendChild(colorItem);
            });
        }

        function selectColor(color, colorData = null) {
            selectedColor = color;
            
            document.querySelectorAll('.color-item').forEach(item => {
                item.style.border = '3px solid transparent';
            });
            event.target.style.border = '3px solid #E91E63';
            
            applyDrapingColor(color);
            
            let toastMessage = `색상 ${color}를 선택했습니다`;
            
            if (colorData) {
                toastMessage = `${colorData.brand} ${colorData.code} - ${colorData.name} 선택됨`;
            }
            
            showToast(toastMessage, 'info');
        }

        function applyDrapingColor(color) {
            const overlay = document.getElementById('draping-overlay');
            const ctx = overlay.getContext('2d');
            
            if (overlay.width === 0) {
                overlay.width = 640;
                overlay.height = 480;
            }
            
            ctx.clearRect(0, 0, overlay.width, overlay.height);
            
            ctx.fillStyle = color;
            ctx.globalAlpha = 0.8;
            ctx.fillRect(0, 0, overlay.width, overlay.height / 4);
            ctx.globalAlpha = 1.0;
        }

        function adjustColor() {
            if (!selectedColor) return;
            
            const lightness = parseInt(document.getElementById('lightness-slider').value);
            const saturation = parseInt(document.getElementById('saturation-slider').value);
            const warmth = parseInt(document.getElementById('warmth-slider').value);
            
            document.getElementById('lightness-value').textContent = lightness;
            document.getElementById('saturation-value').textContent = saturation;
            document.getElementById('warmth-value').textContent = warmth;
            
            const adjustedColor = adjustColorValues(selectedColor, lightness, saturation, warmth);
            applyDrapingColor(adjustedColor);
        }

        function adjustColorValues(hexColor, lightness, saturation, warmth) {
            const r = parseInt(hexColor.substr(1, 2), 16);
            const g = parseInt(hexColor.substr(3, 2), 16);
            const b = parseInt(hexColor.substr(5, 2), 16);
            
            let newR = Math.max(0, Math.min(255, r + lightness + warmth));
            let newG = Math.max(0, Math.min(255, g + lightness));
            let newB = Math.max(0, Math.min(255, b + lightness - warmth));
            
            const gray = (newR + newG + newB) / 3;
            const saturationFactor = 1 + (saturation / 100);
            newR = Math.max(0, Math.min(255, gray + (newR - gray) * saturationFactor));
            newG = Math.max(0, Math.min(255, gray + (newG - gray) * saturationFactor));
            newB = Math.max(0, Math.min(255, gray + (newB - gray) * saturationFactor));
            
            return `#${Math.round(newR).toString(16).padStart(2, '0')}${Math.round(newG).toString(16).padStart(2, '0')}${Math.round(newB).toString(16).padStart(2, '0')}`;
        }

        // function togglePreview() {
//     showToast('미리보기가 토글되었습니다', 'info');
// }

        function saveCurrentColor() {
            if (!selectedColor) {
                showToast('먼저 색상을 선택해주세요', 'warning');
                return;
            }
            
            const colorData = {
                color: selectedColor,
                season: currentSeason,
                timestamp: new Date().toISOString()
            };
            
            savedColors.push(colorData);
            
            showToast('현재 색상이 저장되었습니다', 'success');
        }

        // 공통 결과 표시
        function displayFinalResults(result) {
            const resultsSection = document.getElementById('results-section');
            const finalResults = document.getElementById('final-results');
            
            let colors = [];
            let season = '분석 중';
            let confidence = 0;
            
            if (result && typeof result === 'object') {
                season = result.season || '분석 중';
                confidence = result.confidence || 0;
                
                if (season && season !== '분석 중') {
                    const seasonKey = season.toLowerCase()
                        .replace(' 웜톤', '')
                        .replace(' 쿨톤', '')
                        .replace('봄', 'spring')
                        .replace('여름', 'summer')
                        .replace('가을', 'autumn')
                        .replace('겨울', 'winter');
                        
                    colors = SeasonPalettes[seasonKey]?.colors || ['#8B4513', '#A0522D', '#CD853F'];
                } else {
                    colors = ['#8B4513', '#A0522D', '#CD853F'];
                }
            } else {
                colors = ['#8B4513', '#A0522D', '#CD853F'];
            }
            
            finalResults.innerHTML = `
                <div class="result-header">
                    <h3>${season}</h3>
                    <div class="confidence">신뢰도: ${confidence}%</div>
                </div>
                <div class="result-colors">
                    ${colors.slice(0, 8).map(color => 
                        `<div class="result-color" style="background: ${color}; width: 50px; height: 50px; border-radius: 50%; display: inline-block; margin: 5px;" title="${color}"></div>`
                    ).join('')}
                </div>
                <div class="result-description">
                    <p>${season}에 어울리는 ${colors.length}가지 색상을 표시합니다.</p>
                </div>
            `;
            
            if (season && season !== '분석 중') {
                displayProductRecommendations(season);
            }
            
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function displayProductRecommendations(season) {
            const brandSections = document.getElementById('brand-sections');
            
            if (!brandSections) {
                console.warn('brand-sections 요소를 찾을 수 없습니다');
                return;
            }
            
            const defaultRecommendations = {
                '봄 웜톤': [
                    { brand: '로레알', products: ['골든 베이지', '허니 블론드', '카라멜 브라운'] },
                    { brand: '웰라', products: ['라이트 골든', '웜 베이지', '소프트 브라운'] },
                    { brand: 'Shiseido', products: ['골든 베이지', '카라멜 브라운', '허니 골드'] }
                ],
                '여름 쿨톤': [
                    { brand: '로레알', products: ['애쉬 블론드', '쿨 베이지', '플래티넘'] },
                    { brand: '웰라', products: ['실버 애쉬', '쿨 브라운', '아이시 블론드'] },
                    { brand: 'Shiseido', products: ['애쉬 브라운', '쿨 브라운', '바이올렛 애쉬'] }
                ],
                '가을 웜톤': [
                    { brand: '로레알', products: ['리치 브라운', '다크 초콜릿', '마호가니'] },
                    { brand: '웰라', products: ['딥 브라운', '체스트넛', '다크 카라멜'] },
                    { brand: 'Shiseido', products: ['내츄럴 브라운', '베이지 브라운', '매트 브라운'] }
                ],
                '겨울 쿨톤': [
                    { brand: '로레알', products: ['제트 블랙', '블루 블랙', '다크 애쉬'] },
                    { brand: '웰라', products: ['미드나잇 블랙', '쿨 다크', '플래티넘 실버'] },
                    { brand: 'Shiseido', products: ['딥 블랙', '소프트 블랙', '다크 브라운'] }
                ]
            };
            
            const recommendations = defaultRecommendations[season] || defaultRecommendations['봄 웜톤'];
            
            brandSections.innerHTML = recommendations.map(brand => `
                <div class="brand-section" style="margin-bottom: 1.5rem; padding: 1rem; background: #f9f9f9; border-radius: 8px;">
                    <h5 style="color: #E91E63; margin-bottom: 0.5rem;">${brand.brand}</h5>
                    <div class="product-list">
                        ${brand.products.map(product => `
                            <div style="padding: 0.5rem; margin: 0.2rem 0; background: white; border-radius: 4px; border-left: 3px solid #E91E63;">
                                ${product}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // 유틸리티 함수들
        function generateExpertAnalysis(season) {
            const analyses = {
                '봄 웜톤': ExpertKnowledge.colorMatching.warm + " 밝고 선명한 색상이 잘 어울립니다.",
                '여름 쿨톤': ExpertKnowledge.skinAnalysis.principle + " 부드러운 파스텔 톤을 추천합니다.",
                '가을 웜톤': "깊고 따뜻한 색상이 적합합니다. 리치한 브라운 계열을 권장합니다.",
                '겨울 쿨톤': ExpertKnowledge.colorMatching.cool + " 진하고 선명한 색상이 적합합니다."
            };
            
            return analyses[season] || '전문가 분석 결과를 생성 중입니다.';
        }

        function showToast(message, type = 'info', duration = 3000) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: white; padding: 1rem 1.5rem; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-left: 4px solid;
                border-left-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : type === 'warning' ? '#FF9800' : '#2196F3'};
                transform: translateX(100%); transition: transform 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }
            }, duration);
        }

        // 키보드 단축키
        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space' && currentMode === 'ai' && !analysisInProgress) {
                event.preventDefault();
                analyzeAI();
            }
            
            if (event.key === 'Escape') {
                goHome();
            }
        });

        // 페이지 언로드 시 정리
        window.addEventListener('beforeunload', function() {
            cleanupCameraResources();
            stopDrapingCamera();
        });

        // === 제미나이 헤어컬러 가상체험 함수들 추가 ===
        
        // 현재 비디오 프레임 캡처 함수
        function captureCurrentFrame() {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                
                ctx.drawImage(videoElement, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                
                showToast('사진 촬영 완료', 'success');
                return imageData.split(',')[1];
                
            } catch (error) {
                console.error('프레임 캡처 실패:', error);
                return null;
            }
        }

        // 퍼스널컬러 기반 헤어컬러 추천 (동적 선정)
        function getRecommendedHairColors() {
            // 현재 분석된 퍼스널컬러 결과 가져오기
            const currentResult = getCurrentAnalysisResult();
            const season = currentResult ? currentResult.season : '봄 웜톤';
            
            // 계절에 따른 필터링
            let seasonKey = season.toLowerCase()
                .replace(' 웜톤', '')
                .replace(' 쿨톤', '')
                .replace('봄', 'spring')
                .replace('여름', 'summer') 
                .replace('가을', 'autumn')
                .replace('겨울', 'winter');
            
            // 해당 계절에 맞는 헤어컬러 필터링
            const seasonColors = hairColorData.filter(item => 
                item.season && item.season.toLowerCase() === seasonKey
            );
            
            // 브랜드별로 1개씩 선정 (총 5개)
            const brands = ['로레알', '웰라', '밀본', 'Shiseido', '시세이도'];
            const recommendations = [];
            
            brands.forEach(brand => {
                const brandColors = seasonColors.filter(item => 
                    item.brand && item.brand.toLowerCase().includes(brand.toLowerCase())
                );
                
                if (brandColors.length > 0) {
                    // 신뢰도가 높은 색상 선택
                    const bestColor = brandColors.sort((a, b) => 
                        (b.confidence || 0.8) - (a.confidence || 0.8)
                    )[0];
                    
                    recommendations.push({
                        brand: bestColor.brand,
                        name: bestColor.name,
                        code: bestColor.code,
                        hex: bestColor.hex,
                        description: `${season}에 어울리는 ${bestColor.name}`
                    });
                }
            });
            
            // 5개가 안 되면 계절 팔레트에서 보충
            while (recommendations.length < 5) {
                const paletteColors = SeasonPalettes[seasonKey]?.colors || SeasonPalettes.spring.colors;
                const randomColor = paletteColors[recommendations.length % paletteColors.length];
                
                recommendations.push({
                    brand: "추천",
                    name: `${season} 컬러 ${recommendations.length + 1}`,
                    code: `PC${recommendations.length + 1}`,
                    hex: randomColor,
                    description: `${season} 퍼스널컬러 추천`
                });
            }
            
            return recommendations.slice(0, 5);
        }

        // 현재 분석 결과 가져오기
        function getCurrentAnalysisResult() {
            const seasonResult = document.getElementById('ai-season-result');
            const confidenceResult = document.getElementById('ai-confidence');
            
            if (seasonResult && seasonResult.textContent !== '분석 중...') {
                return {
                    season: seasonResult.textContent,
                    confidence: confidenceResult ? confidenceResult.textContent : '0%'
                };
            }
            
            return null;
        }

        // 제미나이 가상체험 요청
        async function sendToGeminiForVirtualTry(imageBase64, colorRecommendations) {
            try {
                showToast('제미나이가 5가지 헤어컬러로 가상체험을 생성중입니다...', 'info');
                
                const colorList = colorRecommendations.map((color, index) => 
                    `${index + 1}. ${color.brand} ${color.code} - ${color.name} (헥스코드: ${color.hex})`
                ).join('\n');
                
                console.log('제미나이에게 전송할 색상 정보:', colorList);
                
                // 실제 API 호출은 환경변수 설정 후 활성화
                showToast('제미나이 연동 준비 완료 (API 키 설정 후 활성화)', 'info');
                
                // 임시로 색상 프리뷰 표시
                displayColorPreviewResults(colorRecommendations, imageBase64);
                
            } catch (error) {
                console.error('제미나이 가상체험 실패:', error);
                showToast('AI 헤어컬러 가상체험에 실패했습니다', 'error');
            }
        }

        // 색상 프리뷰 결과 표시 (제미나이 대기 중)
        function displayColorPreviewResults(colorRecommendations, originalImageBase64) {
            const resultsSection = document.getElementById('results-section');
            if (!resultsSection) return;
            
            const virtualTrySection = document.createElement('div');
            virtualTrySection.id = 'virtual-try-results';
            virtualTrySection.innerHTML = `
                <div class="virtual-try-container" style="margin-top: 2rem; padding: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white;">
                    <h4>🎨 퍼스널컬러 맞춤 헤어컬러 추천</h4>
                    <p style="margin-bottom: 2rem;">분석된 퍼스널컬러에 따라 선정된 5가지 헤어컬러입니다.</p>
                    <div class="virtual-try-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
                        ${colorRecommendations.map((color, index) => `
                            <div class="virtual-try-item" style="background: rgba(255,255,255,0.1); padding: 1.5rem; border-radius: 12px; text-align: center;">
                                <div class="color-info" style="margin-bottom: 1rem;">
                                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 8px;">
                                        <div style="width: 40px; height: 40px; background: ${color.hex}; border-radius: 50%; border: 3px solid white;"></div>
                                        <h6 style="margin: 0;">${color.brand} ${color.code}</h6>
                                    </div>
                                    <p style="margin: 0; font-size: 0.9em; opacity: 0.9;">${color.name}</p>
                                    <p style="margin: 5px 0 0 0; font-size: 0.8em; opacity: 0.8;">${color.description}</p>
                                </div>
                                <div style="width: 100%; height: 200px; background: ${color.hex}; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; font-weight: bold; text-align: center;">
                                    <div style="font-size: 1.2em; margin-bottom: 8px;">${color.name}</div>
                                    <div style="font-size: 0.9em; opacity: 0.9;">${color.brand} ${color.code}</div>
                                    <div style="font-size: 0.8em; margin-top: 8px; opacity: 0.8;">색상 프리뷰</div>
                                </div>
                                <div style="margin-top: 1rem; font-size: 0.8em; opacity: 0.8;">
                                    ${color.hex}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            resultsSection.appendChild(virtualTrySection);
            virtualTrySection.scrollIntoView({ behavior: 'smooth' });
        }

        console.log('HAIRGATOR Personal Color - 최종 수정 버전 로드 완료');
        console.log('HAIRGATOR Personal Color - 최종 수정 버전 로드 완료');
   </script>
    <script src="../js/gemini-hair-color.js"></script>
</body>
</html>
