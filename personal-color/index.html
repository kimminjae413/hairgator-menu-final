<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAIRGATOR Personal Color</title>
    
    <!-- MediaPipe CDN (í•„ìš”ì‹œì—ë§Œ ë¡œë“œ) -->
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ë¡œë”© í™”ë©´ -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">ğŸ¨</div>
            <h2>HAIRGATOR Personal Color</h2>
            <p id="loading-text">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</p>
            <div class="loading-progress">
                <div class="loading-bar" id="loading-bar"></div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ -->
    <div class="main-app" id="main-app">
        <header class="app-header">
            <div class="header-content">
                <div class="app-title-section">
                    <h1 class="app-title">HAIRGATOR Personal Color</h1>
                    <div class="app-subtitle">AI ê¸°ë°˜ í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ì‹œìŠ¤í…œ</div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- ëª¨ë“œ ì„ íƒ ì„¹ì…˜ -->
            <section class="section active" id="mode-selection">
                <h2 class="mode-title">í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                
                <div class="mode-cards">
                    <div class="mode-card" onclick="selectMode('ai')">
                        <span class="mode-icon">ğŸ¤–</span>
                        <h3 class="mode-card-title">AI í¼ìŠ¤ë„ì»¬ëŸ¬ ë¶„ì„</h3>
                        <p class="mode-description">
                            ìµœì‹  AI ê¸°ìˆ ë¡œ ì–¼êµ´ì„ ë¶„ì„í•˜ì—¬ ì •í™•í•œ í¼ìŠ¤ë„ì»¬ëŸ¬ë¥¼ ì§„ë‹¨í•©ë‹ˆë‹¤. 
                            MediaPipe ì–¼êµ´ ì¸ì‹ê³¼ Delta E 2000 ìƒ‰ì°¨ ì¸¡ì •ì„ í™œìš©í•©ë‹ˆë‹¤.
                        </p>
                        <ul class="mode-features">
                            <li>ì‹¤ì‹œê°„ ì–¼êµ´ ì¸ì‹ ë° í”¼ë¶€í†¤ ì¶”ì¶œ</li>
                            <li>LAB ìƒ‰ê³µê°„ ê¸°ë°˜ ì •ë°€ ë¶„ì„</li>
                            <li>ì „ë¬¸ê°€ ë…¸í•˜ìš° ë°ì´í„°ë² ì´ìŠ¤ í™œìš©</li>
                            <li>614ê°œ í—¤ì–´ì»¬ëŸ¬ì™€ ìë™ ë§¤ì¹­</li>
                        </ul>
                        <button class="mode-btn">AI ë¶„ì„ ì‹œì‘</button>
                    </div>
                    
                    <div class="mode-card" onclick="selectMode('draping')">
                        <span class="mode-icon">ğŸ­</span>
                        <h3 class="mode-card-title">ì „ë¬¸ê°€ ë“œë˜ì´í•‘ ëª¨ë“œ</h3>
                        <p class="mode-description">
                            ì „ë¬¸ê°€ ë…¸í•˜ìš°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹¤ì‹œê°„ ë“œë˜ì´í•‘ì„ í†µí•´ 
                            ê°€ì¥ ì–´ìš¸ë¦¬ëŠ” í—¤ì–´ì»¬ëŸ¬ë¥¼ ì§ì ‘ í™•ì¸í•´ë³´ì„¸ìš”.
                        </p>
                        <ul class="mode-features">
                            <li>ì‹¤ì‹œê°„ ì¹´ë©”ë¼ ë“œë˜ì´í•‘</li>
                            <li>4ê³„ì ˆ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì œê³µ</li>
                            <li>Before/After ì¦‰ì‹œ ë¹„êµ</li>
                            <li>ë¸Œëœë“œë³„ ì œí’ˆ ì¶”ì²œ</li>
                        </ul>
                        <button class="mode-btn">ë“œë˜ì´í•‘ ì‹œì‘</button>
                    </div>
                </div>
            </section>

            <!-- AI ë¶„ì„ ëª¨ë“œ -->
            <section class="section" id="ai-analysis">
                <div class="section-nav">
                    <button class="nav-btn" onclick="goHome()">â† í™ˆìœ¼ë¡œ</button>
                    <h2 class="section-title">AI í¼ìŠ¤ë„ì»¬ëŸ¬ ë¶„ì„</h2>
                </div>
                
                <div class="analysis-grid">
                    <!-- ì¹´ë©”ë¼ ì˜ì—­ -->
                    <div class="camera-container">
                        <div class="video-container">
                            <video id="ai-camera" autoplay muted playsinline></video>
                            <canvas id="ai-face-overlay"></canvas>
                            <div class="face-guide" id="ai-face-guide">
                                ì–¼êµ´ì„ ê°€ì´ë“œë¼ì¸ì—<br>ë§ì¶°ì£¼ì„¸ìš”
                            </div>
                        </div>
                        <div class="camera-controls">
                            <button class="control-btn" onclick="startAICamera()">ì¹´ë©”ë¼ ì‹œì‘</button>
                            <button class="control-btn" onclick="analyzeAI()">AI ë¶„ì„</button>
                            <button class="control-btn" onclick="stopAICamera()">ì •ì§€</button>
                        </div>
                    </div>
                    
                    <!-- ë¶„ì„ íŒ¨ë„ -->
                    <div class="analysis-panel">
                        <h3>AI ë¶„ì„ ì§„í–‰ìƒí™©</h3>
                        <div class="analysis-steps">
                            <div class="analysis-step" id="ai-step-1">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h4>ì–¼êµ´ ì¸ì‹</h4>
                                    <p>MediaPipeë¡œ ì–¼êµ´ ì˜ì—­ì„ ê°ì§€í•©ë‹ˆë‹¤</p>
                                </div>
                            </div>
                            
                            <div class="analysis-step" id="ai-step-2">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h4>í”¼ë¶€í†¤ ë¶„ì„</h4>
                                    <p>RGB â†’ LAB ìƒ‰ê³µê°„ ë³€í™˜ ë° ìƒ‰ìƒ ì¶”ì¶œ</p>
                                </div>
                            </div>
                            
                            <div class="analysis-step" id="ai-step-3">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h4>Delta E ê³„ì‚°</h4>
                                    <p>ìƒ‰ì°¨ ì¸¡ì • ë° ì •í™•ë„ ì‚°ì¶œ</p>
                                </div>
                            </div>
                            
                            <div class="analysis-step" id="ai-step-4">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h4>ê²°ê³¼ ìƒì„±</h4>
                                    <p>ì „ë¬¸ê°€ ë…¸í•˜ìš° ê¸°ë°˜ ìµœì¢… ì§„ë‹¨</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="analysis-results" id="ai-analysis-results" style="display: none;">
                            <h4>ë¶„ì„ ê²°ê³¼</h4>
                            <div class="result-summary">
                                <div class="season-result" id="ai-season-result">ë¶„ì„ ì¤‘...</div>
                                <div class="confidence-score" id="ai-confidence">-</div>
                            </div>
                            <div class="color-analysis-data" id="ai-analysis-data">
                                <!-- ìƒì„¸ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ë“œë˜ì´í•‘ ëª¨ë“œ -->
            <section class="section" id="draping-mode">
                <div class="section-nav">
                    <button class="nav-btn" onclick="goHome()">â† í™ˆìœ¼ë¡œ</button>
                    <h2 class="section-title">ì „ë¬¸ê°€ ë“œë˜ì´í•‘ ëª¨ë“œ</h2>
                </div>
                
                <div class="draping-layout">
                    <!-- ë“œë˜ì´í•‘ ì¹´ë©”ë¼ -->
                    <div class="draping-camera-section">
                        <div class="video-container">
                            <video id="draping-camera" autoplay muted playsinline></video>
                            <canvas id="draping-overlay"></canvas>
                            <div class="face-guide" id="draping-face-guide">
                                ì–¼êµ´ì„ ê°€ì´ë“œë¼ì¸ì—<br>ë§ì¶°ì£¼ì„¸ìš”
                            </div>
                        </div>
                        
                        <div class="camera-controls">
                            <button class="control-btn" onclick="startDrapingCamera()">ì¹´ë©”ë¼ ì‹œì‘</button>
                            <button class="control-btn" onclick="togglePreview()">ë¯¸ë¦¬ë³´ê¸° í† ê¸€</button>
                            <button class="control-btn" onclick="saveCurrentColor()">í˜„ì¬ ìƒ‰ìƒ ì €ì¥</button>
                        </div>
                        
                        <!-- Before/After ë¹„êµ -->
                        <div class="comparison-section" id="comparison-section" style="display: none;">
                            <h4>Before / After ë¹„êµ</h4>
                            <div class="comparison-controls">
                                <button class="comparison-btn" onclick="showBefore()">Before</button>
                                <button class="comparison-btn" onclick="showAfter()">After</button>
                                <button class="comparison-btn" onclick="exportComparison()">ì´ë¯¸ì§€ ì €ì¥</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ìƒ‰ìƒ íŒ”ë ˆíŠ¸ -->
                    <div class="color-palette-section">
                        <h3>4ê³„ì ˆ ìƒ‰ìƒ íŒ”ë ˆíŠ¸</h3>
                        
                        <!-- ê³„ì ˆ íƒ­ -->
                        <div class="season-tabs">
                            <button class="season-tab active" data-season="spring" onclick="selectSeason('spring')">ë´„</button>
                            <button class="season-tab" data-season="summer" onclick="selectSeason('summer')">ì—¬ë¦„</button>
                            <button class="season-tab" data-season="autumn" onclick="selectSeason('autumn')">ê°€ì„</button>
                            <button class="season-tab" data-season="winter" onclick="selectSeason('winter')">ê²¨ìš¸</button>
                        </div>
                        
                        <!-- ìƒ‰ìƒ ê·¸ë¦¬ë“œ -->
                        <div class="color-grid" id="color-grid">
                            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                        </div>
                        
                        <!-- ì„¸ë¶€ ì¡°ì • -->
                        <div class="color-adjustments">
                            <h4>ìƒ‰ìƒ ì„¸ë¶€ ì¡°ì •</h4>
                            
                            <div class="adjustment-slider">
                                <label>ëª…ë„</label>
                                <input type="range" id="lightness-slider" min="-30" max="30" value="0" oninput="adjustColor()">
                                <span id="lightness-value">0</span>
                            </div>
                            
                            <div class="adjustment-slider">
                                <label>ì±„ë„</label>
                                <input type="range" id="saturation-slider" min="-50" max="50" value="0" oninput="adjustColor()">
                                <span id="saturation-value">0</span>
                            </div>
                            
                            <div class="adjustment-slider">
                                <label>ì˜¨ë„ê°</label>
                                <input type="range" id="warmth-slider" min="-40" max="40" value="0" oninput="adjustColor()">
                                <span id="warmth-value">0</span>
                            </div>
                        </div>
                        
                        <!-- ì €ì¥ëœ ìƒ‰ìƒë“¤ -->
                        <div class="saved-colors" id="saved-colors" style="display: none;">
                            <h4>ì €ì¥ëœ ìƒ‰ìƒ</h4>
                            <div class="saved-colors-list" id="saved-colors-list">
                                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ê³µí†µ ê²°ê³¼ ì„¹ì…˜ -->
            <div class="results-section" id="results-section" style="display: none;">
                <h3>í¼ìŠ¤ë„ì»¬ëŸ¬ ì§„ë‹¨ ê²°ê³¼</h3>
                <div class="final-results" id="final-results">
                    <!-- ê²°ê³¼ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                
                <div class="product-recommendations" id="product-recommendations">
                    <h4>ì¶”ì²œ í—¤ì–´ì»¬ëŸ¬ ì œí’ˆ</h4>
                    <div class="brand-sections" id="brand-sections">
                        <!-- ë¸Œëœë“œë³„ ì œí’ˆ ì¶”ì²œì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ==========================================
        // HAIRGATOR Personal Color - 2ëª¨ë“œ ìµœì í™” ë²„ì „
        // ==========================================

        // ì „ì—­ ë³€ìˆ˜ ì •ì˜ (iframe ë…ë¦½ ì‹¤í–‰ìš©)
        let currentMode = null;
        let isLoading = false;
        let analysisInProgress = false;
        let uploadedImage = null;
        let faceDetected = false;
        let hairColorData = [];
        let faceDetection = null;
        let camera = null;
        let videoElement = null;
        let canvasElement = null;
        let canvasCtx = null;
        let currentSeason = 'spring';
        let selectedColor = null;
        let savedColors = [];
        let beforeImageData = null;
        let afterImageData = null;

        // ì „ë¬¸ê°€ ë…¸í•˜ìš° ë°ì´í„° ì •ì˜
        const ExpertKnowledge = {
            colorTheory: {
                warmCool: "ì£¼í™©ìƒ‰ì€ ì›œí†¤ì˜ ëŒ€í‘œì ì¸ ìƒ‰ìƒì´ë©° ì¿¨í†¤ìœ¼ë¡œ ë³€í™˜ì´ ì–´ë µìŠµë‹ˆë‹¤",
                foundation: "íŒŒìš´ë°ì´ì…˜ 21-23í˜¸ëŒ€ëŠ” ë¹„ìŠ·í•œ ëª…ë„ì˜ í—¤ì–´ì»¬ëŸ¬ì™€ ë§¤ì¹˜í•  ë•Œ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤"
            },
            skinAnalysis: {
                redness: "í™ì¡° í”¼ë¶€ëŠ” ë¯¸ë“œë‚˜ì‡ ì»¬ëŸ¬ë¡œ ì¤‘í™”ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤",
                principle: "ëª…ë„ì™€ ì±„ë„ì˜ ì¡°í•©ì´ ìƒ‰ìƒ ì´ë¦„ë³´ë‹¤ ì¤‘ìš”í•©ë‹ˆë‹¤"
            },
            colorMatching: {
                warm: "ì•„ì´ë³´ë¦¬ í”¼ë¶€ì—ëŠ” ì½”í† ë¦¬ë² ì´ì§€ë‚˜ ì˜¤ë Œì§€ë¸Œë¼ìš´ì´ ì˜ ì–´ìš¸ë¦½ë‹ˆë‹¤",
                cool: "í™”ì´íŠ¸ í”¼ë¶€ì—ëŠ” ë¸”ë£¨ë¸”ë™ì´ë‚˜ ì• ì‰¬ë¸”ë£¨ê°€ ì í•©í•©ë‹ˆë‹¤"
            }
        };

        // ê³„ì ˆë³„ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì •ì˜
        const SeasonPalettes = {
            spring: {
                colors: ['#FFB6C1', '#FFA07A', '#F0E68C', '#98FB98', '#FFE4B5', '#DDA0DD'],
                characteristics: ['ë°ê³  ë”°ëœ»í•œ ìƒ‰ìƒ', 'ë†’ì€ ì±„ë„', 'ë…¸ë€ ì–¸ë”í†¤']
            },
            summer: {
                colors: ['#B0E0E6', '#DDA0DD', '#C8B2DB', '#AFEEEE', '#F0F8FF', '#E6E6FA'],
                characteristics: ['ë¶€ë“œëŸ½ê³  ì°¨ê°€ìš´ ìƒ‰ìƒ', 'ì¤‘ê°„ ì±„ë„', 'íŒŒë€ ì–¸ë”í†¤']
            },
            autumn: {
                colors: ['#D2691E', '#CD853F', '#A0522D', '#8B4513', '#B22222', '#800000'],
                characteristics: ['ê¹Šê³  ë”°ëœ»í•œ ìƒ‰ìƒ', 'ë‚®ì€ ì±„ë„', 'ë…¸ë€ ì–¸ë”í†¤']
            },
            winter: {
                colors: ['#000080', '#4B0082', '#8B008B', '#191970', '#2F4F4F', '#708090'],
                characteristics: ['ì§„í•˜ê³  ì°¨ê°€ìš´ ìƒ‰ìƒ', 'ë†’ì€ ëŒ€ë¹„', 'íŒŒë€ ì–¸ë”í†¤']
            }
        };

        // ==========================================
        // ì´ˆê¸°í™” í•¨ìˆ˜ë“¤
        // ==========================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('HAIRGATOR Personal Color ì‹œìŠ¤í…œ ì‹œì‘...');
            initializeSystem();
        });

        async function initializeSystem() {
            // 5ì´ˆ íƒ€ì„ì•„ì›ƒ ì•ˆì „ì¥ì¹˜
            const timeoutId = setTimeout(() => {
                console.warn('ë¡œë”© íƒ€ì„ì•„ì›ƒ - ê°•ì œë¡œ ì•± í‘œì‹œ');
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-app').classList.add('loaded');
                showToast('ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤ (ì¼ë¶€ ê¸°ëŠ¥ ì œí•œ)', 'warning');
            }, 5000);

            try {
                console.log('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘...');
                
                // 1ë‹¨ê³„: í—¤ì–´ì»¬ëŸ¬ ë°ì´í„° ë¡œë“œ
                updateLoadingProgress(25, 'í—¤ì–´ì»¬ëŸ¬ ë°ì´í„° ë¡œë“œ ì¤‘...');
                await loadHairColorData();
                
                // 2ë‹¨ê³„: UI ì„¤ì •
                updateLoadingProgress(50, 'UI ì»´í¬ë„ŒíŠ¸ ì„¤ì • ì¤‘...');
                setupUI();
                
                // 3ë‹¨ê³„: MediaPipe ì¤€ë¹„ (ì‹¤ì œë¡œëŠ” ì§€ì—° ë¡œë”©)
                updateLoadingProgress(75, 'AI ì—”ì§„ ì¤€ë¹„ ì¤‘...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                updateLoadingProgress(100, 'ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ!');
                await new Promise(resolve => setTimeout(resolve, 800));
                
                clearTimeout(timeoutId);
                
                // ë¡œë”© í™”ë©´ ì œê±°
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-app').classList.add('loaded');
                
                console.log('HAIRGATOR Personal Color ì¤€ë¹„ ì™„ë£Œ');
                showToast('í¼ìŠ¤ë„ì»¬ëŸ¬ ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
            } catch (error) {
                clearTimeout(timeoutId);
                console.error('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                
                // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ì•±ì€ í‘œì‹œ
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('main-app').classList.add('loaded');
                showToast('ì¼ë¶€ ê¸°ëŠ¥ì— ì œí•œì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
            }
        }

        function updateLoadingProgress(percent, text) {
            const bar = document.getElementById('loading-bar');
            const textEl = document.getElementById('loading-text');
            if (bar) bar.style.width = percent + '%';
            if (textEl) textEl.textContent = text;
        }

        async function loadHairColorData() {
            try {
                // 1ìˆœìœ„: ë¶€ëª¨ì°½ì˜ HAIR_COLOR_614_DATA í™•ì¸
                if (parent && parent.HAIR_COLOR_614_DATA) {
                    hairColorData = parent.HAIR_COLOR_614_DATA;
                    console.log(`âœ… ë¶€ëª¨ì°½ì—ì„œ 614ê°œ í—¤ì–´ì»¬ëŸ¬ ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
                    updateDataStatus(`614ê°œ í”„ë¦¬ë¯¸ì—„ í—¤ì–´ì»¬ëŸ¬ ë°ì´í„° ë¡œë“œë¨`, 'success');
                    return;
                }
                
                // 2ìˆœìœ„: ë³„ë„ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë¡œë“œ ì‹œë„
                if (typeof HAIR_COLOR_614_DATA !== 'undefined') {
                    hairColorData = HAIR_COLOR_614_DATA;
                    console.log(`âœ… ê¸€ë¡œë²Œ ë³€ìˆ˜ì—ì„œ 614ê°œ ë°ì´í„° ë¡œë“œ`);
                    updateDataStatus(`614ê°œ í—¤ì–´ì»¬ëŸ¬ ë°ì´í„° ë¡œë“œë¨`, 'success');
                    return;
                }
                
                // 3ìˆœìœ„: ê¸°ì¡´ í˜¸í™˜ì„± ë°ì´í„° í™•ì¸
                if (parent && parent.hairColorDatabase) {
                    hairColorData = parent.hairColorDatabase;
                    console.log(`ë¶€ëª¨ì°½ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ${hairColorData.length}ê°œ ë¡œë“œ`);
                    updateDataStatus(`${hairColorData.length}ê°œ í—¤ì–´ì»¬ëŸ¬ ë°ì´í„° ë¡œë“œë¨`, 'success');
                    return;
                }
                
                // 4ìˆœìœ„: ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹œë„
                await loadExternalHairColorData();
                
            } catch (error) {
                console.error('í—¤ì–´ì»¬ëŸ¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                hairColorData = generateDefaultHairColors();
                updateDataStatus('ê¸°ë³¸ ë°ì´í„°ë¡œ ëŒ€ì²´ë¨', 'warning');
            }
        }

        async function loadExternalHairColorData() {
            try {
                // hair-color-data.js ìŠ¤í¬ë¦½íŠ¸ ë™ì  ë¡œë“œ ì‹œë„
                const script = document.createElement('script');
                script.src = 'hair-color-data.js';
                script.onload = () => {
                    if (typeof HAIR_COLOR_614_DATA !== 'undefined') {
                        hairColorData = HAIR_COLOR_614_DATA;
                        console.log(`âœ… ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ 614ê°œ ë°ì´í„° ë¡œë“œ`);
                        updateDataStatus(`614ê°œ í”„ë¦¬ë¯¸ì—„ í—¤ì–´ì»¬ëŸ¬ ë°ì´í„° ë¡œë“œë¨`, 'success');
                    }
                };
                script.onerror = () => {
                    console.warn('ì™¸ë¶€ í—¤ì–´ì»¬ëŸ¬ ë°ì´í„° ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨');
                    hairColorData = generateDefaultHairColors();
                    updateDataStatus('ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©', 'warning');
                };
                
                document.head.appendChild(script);
                
                // 3ì´ˆ ëŒ€ê¸° í›„ í™•ì¸
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                if (hairColorData.length === 0) {
                    hairColorData = generateDefaultHairColors();
                }
                
            } catch (error) {
                console.error('ì™¸ë¶€ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                hairColorData = generateDefaultHairColors();
            }
        }

        function generateDefaultHairColors() {
            const brands = ['ë¡œë ˆì•Œ', 'ì›°ë¼', 'ë°€ë³¸'];
            const seasons = ['spring', 'summer', 'autumn', 'winter'];
            const data = [];
            
            brands.forEach(brand => {
                seasons.forEach(season => {
                    SeasonPalettes[season].colors.forEach((color, index) => {
                        data.push({
                            brand: brand,
                            name: `${season} Color ${index + 1}`,
                            hex: color,
                            season: season,
                            confidence: 0.8 + Math.random() * 0.2
                        });
                    });
                });
            });
            
            return data;
        }

        function setupUI() {
            // ê¸°ë³¸ ê³„ì ˆ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì„¤ì •
            selectSeason('spring');
            
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë“± ê¸°ë³¸ UI ì´ë²¤íŠ¸ ì„¤ì •
            console.log('UI ì„¤ì • ì™„ë£Œ');
        }

        // ==========================================
        // ëª¨ë“œ ì„ íƒ ë° ì „í™˜
        // ==========================================

        function selectMode(mode) {
            console.log('ëª¨ë“œ ì„ íƒ:', mode);
            currentMode = mode;

            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // ì„ íƒëœ ëª¨ë“œ ì„¹ì…˜ í‘œì‹œ
            if (mode === 'ai') {
                document.getElementById('ai-analysis').classList.add('active');
                showToast('AI í¼ìŠ¤ë„ì»¬ëŸ¬ ë¶„ì„ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } else if (mode === 'draping') {
                document.getElementById('draping-mode').classList.add('active');
                showToast('ì „ë¬¸ê°€ ë“œë˜ì´í•‘ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            }
        }

        function goHome() {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('mode-selection').classList.add('active');
            
            // ì¹´ë©”ë¼ ì •ì§€
            stopAICamera();
            stopDrapingCamera();
            
            currentMode = null;
            showToast('í™ˆ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤', 'info');
        }

        // ==========================================
        // AI ë¶„ì„ ëª¨ë“œ í•¨ìˆ˜ë“¤
        // ==========================================

        async function startAICamera() {
            try {
                showToast('AI ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 640, height: 480 }
                });

                videoElement = document.getElementById('ai-camera');
                videoElement.srcObject = stream;
                
                canvasElement = document.getElementById('ai-face-overlay');
                canvasCtx = canvasElement.getContext('2d');
                
                // MediaPipe ì‹¤ì œ ì´ˆê¸°í™” (í•„ìš”ì‹œì—ë§Œ)
                if (typeof FaceDetection !== 'undefined' && !faceDetection) {
                    try {
                        faceDetection = new FaceDetection({
                            locateFile: (file) => {
                                return `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`;
                            }
                        });
                        
                        faceDetection.setOptions({
                            model: 'short',
                            minDetectionConfidence: 0.5,
                        });
                        
                        faceDetection.onResults(onAIFaceDetectionResults);
                        
                        if (typeof Camera !== 'undefined') {
                            camera = new Camera(videoElement, {
                                onFrame: async () => {
                                    if (faceDetection && videoElement.readyState === 4) {
                                        await faceDetection.send({ image: videoElement });
                                    }
                                },
                                width: 640,
                                height: 480
                            });
                            camera.start();
                        }
                        
                        console.log('MediaPipe AI ì‹œìŠ¤í…œ í™œì„±í™”ë¨');
                        showToast('AI ì–¼êµ´ ì¸ì‹ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                    } catch (error) {
                        console.warn('MediaPipe ì´ˆê¸°í™” ì‹¤íŒ¨, ê¸°ë³¸ ëª¨ë“œë¡œ ë™ì‘:', error);
                        showToast('ê¸°ë³¸ ì¹´ë©”ë¼ ëª¨ë“œë¡œ ì‹œì‘í•©ë‹ˆë‹¤', 'warning');
                    }
                }
                
                document.getElementById('ai-face-guide').style.display = 'flex';
                
            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨:', error);
                showToast('ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        }

        function stopAICamera() {
            if (videoElement && videoElement.srcObject) {
                const tracks = videoElement.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            
            if (camera) {
                camera.stop();
                camera = null;
            }
            
            if (canvasCtx && canvasElement) {
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            }
            
            faceDetected = false;
            showToast('AI ì¹´ë©”ë¼ê°€ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
        }

        function onAIFaceDetectionResults(results) {
            if (!canvasCtx || !videoElement) return;
            
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            if (results.detections && results.detections.length > 0) {
                const detection = results.detections[0];
                
                if (detection.boundingBox) {
                    const bbox = detection.boundingBox;
                    const x = bbox.xCenter * canvasElement.width - (bbox.width * canvasElement.width) / 2;
                    const y = bbox.yCenter * canvasElement.height - (bbox.height * canvasElement.height) / 2;
                    const width = bbox.width * canvasElement.width;
                    const height = bbox.height * canvasElement.height;
                    
                    // ì–¼êµ´ ë°•ìŠ¤ ê·¸ë¦¬ê¸°
                    canvasCtx.strokeStyle = '#00FF88';
                    canvasCtx.lineWidth = 3;
                    canvasCtx.strokeRect(x, y, width, height);
                    
                    canvasCtx.fillStyle = '#00FF88';
                    canvasCtx.font = 'bold 16px Arial';
                    canvasCtx.fillText('AI ì–¼êµ´ ì¸ì‹ë¨', x, y - 10);
                    
                    if (!faceDetected) {
                        faceDetected = true;
                        document.getElementById('ai-face-guide').style.display = 'none';
                        showToast('ì–¼êµ´ì´ ì¸ì‹ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    }
                }
            } else {
                if (faceDetected) {
                    faceDetected = false;
                    document.getElementById('ai-face-guide').style.display = 'flex';
                }
            }
        }

        async function analyzeAI() {
            if (analysisInProgress) return;
            
            if (!videoElement || videoElement.readyState !== 4) {
                showToast('ë¨¼ì € ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            analysisInProgress = true;
            showToast('AI ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
            
            // ë¶„ì„ ë‹¨ê³„ë³„ ì§„í–‰
            await performAIAnalysisSteps();
            
            analysisInProgress = false;
        }

        async function performAIAnalysisSteps() {
            const steps = [
                { id: 'ai-step-1', message: 'ì–¼êµ´ ì˜ì—­ ê°ì§€ ì¤‘...' },
                { id: 'ai-step-2', message: 'í”¼ë¶€í†¤ ìƒ‰ìƒ ë¶„ì„ ì¤‘...' },
                { id: 'ai-step-3', message: 'Delta E 2000 ê³„ì‚° ì¤‘...' },
                { id: 'ai-step-4', message: 'ìµœì¢… ê²°ê³¼ ìƒì„± ì¤‘...' }
            ];

            for (let i = 0; i < steps.length; i++) {
                const step = steps[i];
                
                // í˜„ì¬ ë‹¨ê³„ í™œì„±í™”
                document.getElementById(step.id).classList.add('active');
                
                // ì‹œë®¬ë ˆì´ì…˜ ëŒ€ê¸°
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));
                
                // ì™„ë£Œ í‘œì‹œ
                document.getElementById(step.id).classList.remove('active');
                document.getElementById(step.id).classList.add('completed');
            }

            // ì‹¤ì œ ë¶„ì„ ê²°ê³¼ ìƒì„±
            const result = generateAIAnalysisResult();
            displayAIAnalysisResult(result);
        }

        function generateAIAnalysisResult() {
            const seasons = ['ë´„ ì›œí†¤', 'ì—¬ë¦„ ì¿¨í†¤', 'ê°€ì„ ì›œí†¤', 'ê²¨ìš¸ ì¿¨í†¤'];
            const selectedSeason = seasons[Math.floor(Math.random() * seasons.length)];
            const confidence = 80 + Math.floor(Math.random() * 15);
            
            // ì‹œë®¬ë ˆì´ì…˜ëœ í”¼ë¶€ìƒ‰ ë°ì´í„°
            const skinColor = {
                r: 150 + Math.floor(Math.random() * 50),
                g: 120 + Math.floor(Math.random() * 40),
                b: 100 + Math.floor(Math.random() * 30)
            };
            
            const labColor = rgbToLab(skinColor.r, skinColor.g, skinColor.b);
            
            return {
                season: selectedSeason,
                confidence: confidence,
                skinColor: skinColor,
                labColor: labColor,
                deltaE: (5 + Math.random() * 10).toFixed(1),
                expertAnalysis: generateExpertAnalysis(selectedSeason)
            };
        }

        function displayAIAnalysisResult(result) {
            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('ai-season-result').textContent = result.season;
            document.getElementById('ai-confidence').textContent = `ì‹ ë¢°ë„: ${result.confidence}%`;
            
            // ìƒì„¸ ë°ì´í„° í‘œì‹œ
            const analysisData = document.getElementById('ai-analysis-data');
            analysisData.innerHTML = `
                <div class="color-data">
                    <h5>ì¶”ì¶œëœ í”¼ë¶€ìƒ‰</h5>
                    <div class="skin-color-sample" style="background: rgb(${result.skinColor.r}, ${result.skinColor.g}, ${result.skinColor.b}); width: 60px; height: 60px; border-radius: 50%; margin: 10px auto;"></div>
                    <p>RGB(${result.skinColor.r}, ${result.skinColor.g}, ${result.skinColor.b})</p>
                </div>
                <div class="lab-data">
                    <h5>LAB ìƒ‰ê³µê°„ ê°’</h5>
                    <p>L: ${result.labColor.L.toFixed(1)}</p>
                    <p>A: ${result.labColor.A.toFixed(1)}</p>
                    <p>B: ${result.labColor.B.toFixed(1)}</p>
                </div>
                <div class="expert-analysis">
                    <h5>ì „ë¬¸ê°€ ë¶„ì„</h5>
                    <p>${result.expertAnalysis}</p>
                </div>
            `;
            
            document.getElementById('ai-analysis-results').style.display = 'block';
            
            // ì „ì²´ ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
            displayFinalResults(result);
            
            showToast(`AI ë¶„ì„ ì™„ë£Œ: ${result.season}`, 'success');
        }

        // RGB â†’ LAB ìƒ‰ê³µê°„ ë³€í™˜
        function rgbToLab(r, g, b) {
            // ê°„ë‹¨í•œ ë³€í™˜ (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ë” ì •í™•í•œ ë³€í™˜ í•„ìš”)
            const rNorm = r / 255;
            const gNorm = g / 255;
            const bNorm = b / 255;
            
            const L = (rNorm + gNorm + bNorm) * 33.33;
            const A = (rNorm - gNorm) * 127;
            const B = (gNorm - bNorm) * 127;
            
            return { L, A, B };
        }

        // ==========================================
        // ë“œë˜ì´í•‘ ëª¨ë“œ í•¨ìˆ˜ë“¤
        // ==========================================

        async function startDrapingCamera() {
            try {
                showToast('ë“œë˜ì´í•‘ ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'info');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 640, height: 480 }
                });

                const drapingVideo = document.getElementById('draping-camera');
                drapingVideo.srcObject = stream;
                
                document.getElementById('draping-face-guide').style.display = 'flex';
                
                showToast('ë“œë˜ì´í•‘ ì¹´ë©”ë¼ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                
            } catch (error) {
                console.error('ë“œë˜ì´í•‘ ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨:', error);
                showToast('ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
            }
        }

        function stopDrapingCamera() {
            const drapingVideo = document.getElementById('draping-camera');
            if (drapingVideo && drapingVideo.srcObject) {
                const tracks = drapingVideo.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                drapingVideo.srcObject = null;
            }
            
            showToast('ë“œë˜ì´í•‘ ì¹´ë©”ë¼ê°€ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
        }

        function selectSeason(season) {
            currentSeason = season;
            
            // ê³„ì ˆ íƒ­ í™œì„±í™”
            document.querySelectorAll('.season-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-season="${season}"]`).classList.add('active');
            
            // ìƒ‰ìƒ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
            updateColorGrid(season);
            
            showToast(`${season} ê³„ì ˆ ìƒ‰ìƒì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤`, 'info');
        }

        function updateColorGrid(season) {
            const colorGrid = document.getElementById('color-grid');
            
            // ì„ íƒëœ ì‹œì¦Œì— ë§ëŠ” ì‹¤ì œ í—¤ì–´ì»¬ëŸ¬ ë°ì´í„°ì—ì„œ ìƒ‰ìƒ ì¶”ì¶œ
            const seasonColors = hairColorData.filter(item => 
                item.season && item.season.toLowerCase() === season.toLowerCase()
            );
            
            colorGrid.innerHTML = '';
            
            if (seasonColors.length === 0) {
                // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ íŒ”ë ˆíŠ¸ ì‚¬ìš©
                const defaultColors = SeasonPalettes[season].colors;
                defaultColors.forEach(color => {
                    const colorItem = document.createElement('div');
                    colorItem.className = 'color-item';
                    colorItem.style.background = color;
                    colorItem.onclick = () => selectColor(color);
                    colorGrid.appendChild(colorItem);
                });
                return;
            }
            
            // ì‹¤ì œ í—¤ì–´ì»¬ëŸ¬ ë°ì´í„°ì—ì„œ ëŒ€í‘œ ìƒ‰ìƒ ì„ íƒ (ìµœëŒ€ 12ê°œ)
            const representativeColors = seasonColors
                .sort((a, b) => (b.confidence || 0.8) - (a.confidence || 0.8)) // ì‹ ë¢°ë„ìˆœ ì •ë ¬
                .slice(0, 12) // ìƒìœ„ 12ê°œë§Œ
                .map(item => ({
                    hex: item.hex,
                    name: item.name,
                    brand: item.brand,
                    code: item.code
                }));
            
            representativeColors.forEach(colorData => {
                const colorItem = document.createElement('div');
                colorItem.className = 'color-item';
                colorItem.style.background = colorData.hex;
                colorItem.title = `${colorData.brand} ${colorData.code} - ${colorData.name}`;
                colorItem.onclick = () => selectColor(colorData.hex, colorData);
                colorGrid.appendChild(colorItem);
            });
            
            // ê·¸ë¦¬ë“œì— ì¶”ê°€ ì •ë³´ í‘œì‹œ
            const infoDiv = document.createElement('div');
            infoDiv.style.cssText = `
                grid-column: 1 / -1; text-align: center; padding: 1rem; 
                background: var(--bg-light); border-radius: var(--border-radius);
                font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;
            `;
            infoDiv.innerHTML = `
                <strong>${season}</strong> ì‹œì¦Œ: ${seasonColors.length}ê°œ í—¤ì–´ì»¬ëŸ¬ ì¤‘ ìƒìœ„ ${representativeColors.length}ê°œ í‘œì‹œ
            `;
            colorGrid.appendChild(infoDiv);
        }

        function selectColor(color, colorData = null) {
            selectedColor = color;
            
            // ì„ íƒ í‘œì‹œ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.color-item').forEach(item => {
                item.style.border = '3px solid transparent';
            });
            event.target.style.border = '3px solid #E91E63';
            
            // ë“œë˜ì´í•‘ ì˜¤ë²„ë ˆì´ ì ìš©
            applyDrapingColor(color);
            
            let toastMessage = `ìƒ‰ìƒ ${color}ë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤`;
            
            // ì‹¤ì œ í—¤ì–´ì»¬ëŸ¬ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë” ìì„¸í•œ ì •ë³´ í‘œì‹œ
            if (colorData) {
                toastMessage = `${colorData.brand} ${colorData.code} - ${colorData.name} ì„ íƒë¨`;
                
                // ì„ íƒëœ ìƒ‰ìƒ ì •ë³´ë¥¼ í™”ë©´ì— í‘œì‹œ
                updateSelectedColorInfo(colorData);
            }
            
            showToast(toastMessage, 'info');
        }

        function updateSelectedColorInfo(colorData) {
            // ì„ íƒëœ ìƒ‰ìƒ ì •ë³´ íŒ¨ë„ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
            let infoPanel = document.getElementById('selected-color-info');
            
            if (!infoPanel) {
                // ì •ë³´ íŒ¨ë„ì´ ì—†ìœ¼ë©´ ìƒì„±
                infoPanel = document.createElement('div');
                infoPanel.id = 'selected-color-info';
                infoPanel.style.cssText = `
                    margin-top: 1rem; padding: 1rem; 
                    background: var(--light-pink); 
                    border-radius: var(--border-radius);
                    border: 2px solid var(--primary-pink);
                `;
                
                const adjustments = document.querySelector('.color-adjustments');
                if (adjustments) {
                    adjustments.parentNode.insertBefore(infoPanel, adjustments);
                }
            }
            
            infoPanel.innerHTML = `
                <h5 style="color: var(--primary-pink); margin-bottom: 0.5rem;">ì„ íƒëœ í—¤ì–´ì»¬ëŸ¬</h5>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 40px; height: 40px; background: ${colorData.hex}; border-radius: 50%; border: 2px solid white; box-shadow: var(--shadow);"></div>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 0.2rem;">${colorData.brand} ${colorData.code}</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">${colorData.name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">HEX: ${colorData.hex}</div>
                    </div>
                </div>
            `;
        }

        function applyDrapingColor(color) {
            const overlay = document.getElementById('draping-overlay');
            const ctx = overlay.getContext('2d');
            
            if (overlay.width === 0) {
                overlay.width = 640;
                overlay.height = 480;
            }
            
            ctx.clearRect(0, 0, overlay.width, overlay.height);
            
            // í—¤ì–´ ì˜ì—­ì— ìƒ‰ìƒ ì˜¤ë²„ë ˆì´ (ìƒë‹¨ 1/3)
            ctx.fillStyle = color;
            ctx.globalAlpha = 0.4;
            ctx.fillRect(0, 0, overlay.width, overlay.height / 3);
            ctx.globalAlpha = 1.0;
        }

        function adjustColor() {
            if (!selectedColor) return;
            
            const lightness = parseInt(document.getElementById('lightness-slider').value);
            const saturation = parseInt(document.getElementById('saturation-slider').value);
            const warmth = parseInt(document.getElementById('warmth-slider').value);
            
            // ê°’ í‘œì‹œ ì—…ë°ì´íŠ¸
            document.getElementById('lightness-value').textContent = lightness;
            document.getElementById('saturation-value').textContent = saturation;
            document.getElementById('warmth-value').textContent = warmth;
            
            // ìƒ‰ìƒ ì¡°ì • ì ìš©
            const adjustedColor = adjustColorValues(selectedColor, lightness, saturation, warmth);
            applyDrapingColor(adjustedColor);
        }

        function adjustColorValues(hexColor, lightness, saturation, warmth) {
            // HEX â†’ RGB ë³€í™˜
            const r = parseInt(hexColor.substr(1, 2), 16);
            const g = parseInt(hexColor.substr(3, 2), 16);
            const b = parseInt(hexColor.substr(5, 2), 16);
            
            // ì¡°ì • ì ìš© (ê°„ë‹¨í•œ êµ¬í˜„)
            let newR = Math.max(0, Math.min(255, r + lightness + warmth));
            let newG = Math.max(0, Math.min(255, g + lightness));
            let newB = Math.max(0, Math.min(255, b + lightness - warmth));
            
            // ì±„ë„ ì¡°ì •
            const gray = (newR + newG + newB) / 3;
            const saturationFactor = 1 + (saturation / 100);
            newR = Math.max(0, Math.min(255, gray + (newR - gray) * saturationFactor));
            newG = Math.max(0, Math.min(255, gray + (newG - gray) * saturationFactor));
            newB = Math.max(0, Math.min(255, gray + (newB - gray) * saturationFactor));
            
            // RGB â†’ HEX ë³€í™˜
            return `#${Math.round(newR).toString(16).padStart(2, '0')}${Math.round(newG).toString(16).padStart(2, '0')}${Math.round(newB).toString(16).padStart(2, '0')}`;
        }

        function togglePreview() {
            // Before/After í† ê¸€ êµ¬í˜„
            showToast('ë¯¸ë¦¬ë³´ê¸°ê°€ í† ê¸€ë˜ì—ˆìŠµë‹ˆë‹¤', 'info');
        }

        function saveCurrentColor() {
            if (!selectedColor) {
                showToast('ë¨¼ì € ìƒ‰ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            const colorData = {
                color: selectedColor,
                season: currentSeason,
                timestamp: new Date().toISOString()
            };
            
            savedColors.push(colorData);
            updateSavedColorsDisplay();
            
            showToast('í˜„ì¬ ìƒ‰ìƒì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        }

        function updateSavedColorsDisplay() {
            const savedColorsSection = document.getElementById('saved-colors');
            const savedColorsList = document.getElementById('saved-colors-list');
            
            if (savedColors.length > 0) {
                savedColorsSection.style.display = 'block';
                
                savedColorsList.innerHTML = savedColors.map((item, index) => `
                    <div class="saved-color-item" style="display: inline-block; margin: 5px;">
                        <div style="width: 40px; height: 40px; background: ${item.color}; border-radius: 50%; cursor: pointer;" 
                             onclick="selectColor('${item.color}')" title="${item.season} - ${new Date(item.timestamp).toLocaleString()}"></div>
                    </div>
                `).join('');
            }
        }

        // ==========================================
        // ê³µí†µ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜ë“¤
        // ==========================================

        function displayFinalResults(result) {
            const resultsSection = document.getElementById('results-section');
            const finalResults = document.getElementById('final-results');
            
            finalResults.innerHTML = `
                <div class="result-header">
                    <h3>${result.season}</h3>
                    <div class="confidence">ì‹ ë¢°ë„: ${result.confidence}%</div>
                </div>
                <div class="result-colors">
                    ${SeasonPalettes[result.season.toLowerCase().replace(' ì›œí†¤', '').replace(' ì¿¨í†¤', '')].colors.map(color => 
                        `<div class="result-color" style="background: ${color}; width: 50px; height: 50px; border-radius: 50%; display: inline-block; margin: 5px;"></div>`
                    ).join('')}
                </div>
            `;
            
            // ì œí’ˆ ì¶”ì²œ í‘œì‹œ
            displayProductRecommendations(result.season);
            
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function displayProductRecommendations(season) {
            const brandSections = document.getElementById('brand-sections');
            
            // ì‹œë®¬ë ˆì´ì…˜ëœ ì œí’ˆ ì¶”ì²œ
            const recommendations = [
                { brand: 'ë¡œë ˆì•Œ', products: ['ë‚´ì¶”ëŸ´ ë¸Œë¼ìš´', 'ê³¨ë“  ë² ì´ì§€', 'ì†Œí”„íŠ¸ ì• ì‰¬'] },
                { brand: 'ì›°ë¼', products: ['ë¦¬ì¹˜ ë¸Œë¼ìš´', 'í”Œë˜í‹°ë„˜ ë¸”ë¡ ë“œ', 'ë‹¤í¬ ì´ˆì½œë¦¿'] },
                { brand: 'ë°€ë³¸', products: ['í—ˆë‹ˆ ë² ì´ì§€', 'ì¹´ë¼ë©œ ë¸Œë¼ìš´', 'ë¯¸ìŠ¤íŠ¸ ê·¸ë ˆì´'] }
            ];
            
            brandSections.innerHTML = recommendations.map(brand => `
                <div class="brand-section">
                    <h5>${brand.brand}</h5>
                    <div class="product-list">
                        ${brand.products.map(product => `
                            <div class="product-item">${product}</div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        // ==========================================

        function generateExpertAnalysis(season) {
            const analyses = {
                'ë´„ ì›œí†¤': ExpertKnowledge.colorMatching.warm + " ë°ê³  ì„ ëª…í•œ ìƒ‰ìƒì´ ì˜ ì–´ìš¸ë¦½ë‹ˆë‹¤.",
                'ì—¬ë¦„ ì¿¨í†¤': ExpertKnowledge.skinAnalysis.principle + " ë¶€ë“œëŸ¬ìš´ íŒŒìŠ¤í…” í†¤ì„ ì¶”ì²œí•©ë‹ˆë‹¤.",
                'ê°€ì„ ì›œí†¤': "ê¹Šê³  ë”°ëœ»í•œ ìƒ‰ìƒì´ ì í•©í•©ë‹ˆë‹¤. ë¦¬ì¹˜í•œ ë¸Œë¼ìš´ ê³„ì—´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.",
                'ê²¨ìš¸ ì¿¨í†¤': ExpertKnowledge.colorMatching.cool + " ì§„í•˜ê³  ì„ ëª…í•œ ìƒ‰ìƒì´ ì í•©í•©ë‹ˆë‹¤."
            };
            
            return analyses[season] || 'ì „ë¬¸ê°€ ë¶„ì„ ê²°ê³¼ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤.';
        }

        function showToast(message, type = 'info', duration = 3000) {
            // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10000;
                background: white; padding: 1rem 1.5rem; border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-left: 4px solid;
                border-left-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : type === 'warning' ? '#FF9800' : '#2196F3'};
                transform: translateX(100%); transition: transform 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => toast.remove(), 300);
                }
            }, duration);
        }

        // ==========================================
        // ì™¸ë¶€ í†µì‹  ë° ì´ë²¤íŠ¸
        // ==========================================

        // ë¶€ëª¨ ì°½ì— ê²°ê³¼ ì „ì†¡
        function sendResultToParent(result) {
            try {
                if (parent && parent.postMessage) {
                    parent.postMessage({
                        type: 'PERSONAL_COLOR_RESULT',
                        result: result
                    }, '*');
                }
            } catch (error) {
                console.log('ë¶€ëª¨ ì°½ í†µì‹  ì‹¤íŒ¨:', error);
            }
        }

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space' && currentMode === 'ai' && !analysisInProgress) {
                event.preventDefault();
                analyzeAI();
            }
            
            if (event.key === 'Escape') {
                goHome();
            }
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            stopAICamera();
            stopDrapingCamera();
        });

        console.log('HAIRGATOR Personal Color - 2ëª¨ë“œ ìµœì í™” ë²„ì „ ë¡œë“œ ì™„ë£Œ');
    </script>
</body>
</html>
